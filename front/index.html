<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mini-bilibili</title>
    <style>
      :root {
        font-family: "Inter", "PingFang SC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #1d1d1f;
        background-color: #f6f7fb;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px;
        display: flex;
        justify-content: center;
      }
      main {
        width: min(960px, 100%);
        background: #fff;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 10px 40px rgba(15, 23, 42, 0.08);
      }
      header {
        margin-bottom: 24px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 1.75rem;
      }
      p {
        margin: 0;
        color: #52525b;
      }
      .status {
        margin-top: 16px;
        font-size: 0.95rem;
        color: #2563eb;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
        font-size: 0.95rem;
      }
      thead {
        position: sticky;
        top: 0;
        background: #f1f5f9;
        z-index: 1;
      }
      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        vertical-align: top;
      }
      th {
        font-weight: 600;
        color: #0f172a;
        letter-spacing: 0.02em;
      }
      tbody tr:nth-child(odd) {
        background-color: #fafbff;
      }
      tbody tr:hover {
        background-color: #e2f2ff;
      }
      a {
        color: #2563eb;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .scroll-wrap {
        overflow-x: auto;
        border-radius: 12px;
      }
      .filters {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
      }
      .filter-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
      }
      .filter-field span {
        font-size: 0.85rem;
        color: #475569;
      }
      .chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        border: 1px solid #d0d7e8;
        background: #fff;
        color: #0f172a;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 14px;
        line-height: 17px;
        width: 75px;
        height: 34px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .chip:hover {
        border-color: #93c5fd;
        color: #2563eb;
      }
      .chip--active {
        background: #2563eb;
        border-color: #2563eb;
        color: #fff;
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.25);
      }
      input[type="number"] {
        border: 1px solid #d0d7e8;
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 0.95rem;
        background: #f8fbff;
        color: #0f172a;
      }
      @media (max-width: 640px) {
        main {
          padding: 20px;
        }
        table {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>mini-bilibili</h1>
        <p>自动读取并展示 B 站视频列表，数据来自 video_ls.csv，直接在浏览器中打开即可筛选。</p>
        <div class="status" id="status">正在加载数据...</div>
        <div class="filters">
          <div class="filter-field">
            <span>视频类型</span>
            <div class="chip-group" id="category-group"></div>
          </div>
          <label class="filter-field">
            <span>单作者视频条数</span>
            <input type="number" id="limit-input" min="1" max="50" value="1" />
          </label>
        </div>
      </header>
      <div class="scroll-wrap">
        <table>
          <thead>
            <tr id="table-head"></tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
    </main>
    <script>
      const statusEl = document.getElementById("status");
      const headRow = document.getElementById("table-head");
      const bodyEl = document.getElementById("table-body");
      const categoryGroup = document.getElementById("category-group");
      const limitInput = document.getElementById("limit-input");

      const CATEGORY_OPTIONS = ["全部", "超优质", "历史区", "创意区", "运动区", "游戏区", "影视综", "数分"];
      const DEFAULT_CATEGORY = "超优质";
      const DEFAULT_LIMIT = 1;
      const MAX_LIMIT = 50;

      let records = [];
      let activeCategory = CATEGORY_OPTIONS.includes(DEFAULT_CATEGORY) ? DEFAULT_CATEGORY : CATEGORY_OPTIONS[0];

      const fallbackHeader = (text, index) => {
        if (text && text.trim()) return text.trim();
        return index === 0 ? "id" : `col_${index}`;
      };

      const parseCSV = (text) => {
        const rows = [];
        let current = "";
        let row = [];
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const char = text[i];
          const next = text[i + 1];

          if (char === "\r" && next === "\n" && !inQuotes) {
            continue;
          }

          if (char === "\n" && !inQuotes) {
            row.push(current);
            rows.push(row);
            row = [];
            current = "";
            continue;
          }

          if (char === '"') {
            if (inQuotes && next === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
            continue;
          }

          if (char === "," && !inQuotes) {
            row.push(current);
            current = "";
            continue;
          }

          current += char;
        }

        if (current.length > 0 || row.length) {
          row.push(current);
          rows.push(row);
        }

        return rows.filter((cells) => cells.some((cell) => cell.trim().length));
      };

      const normalizeKey = (text) => text.trim().toLowerCase();

      const createCell = (tag, text, linkHref = "") => {
        const cell = document.createElement(tag);
        if (linkHref && text) {
          const link = document.createElement("a");
          link.href = linkHref;
          link.target = "_blank";
          link.rel = "noopener";
          link.textContent = text;
          cell.appendChild(link);
        } else {
          cell.textContent = text || "";
        }
        return cell;
      };

      const ensureLimitValue = () => {
        let value = parseInt(limitInput.value, 10);
        if (Number.isNaN(value) || value < 1) {
          value = DEFAULT_LIMIT;
        }
        value = Math.min(value, MAX_LIMIT);
        limitInput.value = value;
        return value;
      };

      const renderCategoryChips = () => {
        categoryGroup.innerHTML = "";
        CATEGORY_OPTIONS.forEach((label) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = `chip${label === activeCategory ? " chip--active" : ""}`;
          chip.textContent = label;
          chip.addEventListener("click", () => {
            if (activeCategory === label) return;
            activeCategory = label;
            renderCategoryChips();
            applyFilters();
          });
          categoryGroup.appendChild(chip);
        });
      };

      const buildRecords = (rows) => {
        if (!rows.length) return [];
        const headers = rows[0].map(fallbackHeader).map(normalizeKey);
        return rows.slice(1).map((row) => {
          const record = {};
          headers.forEach((key, idx) => {
            record[key] = (row[idx] || "").trim();
          });
          return record;
        });
      };

      const renderHeader = () => {
        headRow.innerHTML = "";
        ["作者", "视频发布时间", "视频名称"].forEach((text) => {
          headRow.appendChild(createCell("th", text));
        });
      };

      const renderBody = (rows) => {
        bodyEl.innerHTML = "";
        if (!rows.length) {
          const tr = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.textContent = "暂无数据";
          tr.appendChild(cell);
          bodyEl.appendChild(tr);
          return;
        }

        rows.forEach((item) => {
          const tr = document.createElement("tr");
          tr.appendChild(createCell("td", item.author || "-"));
          tr.appendChild(createCell("td", item.publish_date || "-"));
          tr.appendChild(createCell("td", item.title || "", item.url || ""));
          bodyEl.appendChild(tr);
        });
      };

      const applyFilters = () => {
        if (!records.length) {
          renderBody([]);
          statusEl.textContent = "暂无数据";
          return;
        }

        const limit = ensureLimitValue();
        const authorCounts = new Map();
        const authorSet = new Set();
        const rows = [];

        records.forEach((record) => {
          const category = record.category || record["category"] || "";
          if (!record.author || !record.title) return;
          if (activeCategory !== "全部" && category !== activeCategory) return;

          const used = authorCounts.get(record.author) || 0;
          if (used >= limit) return;

          authorCounts.set(record.author, used + 1);
          authorSet.add(record.author);
          rows.push(record);
        });

        renderBody(rows);

        if (rows.length) {
          statusEl.textContent = `筛选：${activeCategory} · 作者 ${authorSet.size} 位，共 ${rows.length} 条（每位最多 ${limit} 条）`;
        } else {
          statusEl.textContent = "暂无匹配数据";
        }
      };

      limitInput.addEventListener("input", () => {
        ensureLimitValue();
        applyFilters();
      });

      const loadCSV = async () => {
        statusEl.textContent = "正在加载数据...";
        try {
          const response = await fetch("../video_ls.csv", { cache: "no-cache" });
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const text = await response.text();
          const rows = parseCSV(text);
          if (!rows.length) {
            statusEl.textContent = "CSV 文件为空";
            records = [];
            renderBody([]);
            return;
          }
          records = buildRecords(rows);
          applyFilters();
        } catch (error) {
          console.error(error);
          statusEl.textContent = "加载失败，请确认 CSV 文件路径正确";
          records = [];
          renderBody([]);
        }
      };

      renderCategoryChips();
      ensureLimitValue();
      renderHeader();
      renderBody([]);
      loadCSV();
    </script>
  </body>
</html>
