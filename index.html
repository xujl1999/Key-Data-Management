<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Key-Data-Management</title>
    <style>
      :root {
        font-family: "Inter", "PingFang SC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #f8fafc;
        background-color: #020617;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at top, rgba(37, 99, 235, 0.15), transparent 60%) #020617;
      }
      main {
        width: min(960px, 100%);
        background: #0f172a;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 30px 80px rgba(2, 8, 23, 0.85);
      }
      header {
        margin-bottom: 24px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 1.75rem;
      }
      p {
        margin: 0;
        color: #cbd5f5;
      }
      .status {
        margin-top: 16px;
        font-size: 0.95rem;
        color: #60a5fa;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
        font-size: 0.95rem;
      }
      thead {
        position: sticky;
        top: 0;
        background: rgba(30, 41, 59, 0.85);
        z-index: 1;
      }
      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(99, 102, 241, 0.35);
        text-align: left;
        vertical-align: top;
      }
      th {
        font-weight: 600;
        color: #e2e8f0;
        letter-spacing: 0.02em;
      }
      tbody tr:nth-child(odd) {
        background-color: rgba(15, 23, 42, 0.7);
      }
      tbody tr:hover {
        background-color: rgba(37, 99, 235, 0.25);
      }
      a {
        color: #93c5fd;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .scroll-wrap {
        overflow-x: auto;
        border-radius: 12px;
      }
      .filters {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
      }
      .filter-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
      }
      .filter-field span {
        font-size: 0.85rem;
        color: #475569;
      }
      .chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: transparent;
        color: #e2e8f0;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 14px;
        line-height: 17px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: 34px;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .chip:hover {
        border-color: #93c5fd;
        color: #93c5fd;
      }
      .chip--active {
        background: #1d4ed8;
        border-color: #1d4ed8;
        color: #fff;
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
      }
      input[type="number"],
      select {
        border: 1px solid rgba(148, 163, 184, 0.6);
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 0.95rem;
        background: #1f2937;
        color: #e2e8f0;
      }
      .tab-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }
      .tab-button {
        border: 1px solid transparent;
        background: rgba(255, 255, 255, 0.05);
        color: #cbd5f5;
        padding: 10px 18px;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .tab-button--active {
        background: #2563eb;
        border-color: #93c5fd;
        color: #fff;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
      }
      .tab-panel {
        display: none;
      }
      .tab-panel--active {
        display: block;
      }
      .plan-block {
        margin: 12px 0 20px;
        padding: 16px 18px;
        border-radius: 12px;
        background: rgba(99, 102, 241, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: #e2e8f0;
      }
      .plan-title {
        margin: 0 0 8px;
        font-weight: 700;
        font-size: 1.05rem;
      }
      .plan-section {
        margin: 6px 0;
      }
      .plan-section strong {
        color: #a5b4fc;
      }
      .plan-list {
        margin: 4px 0 0 14px;
        color: #cbd5f5;
        padding: 0;
        list-style-type: disc;
      }
      .note-heading {
        margin: 0 0 6px;
        font-weight: 600;
        color: #cbd5f5;
      }
      .note-divider {
        border: 0;
        height: 1px;
        margin: 12px 0;
        background: rgba(148, 163, 184, 0.35);
      }
      .table-note {
        margin: 6px 0 12px;
        color: #94a3b8;
        font-size: 0.92rem;
      }
      .delta-pos {
        color: #34d399;
        font-weight: 600;
      }
      .delta-neg {
        color: #f87171;
        font-weight: 600;
      }
      .metric-link {
        cursor: pointer;
        color: #93c5fd;
        font-weight: 600;
      }
      .metric-link:hover {
        text-decoration: underline;
      }
      .highlight-label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      #health-highlight .plan-list li {
        line-height: 1.7;
      }
      .info-badge {
        position: relative;
        top: 0;
        right: 0;
        margin-left: 2px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
        color: #93c5fd;
        font-size: 11px;
        line-height: 14px;
        font-weight: 700;
        cursor: pointer;
        padding: 0;
      }
      .info-badge:hover {
        border-color: #93c5fd;
        color: #e2e8f0;
      }
      .metric-thumb-empty {
        color: #94a3b8;
        font-size: 0.85rem;
      }
      .modal-title {
        margin: 2px 0 12px;
        font-weight: 700;
        color: #e2e8f0;
      }
      .modal-chart {
        display: none;
        width: min(920px, 82vw);
      }
      .modal-content .modal-image {
        display: none;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
        padding: 20px;
      }
      .modal--open {
        display: flex;
      }
      .modal-content {
        background: #0f172a;
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 12px;
        padding: 12px;
        max-width: 90vw;
        max-height: 90vh;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }
      .modal-text {
        color: #cbd5f5;
        line-height: 1.6;
        max-width: 720px;
      }
      .modal-content img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
      }
      .modal-close {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(255, 255, 255, 0.05);
        color: #e2e8f0;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        margin-bottom: 8px;
      }
      @media (max-width: 640px) {
        main {
          padding: 20px;
        }
        table {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header style="margin-bottom: 16px;">
        <h1>Key-Data-Management</h1>
      </header>
      <div class="tab-bar">
        <button class="tab-button tab-button--active" data-tab="health">健康</button>
        <button class="tab-button" data-tab="entertainment">娱乐</button>
        <button class="tab-button" data-tab="knowledge">知识库</button>
        <button class="tab-button" data-tab="wealth">财富</button>
      </div>
      <section class="tab-panel tab-panel--active" id="tab-health">
        <div id="health-status" class="status">正在加载健康数据...</div>
        <div class="plan-block" id="health-highlight">
          <p class="plan-title" style="margin: 0 0 6px;">Highlight</p>
          <div class="plan-section">
                        <ul class="plan-list">
              <li>近7天<span class="metric-link" data-metric-label="体重">体重</span>为<span id="hl-weight">--</span>（<span id="hl-weight-wow">—</span>）、<span class="metric-link" data-metric-label="体脂率">体脂率</span><span id="hl-bodyfat">--</span>（<span id="hl-bodyfat-wow">—</span>）。记得你要减肥到70kg</li>
              <li>近7日<span class="highlight-label"><span class="metric-link" data-metric-label="睡眠时长">睡眠时长</span><button class="info-badge" id="sleep-info-trigger" type="button" aria-label="睡眠时长说明">?</button></span>为<span id="hl-sleep">--</span>（<span id="hl-sleep-wow">—</span>）、<span class="metric-link" data-metric-label="入睡时间">入睡时间</span><span id="hl-bedtime">--</span>（<span id="hl-bedtime-wow">—</span>）、<span class="metric-link" data-metric-label="起床时间">起床时间</span><span id="hl-wake">--</span>（<span id="hl-wake-wow">—</span>）。记得你要早睡早起睡够8小时</li>
              <li>近7天<span class="metric-link" data-metric-label="HRV-SDNN均值">HRV</span>为<span id="hl-hrv">--</span>（<span id="hl-hrv-wow">—</span>），记得开心～～</li>
            </ul>
          </div>
          <p class="plan-title" style="margin: 12px 0 6px;">迭代方向</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>待破解：例行化获取苹果健康方法</li>
              <li>待接入：苹果健康其他指标、分部位健身频率、运动状态数据、动态血糖仪数据</li>
              <li>每日饮食成分分析</li>
              <li>待规划：可视化形态更简洁，有动作指导 —— 后续尝试大模型 API</li>
            </ul>
          </div>
        </div>
        <div class="filters" style="margin-top: 10px;">
          <div class="filter-field">
            <span>指标分类</span>
            <div class="chip-group" id="health-category-group"></div>
          </div>
        </div>
        <div class="scroll-wrap" style="margin-top: 10px;">
          <table>
            <thead>
              <tr>
                <th>指标名</th>
                <th>周日均</th>
                <th>周环比</th>
                <th>月环比</th>
                <th>年同比</th>
                
              </tr>
            </thead>
            <tbody id="health-metric-body">
              <tr><td colspan="5">正在计算...</td></tr>
            </tbody>
          </table>
        </div>
      </section>
      <section class="tab-panel" id="tab-entertainment">
      <div class="plan-block">
        <p class="plan-title" style="margin: 0 0 6px;">Highlight</p>
        <div class="plan-section">
          <ul class="plan-list">
            <li>每日自动拉取优质博主的更新，避开推荐流对精力的消耗。</li>
          </ul>
        </div>
        <p class="plan-title" style="margin: 12px 0 6px;">迭代方向</p>
        <div class="plan-section">
          <ul class="plan-list">
            <li>接入：王者荣耀自动化战绩分析，每日英雄梯度分析，强势英雄推荐</li>
            <li>接入：原神自动化任务完成情况</li>
          </ul>
        </div>
      </div>
      <header>
        <p>更新时间：<span id="update-time" style="margin-left: 8px; font-size: 0.9rem;"></span></p>
        <div class="status" id="status">正在加载数据...</div>
        <div class="filters">
          <div class="filter-field">
            <span>视频类型</span>
            <div class="chip-group" id="category-group"></div>
          </div>
          <label class="filter-field">
            <span>单作者视频条数</span>
            <select id="limit-input"></select>
          </label>
        </div>
      </header>
      <div class="scroll-wrap">
        <table>
          <thead>
            <tr id="table-head"></tr>
          </thead>
          <tbody id="table-body"></tbody>
        </table>
      </div>
      </section>
      <section class="tab-panel" id="tab-knowledge">
        <div class="plan-block">
          <p class="plan-title" style="margin: 0 0 6px;">笔记</p>
          <div class="plan-section">
            <p class="note-heading">读《道德经》有感：</p>
            <ul class="plan-list">
              <li>“天下万物生于有，有生于无。”<br />—&gt; 这个站点的意义在于，用最少的精力获得最重要的信息，让思维恢复到“无”的状态，恢复灵感。</li>
            </ul>
            <hr class="note-divider" />
            <p class="note-heading">看 罗永浩对 Minimax 闫俊杰访谈有感：</p>
            <ul class="plan-list">
              <li>“合作不顺的根本上是组织不顺。” —&gt; AI Agent 的组织形式是影响效率的核心原因。</li>
              <li>“公司组织不一定是按照岗位划分的，也可以按照角色画像进行划分。”<br />—&gt; 如果把不同的 AI 赋予“工程师”、“架构师”、“产品经理”的身份并划定职责，容易产生幻觉与遗忘。<br />是否应该尝试赋予 AI 不同的性格画像？比如：较真的 AI；善于发现问题的 AI；善于管理的 AI；善于向人类汇报的 AI；善于总结沉淀的 AI；善于运用第一性原理拆解分析问题的 AI</li>
            </ul>
          </div>
          <p class="plan-title" style="margin: 12px 0 6px;">迭代方向</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>分析中：微信读书笔记接口</li>
              <li>待规划：大模型理解并总结笔记、播客、优质视频</li>
            </ul>
          </div>
        </div>
        <p>知识库敬请期待。</p>
      </section>
      <section class="tab-panel" id="tab-wealth">
        <div class="plan-block">
          <p class="plan-title" style="margin: 0 0 6px;">迭代方向</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>当前财产配置</li>
              <li>理财产品收益监控</li>
              <li>距离买车买房目标的达成时间估算</li>
              <li>日消费监控</li>
            </ul>
          </div>
        </div>
        <p>更多数据接入与可视化待规划。</p>
      </section>
    </main>
    <script>
      const statusEl = document.getElementById("status");
      const updateTimeEl = document.getElementById("update-time");
      const headRow = document.getElementById("table-head");
      const bodyEl = document.getElementById("table-body");
      const categoryGroup = document.getElementById("category-group");
      const limitInput = document.getElementById("limit-input");
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabPanels = document.querySelectorAll(".tab-panel");
      const healthStatus = document.getElementById("health-status");
      const metricTableBody = document.getElementById("health-metric-body");
      const healthCategoryGroup = document.getElementById("health-category-group");
      const highlightEls = {
        weight: document.getElementById("hl-weight"),
        weightWow: document.getElementById("hl-weight-wow"),
        bodyFat: document.getElementById("hl-bodyfat"),
        bodyFatWow: document.getElementById("hl-bodyfat-wow"),
        sleep: document.getElementById("hl-sleep"),
        sleepWow: document.getElementById("hl-sleep-wow"),
        bedTime: document.getElementById("hl-bedtime"),
        bedTimeWow: document.getElementById("hl-bedtime-wow"),
        wakeTime: document.getElementById("hl-wake"),
        wakeTimeWow: document.getElementById("hl-wake-wow"),
        hrv: document.getElementById("hl-hrv"),
        hrvWow: document.getElementById("hl-hrv-wow"),
      };

      const CATEGORY_OPTIONS = ["全部", "超优质", "历史区", "创意区", "运动区", "游戏区", "影视综", "数分"];
      const DEFAULT_CATEGORY = "超优质";
      const DEFAULT_LIMIT = 1;
      const MAX_LIMIT = 10;
      const CSV_SOURCES = [{ url: "video/video_ls.csv", label: "Local" }];
      const HEALTH_SOURCES = [{ url: "health/sleep_daily.csv", label: "Local" }];
      const WEIGHT_SOURCES = [{ url: "health/weight_daily.csv", label: "Local" }];
      const STEPS_SOURCES = [{ url: "health/steps_daily.csv", label: "Local" }];
      const ENERGY_SOURCES = [{ url: "health/energy_daily.csv", label: "Local" }];
      const DIET_SOURCES = [
        { url: "health/diet_daily.csv", label: "Local" },
      ];
      const HR_SOURCES = [
        { url: "health/heart_rate_daily.csv", label: "Local" },
      ];
      const REST_HR_SOURCES = [
        { url: "health/resting_hr_daily.csv", label: "Local" },
      ];
      const WALK_HR_SOURCES = [
        { url: "health/walking_hr_daily.csv", label: "Local" },
      ];
      const RESP_SOURCES = [
        { url: "health/respiratory_daily.csv", label: "Local" },
      ];
      const VO2_SOURCES = [
        { url: "health/vo2max_daily.csv", label: "Local" },
      ];
      const WALK_METRIC_SOURCES = [
        { url: "health/walking_metrics_daily.csv", label: "Local" },
      ];
      const WALK_STEP_LEN_SOURCES = [
        { url: "health/walking_step_length_daily.csv", label: "Local" },
      ];
      const WALK_DS_SOURCES = [
        { url: "health/walking_double_support_daily.csv", label: "Local" },
      ];
      const WALK_ASYM_SOURCES = [
        { url: "health/walking_asymmetry_daily.csv", label: "Local" },
      ];
      const WALK_STEADY_SOURCES = [
        { url: "health/walking_steadiness_daily.csv", label: "Local" },
      ];
      const RUN_SPEED_SOURCES = [
        { url: "health/running_speed_daily.csv", label: "Local" },
      ];
      const RUN_POWER_SOURCES = [
        { url: "health/running_power_daily.csv", label: "Local" },
      ];
      const RUN_VERT_SOURCES = [
        { url: "health/running_vertical_osc_daily.csv", label: "Local" },
      ];
      const RUN_GC_SOURCES = [
        { url: "health/running_ground_contact_daily.csv", label: "Local" },
      ];
      const RUN_STRIDE_SOURCES = [
        { url: "health/running_stride_length_daily.csv", label: "Local" },
      ];
      const STAIR_ASC_SOURCES = [
        { url: "health/stair_ascent_speed_daily.csv", label: "Local" },
      ];
      const STAIR_DESC_SOURCES = [
        { url: "health/stair_descent_speed_daily.csv", label: "Local" },
      ];
      const AUDIO_ENV_SOURCES = [
        { url: "health/audio_exposure_daily.csv", label: "Local" },
      ];
      const AUDIO_HEAD_SOURCES = [
        { url: "health/headphone_audio_daily.csv", label: "Local" },
      ];
      const EXERCISE_SOURCES = [
        { url: "health/exercise_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/exercise_daily.csv", label: "GitHub Raw" },
      ];
      const DISTANCE_SOURCES = [
        { url: "health/distance_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/distance_daily.csv", label: "GitHub Raw" },
      ];
      const RESTING_HR_SOURCES = [
        { url: "health/resting_hr_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/resting_hr_daily.csv", label: "GitHub Raw" },
      ];
      const BODY_SOURCES = [
        { url: "health/body_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/body_daily.csv", label: "GitHub Raw" },
      ];
      const HEART_RATE_SOURCES = [
        { url: "health/heart_rate_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/heart_rate_daily.csv", label: "GitHub Raw" },
      ];
      const HRV_SOURCES = [
        { url: "health/hrv_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/hrv_daily.csv", label: "GitHub Raw" },
      ];
      const RESPIRATORY_SOURCES = [
        { url: "health/respiratory_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/respiratory_daily.csv", label: "GitHub Raw" },
      ];
      const SPO2_SOURCES = [
        { url: "health/spo2_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/spo2_daily.csv", label: "GitHub Raw" },
      ];
      const VO2MAX_SOURCES = [
        { url: "health/vo2max_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/vo2max_daily.csv", label: "GitHub Raw" },
      ];
      const FLIGHTS_SOURCES = [
        { url: "health/flights_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/flights_daily.csv", label: "GitHub Raw" },
      ];
      const DAYLIGHT_SOURCES = [
        { url: "health/daylight_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/daylight_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_HR_SOURCES = [
        { url: "health/walking_hr_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/walking_hr_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_METRICS_SOURCES = [
        { url: "health/walking_metrics_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/walking_metrics_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_STEP_LENGTH_SOURCES = [
        { url: "health/walking_step_length_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/walking_step_length_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_DOUBLE_SUPPORT_SOURCES = [
        { url: "health/walking_double_support_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/walking_double_support_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_ASYMMETRY_SOURCES = [
        { url: "health/walking_asymmetry_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/walking_asymmetry_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_STEADINESS_SOURCES = [
        { url: "health/walking_steadiness_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/walking_steadiness_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_SPEED_SOURCES = [
        { url: "health/running_speed_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/running_speed_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_POWER_SOURCES = [
        { url: "health/running_power_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/running_power_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_STRIDE_LENGTH_SOURCES = [
        { url: "health/running_stride_length_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/running_stride_length_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_VERTICAL_OSC_SOURCES = [
        { url: "health/running_vertical_osc_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/running_vertical_osc_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_GROUND_CONTACT_SOURCES = [
        { url: "health/running_ground_contact_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/running_ground_contact_daily.csv", label: "GitHub Raw" },
      ];
      const STAIR_ASCENT_SPEED_SOURCES = [
        { url: "health/stair_ascent_speed_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/stair_ascent_speed_daily.csv", label: "GitHub Raw" },
      ];
      const STAIR_DESCENT_SPEED_SOURCES = [
        { url: "health/stair_descent_speed_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/stair_descent_speed_daily.csv", label: "GitHub Raw" },
      ];
      const AUDIO_EXPOSURE_SOURCES = [
        { url: "health/audio_exposure_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/audio_exposure_daily.csv", label: "GitHub Raw" },
      ];
      const HEADPHONE_AUDIO_SOURCES = [
        { url: "health/headphone_audio_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/headphone_audio_daily.csv", label: "GitHub Raw" },
      ];
      const SLEEP_TEMP_SOURCES = [
        { url: "health/sleep_temp_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/sleep_temp_daily.csv", label: "GitHub Raw" },
      ];
      const SLEEP_SCHEDULE_SOURCES = [
        { url: "health/sleep_schedule_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/sleep_schedule_daily.csv", label: "GitHub Raw" },
      ];
      const DISTANCE_CYCLING_SOURCES = [
        { url: "health/distance_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/distance_daily.csv", label: "GitHub Raw" },
      ];

      const METRIC_DEFS = [
        { label: "睡眠时长", valueKey: "sleep_hours", unit: "小时", sources: HEALTH_SOURCES },
        { label: "体重", valueKey: "weight_kg", unit: "kg", sources: WEIGHT_SOURCES },
        { label: "步数", valueKey: "steps", unit: "步", sources: STEPS_SOURCES },
        { label: "主动能量", valueKey: "active_energy", unit: "kcal", sources: ENERGY_SOURCES },
        { label: "基础代谢", valueKey: "basal_energy", unit: "kcal", sources: ENERGY_SOURCES },
        { label: "身体负荷指数", valueKey: "physical_effort", unit: "AU", sources: ENERGY_SOURCES },
        { label: "锻炼时长", valueKey: "exercise_time_min", unit: "分钟", sources: EXERCISE_SOURCES },
        { label: "站立时长", valueKey: "stand_time_min", unit: "分钟", sources: EXERCISE_SOURCES },
        { label: "站立小时数", valueKey: "stand_hours", unit: "小时", sources: EXERCISE_SOURCES },
        { label: "步行跑步距离", valueKey: "distance_walk_run_km", unit: "km", sources: DISTANCE_SOURCES },
        { label: "骑行距离", valueKey: "distance_cycling_km", unit: "km", sources: DISTANCE_CYCLING_SOURCES },
        { label: "爬楼层数", valueKey: "flights_climbed", unit: "层", sources: FLIGHTS_SOURCES },
        { label: "户外日照时长", valueKey: "time_in_daylight_min", unit: "分钟", sources: DAYLIGHT_SOURCES },
        { label: "静息心率", valueKey: "resting_hr_avg", unit: "bpm", sources: RESTING_HR_SOURCES },
        { label: "心率均值", valueKey: "hr_avg", unit: "bpm", sources: HEART_RATE_SOURCES },
        { label: "心率最小值", valueKey: "hr_min", unit: "bpm", sources: HEART_RATE_SOURCES },
        { label: "心率最大值", valueKey: "hr_max", unit: "bpm", sources: HEART_RATE_SOURCES },
        { label: "步行心率均值", valueKey: "walk_hr_avg", unit: "bpm", sources: WALKING_HR_SOURCES },
        { label: "HRV-SDNN均值", valueKey: "sdnn_avg", unit: "ms", sources: HRV_SOURCES },
        { label: "呼吸频率均值", valueKey: "resp_avg", unit: "次/分", sources: RESPIRATORY_SOURCES },
        { label: "血氧均值", valueKey: "spo2_avg", unit: "%", sources: SPO2_SOURCES },
        { label: "最大摄氧量均值", valueKey: "vo2max_avg", unit: "ml·kg⁻¹·min⁻¹", sources: VO2MAX_SOURCES },
        { label: "BMI", valueKey: "bmi", unit: "", sources: BODY_SOURCES },
        { label: "体脂率", valueKey: "body_fat_pct", unit: "%", sources: BODY_SOURCES },
        { label: "去脂体重", valueKey: "lean_mass_kg", unit: "kg", sources: BODY_SOURCES },
        { label: "行走速度均值", valueKey: "walking_speed_avg", unit: "m/s", sources: WALKING_METRICS_SOURCES },
        { label: "步长均值", valueKey: "step_length_avg", unit: "cm", sources: WALKING_STEP_LENGTH_SOURCES },
        { label: "双支撑占比均值", valueKey: "double_support_pct_avg", unit: "%", sources: WALKING_DOUBLE_SUPPORT_SOURCES },
        { label: "步态不对称均值", valueKey: "asymmetry_pct_avg", unit: "%", sources: WALKING_ASYMMETRY_SOURCES },
        { label: "步态稳定度均值", valueKey: "steady_avg", unit: "分", sources: WALKING_STEADINESS_SOURCES },
        { label: "跑步速度均值", valueKey: "running_speed_avg", unit: "m/s", sources: RUNNING_SPEED_SOURCES },
        { label: "跑步功率均值", valueKey: "running_power_avg", unit: "W", sources: RUNNING_POWER_SOURCES },
        { label: "跑步步幅均值", valueKey: "running_stride_len_avg", unit: "m", sources: RUNNING_STRIDE_LENGTH_SOURCES },
        { label: "跑步垂直振幅均值", valueKey: "running_vertical_osc_avg", unit: "cm", sources: RUNNING_VERTICAL_OSC_SOURCES },
        { label: "着地时间均值", valueKey: "ground_contact_ms_avg", unit: "ms", sources: RUNNING_GROUND_CONTACT_SOURCES },
        { label: "上楼速度均值", valueKey: "stair_ascent_speed_avg", unit: "m/s", sources: STAIR_ASCENT_SPEED_SOURCES },
        { label: "下楼速度均值", valueKey: "stair_descent_speed_avg", unit: "m/s", sources: STAIR_DESCENT_SPEED_SOURCES },
        { label: "环境噪声均值", valueKey: "env_audio_avg", unit: "dB", sources: AUDIO_EXPOSURE_SOURCES },
        { label: "耳机音量均值", valueKey: "headphone_audio_avg", unit: "dB", sources: HEADPHONE_AUDIO_SOURCES },
        { label: "睡眠手腕温度均值", valueKey: "temp_avg", unit: "°C", sources: SLEEP_TEMP_SOURCES },
      ];

      const HIGHLIGHT_EXTRA_DEFS = [
        { label: "入睡时间", valueKey: "bed_time", unit: "", sources: SLEEP_SCHEDULE_SOURCES },
        { label: "起床时间", valueKey: "wake_time", unit: "", sources: SLEEP_SCHEDULE_SOURCES },
      ];

      const HEALTH_METRIC_CONFIG_SOURCES = [
        { url: "health/metric_config.json", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/metric_config.json", label: "GitHub Raw" },
      ];

      const DEFAULT_HEALTH_METRIC_CATEGORY = "基础体征";
      let healthMetricDefs = METRIC_DEFS.slice();
      let healthMetricCategories = ["全部"];
      let activeHealthMetricCategory = DEFAULT_HEALTH_METRIC_CATEGORY;
      let metricRows = [];

      let records = [];
      let activeCategory = CATEGORY_OPTIONS.includes(DEFAULT_CATEGORY) ? DEFAULT_CATEGORY : CATEGORY_OPTIONS[0];

      const fallbackHeader = (text, index) => {
        if (text && text.trim()) return text.trim();
        return index === 0 ? "id" : `col_${index}`;
      };

      const parseCSV = (text) => {
        const rows = [];
        let current = "";
        let row = [];
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const char = text[i];
          const next = text[i + 1];

          if (char === "\r" && next === "\n" && !inQuotes) {
            continue;
          }

          if (char === "\n" && !inQuotes) {
            row.push(current);
            rows.push(row);
            row = [];
            current = "";
            continue;
          }

          if (char === '"') {
            if (inQuotes && next === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
            continue;
          }

          if (char === "," && !inQuotes) {
            row.push(current);
            current = "";
            continue;
          }

          current += char;
        }

        if (current.length > 0 || row.length) {
          row.push(current);
          rows.push(row);
        }

        return rows.filter((cells) => cells.some((cell) => cell.trim().length));
      };

      const normalizeKey = (text) => text.trim().toLowerCase();

      const parseDate = (text) => {
        const d = new Date(text);
        return Number.isNaN(d.getTime()) ? null : d;
      };

      const createCell = (tag, text, linkHref = "") => {
        const cell = document.createElement(tag);
        if (linkHref && text) {
          const link = document.createElement("a");
          link.href = linkHref;
          link.target = "_blank";
          link.rel = "noopener";
          link.textContent = text;
          cell.appendChild(link);
        } else {
          cell.textContent = text || "";
        }
        return cell;
      };

      const parsePublishDate = (text) => {
        if (!text) return 0;
        const now = new Date();
        const cleaned = text.trim();
        if (!cleaned) return 0;

        const normalized = cleaned.replace(/\./g, "-");
        const direct = Date.parse(normalized);
        if (!Number.isNaN(direct)) {
          return direct;
        }

        const mmddPattern = /^(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{2}))?$/;
        const mmddMatch = cleaned.match(mmddPattern);
        if (mmddMatch) {
          const year = now.getFullYear();
          const month = parseInt(mmddMatch[1], 10) - 1;
          const day = parseInt(mmddMatch[2], 10);
          const hour = mmddMatch[3] ? parseInt(mmddMatch[3], 10) : 0;
          const minute = mmddMatch[4] ? parseInt(mmddMatch[4], 10) : 0;
          const guessed = new Date(year, month, day, hour, minute);
          if (guessed > now) {
            guessed.setFullYear(year - 1);
          }
          return guessed.getTime();
        }

        const relHour = cleaned.match(/^(\d+)\s*小时前$/);
        if (relHour) {
          const diff = parseInt(relHour[1], 10);
          const d = new Date(now);
          d.setHours(d.getHours() - diff);
          return d.getTime();
        }

        const relMinute = cleaned.match(/^(\d+)\s*分钟前$/);
        if (relMinute) {
          const diff = parseInt(relMinute[1], 10);
          const d = new Date(now);
          d.setMinutes(d.getMinutes() - diff);
          return d.getTime();
        }

        const yesterdayMatch = cleaned.match(/^昨天(?:\s+(\d{1,2}):(\d{2}))?$/);
        if (yesterdayMatch) {
          const d = new Date(now);
          d.setDate(d.getDate() - 1);
          const hour = yesterdayMatch[1] ? parseInt(yesterdayMatch[1], 10) : 0;
          const minute = yesterdayMatch[2] ? parseInt(yesterdayMatch[2], 10) : 0;
          d.setHours(hour, minute, 0, 0);
          return d.getTime();
        }

        const todayTime = cleaned.match(/^(\d{1,2}):(\d{2})$/);
        if (todayTime) {
          const d = new Date(now);
          d.setHours(parseInt(todayTime[1], 10), parseInt(todayTime[2], 10), 0, 0);
          return d.getTime();
        }

        if (cleaned === "刚刚") {
          return now.getTime();
        }

        return 0;
      };

      const ensureLimitValue = () => {
        let value = parseInt(limitInput.value, 10);
        if (Number.isNaN(value) || value < 1) {
          value = DEFAULT_LIMIT;
        }
        value = Math.min(value, MAX_LIMIT);
        limitInput.value = value;
        return value;
      };

      const initLimitSelect = () => {
        limitInput.innerHTML = "";
        for (let i = 1; i <= MAX_LIMIT; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          if (i === DEFAULT_LIMIT) {
            option.selected = true;
          }
          limitInput.appendChild(option);
        }
      };

      const switchTab = (target) => {
        tabButtons.forEach((button) => {
          button.classList.toggle("tab-button--active", button.dataset.tab === target);
        });
        tabPanels.forEach((panel) => {
          panel.classList.toggle("tab-panel--active", panel.id === `tab-${target}`);
        });
      };

      const renderLineChart = (container, data, options = {}) => {
        container.innerHTML = "";
        if (!data.length) {
          container.textContent = "暂无数据";
          return;
        }
        const width = options.width || 800;
        const height = options.height || 280;
        const padding = 30;

        const xs = data.map((_, idx) => idx);
        const ys = data.map((d) => d.value);
        const minY = Math.min(...ys, 0);
        const maxY = Math.max(...ys, 1);
        const yRange = maxY - minY || 1;

        const scaleX = (x) =>
          padding + (x / Math.max(xs.length - 1, 1)) * (width - padding * 2);
        const scaleY = (y) =>
          height - padding - ((y - minY) / yRange) * (height - padding * 2);

        const points = data.map((d, idx) => `${scaleX(idx)},${scaleY(d.value)}`).join(" ");

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "320");

        // Axes (minimal)
        const axis = document.createElementNS("http://www.w3.org/2000/svg", "line");
        axis.setAttribute("x1", padding);
        axis.setAttribute("y1", scaleY(minY));
        axis.setAttribute("x2", width - padding);
        axis.setAttribute("y2", scaleY(minY));
        axis.setAttribute("stroke", "rgba(148,163,184,0.4)");
        axis.setAttribute("stroke-width", "1");
        svg.appendChild(axis);

        const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        polyline.setAttribute("points", points);
        polyline.setAttribute("fill", "none");
        polyline.setAttribute("stroke", options.color || "#60a5fa");
        polyline.setAttribute("stroke-width", "2");
        svg.appendChild(polyline);

        // Labels (first/last)
        const addLabel = (text, x, y) => {
          const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
          t.setAttribute("x", x);
          t.setAttribute("y", y);
          t.setAttribute("fill", "#cbd5f5");
          t.setAttribute("font-size", "12");
          t.textContent = text;
          svg.appendChild(t);
        };

        if (data.length) {
          addLabel(data[0].label, scaleX(0), height - padding + 14);
          addLabel(data[data.length - 1].label, scaleX(data.length - 1) - 20, height - padding + 14);
          addLabel(maxY.toFixed(1), padding, scaleY(maxY) - 6);
          addLabel(minY.toFixed(1), padding, scaleY(minY) + 14);
        }

        container.appendChild(svg);
      };

      const renderCategoryChips = () => {
        categoryGroup.innerHTML = "";
        CATEGORY_OPTIONS.forEach((label) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = `chip${label === activeCategory ? " chip--active" : ""}`;
          chip.textContent = label;
          chip.addEventListener("click", () => {
            if (activeCategory === label) return;
            activeCategory = label;
            renderCategoryChips();
            applyFilters();
          });
          categoryGroup.appendChild(chip);
        });
      };

      const buildRecords = (rows) => {
        if (!rows.length) return [];
        const headers = rows[0].map(fallbackHeader).map(normalizeKey);
        return rows.slice(1).map((row) => {
          const record = {};
          headers.forEach((key, idx) => {
            record[key] = (row[idx] || "").trim();
          });
          record._timestamp = parsePublishDate(record.publish_date || record["publish_date"]);
          return record;
        });
      };

      const renderHeader = () => {
        headRow.innerHTML = "";
        ["作者", "视频发布时间", "视频名称"].forEach((text) => {
          headRow.appendChild(createCell("th", text));
        });
      };

      const renderBody = (rows) => {
        bodyEl.innerHTML = "";
        if (!rows.length) {
          const tr = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.textContent = "暂无数据";
          tr.appendChild(cell);
          bodyEl.appendChild(tr);
          return;
        }

        rows.forEach((item) => {
          const tr = document.createElement("tr");
          tr.appendChild(createCell("td", item.author || "-"));
          tr.appendChild(createCell("td", item.publish_date || "-"));
          tr.appendChild(createCell("td", item.title || "", item.url || ""));
          bodyEl.appendChild(tr);
        });
      };

      const applyFilters = () => {
        if (!records.length) {
          renderBody([]);
          statusEl.textContent = "暂无数据";
          return;
        }

        const limit = ensureLimitValue();
        const authorCounts = new Map();
        const authorSet = new Set();
        const rows = [];

        records.forEach((record) => {
          const category = record.category || record["category"] || "";
          if (!record.author || !record.title) return;
          if (activeCategory !== "全部" && category !== activeCategory) return;

          const used = authorCounts.get(record.author) || 0;
          if (used >= limit) return;

          authorCounts.set(record.author, used + 1);
          authorSet.add(record.author);
          rows.push(record);
        });

        rows.sort((a, b) => (b._timestamp || 0) - (a._timestamp || 0));

        renderBody(rows);

        if (rows.length) {
          statusEl.textContent = `筛选：${activeCategory} · 作者 ${authorSet.size} 位，共 ${rows.length} 条（每位最多 ${limit} 条）`;
        } else {
          statusEl.textContent = "暂无匹配数据";
        }
      };

      limitInput.addEventListener("change", () => {
        ensureLimitValue();
        applyFilters();
      });

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => switchTab(button.dataset.tab));
      });

      const formatUpdateTime = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return ` ${year}-${month}-${day} ${hours}:${minutes}`;
      };

      const isSameOrigin = (url) => {
        try {
          const absolute = new URL(url, window.location.href);
          return absolute.origin === window.location.origin;
        } catch (error) {
          console.warn("Invalid URL for origin check", url, error);
          return false;
        }
      };

      const resolveLastModified = async (response, url) => {
        const headerValue = response.headers.get("Last-Modified");
        if (headerValue) {
          const parsed = new Date(headerValue);
          if (!Number.isNaN(parsed.getTime())) {
            return parsed;
          }
        }
        if (!isSameOrigin(url)) {
          return null;
        }
        try {
          const headResp = await fetch(url, { method: "HEAD", cache: "no-store" });
          if (headResp.ok) {
            const headValue = headResp.headers.get("Last-Modified");
            if (headValue) {
              const fallback = new Date(headValue);
              if (!Number.isNaN(fallback.getTime())) {
                return fallback;
              }
            }
          }
        } catch (error) {
          console.warn("HEAD request failed", error);
        }
        return null;
      };


      const avgWindow = (series, count, offset = 0) => {
        if (series.length < count + offset) return null;
        const slice = series.slice(series.length - count - offset, series.length - offset);
        const total = slice.reduce((acc, cur) => acc + cur.ma, 0);
        return total / slice.length;
      };

      const formatDelta = (current, previous) => {
        if (current === null || previous === null || previous === 0) return { text: "—", cls: "" };
        const delta = ((current - previous) / previous) * 100;
        const cls = delta > 0 ? "positive" : delta < 0 ? "negative" : "";
        const sign = delta > 0 ? "+" : "";
        return { text: `${sign}${delta.toFixed(1)}%`, cls };
      };

      const fetchFromSources = async (sourceList) => {
        const errors = [];
        for (const source of sourceList) {
          try {
            const response = await fetch(source.url, { cache: "no-store" });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const text = await response.text();
            return { text, sourceLabel: source.label };
          } catch (error) {
            errors.push(`${source.label}: ${error.message}`);
          }
        }
        throw new Error(errors.join(" | "));
      };

      const fetchJsonFromSources = async (sourceList) => {
        const { text, sourceLabel } = await fetchFromSources(sourceList);
        try {
          return JSON.parse(text);
        } catch (error) {
          throw new Error(`${sourceLabel}: JSON 解析失败`);
        }
      };

      const uniqueList = (list) => Array.from(new Set(list.filter(Boolean)));

      const applyHealthMetricConfig = (config) => {
        const configMetrics = Array.isArray(config?.metrics) ? config.metrics : [];
        const configMap = new Map();
        configMetrics.forEach((item) => {
          if (!item || !item.valueKey) return;
          const key = String(item.valueKey).trim();
          if (key) configMap.set(key, item);
        });

        const defs = METRIC_DEFS.map((def) => {
          const item = configMap.get(def.valueKey);
          return {
            ...def,
            category: item && item.category ? item.category : "未分类",
            enabled: item ? item.enabled !== false : true,
          };
        });

        const categories =
          Array.isArray(config?.categories) && config.categories.length
            ? config.categories.filter((item) => typeof item === "string" && item.trim())
            : uniqueList(defs.map((def) => def.category));

        return { defs, categories };
      };

      const renderHealthCategoryChips = () => {
        if (!healthCategoryGroup) return;
        healthCategoryGroup.innerHTML = "";
        healthMetricCategories.forEach((label) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = `chip${label === activeHealthMetricCategory ? " chip--active" : ""}`;
          chip.textContent = label;
          chip.addEventListener("click", () => {
            if (activeHealthMetricCategory === label) return;
            activeHealthMetricCategory = label;
            renderHealthCategoryChips();
            applyHealthMetricFilters();
          });
          healthCategoryGroup.appendChild(chip);
        });
      };

      const loadHealthMetricConfig = async () => {
        try {
          const config = await fetchJsonFromSources(HEALTH_METRIC_CONFIG_SOURCES);
          const applied = applyHealthMetricConfig(config);
          healthMetricDefs = applied.defs;
          healthMetricCategories = applied.categories.length
            ? applied.categories
            : uniqueList(applied.defs.map((def) => def.category));
        } catch (error) {
          console.error("加载健康指标配置失败:", error);
          healthMetricDefs = METRIC_DEFS.map((def) => ({
            ...def,
            category: "未分类",
            enabled: true,
          }));
          healthMetricCategories = uniqueList(healthMetricDefs.map((def) => def.category));
        }

        healthMetricCategories = uniqueList(["全部", ...healthMetricCategories]);
        if (healthMetricCategories.includes(DEFAULT_HEALTH_METRIC_CATEGORY)) {
          activeHealthMetricCategory = DEFAULT_HEALTH_METRIC_CATEGORY;
        } else if (!healthMetricCategories.includes(activeHealthMetricCategory)) {
          activeHealthMetricCategory = healthMetricCategories[0];
        }
        renderHealthCategoryChips();
      };

      const applyHealthMetricFilters = () => {
        const rows =
          activeHealthMetricCategory === "全部"
            ? metricRows
            : metricRows.filter((row) => row.category === activeHealthMetricCategory);
        renderMetricTable(rows);
      };

      const resolveChartsImage = (def) => {
        if (!def) return null;
        const sources = Array.isArray(def.sources) ? def.sources : [];
        const url =
          sources
            .map((source) => (source && typeof source.url === "string" ? source.url : ""))
            .find((candidate) => candidate && /\.csv$/i.test(candidate.split("?")[0])) || "";
        if (!url) return null;

        const filename = url.split("?")[0].split("/").pop();
        if (!filename || !/\.csv$/i.test(filename)) return null;

        const stem = filename.replace(/\.csv$/i, "");
        return `health/charts/${stem}__${def.valueKey}.svg`;
      };

      const parseMetricSeries = (text, valueKey) => {
        const rows = parseCSV(text);
        if (!rows.length) return [];
        const headers = rows[0].map((h) => h.trim().toLowerCase());
        const idxDate = headers.indexOf("date");
        const idxVal = headers.indexOf(valueKey.toLowerCase());
        if (idxDate === -1 || idxVal === -1) return [];
        return rows
          .slice(1)
          .map((cells) => {
            const d = parseDate(cells[idxDate]);
            const v = parseFloat(cells[idxVal]);
            if (!d || Number.isNaN(v)) return null;
            return { date: d, value: v };
          })
          .filter(Boolean)
          .sort((a, b) => a.date - b.date);
      };

      const avgWindowByDate = (series, days, offsetDays = 0) => {
        if (!series.length) return null;
        const lastDate = series[series.length - 1].date;
        const end = new Date(lastDate);
        end.setHours(23, 59, 59, 999); // 设置为当天的结束时间
        end.setDate(end.getDate() - offsetDays);
        const start = new Date(end);
        start.setDate(start.getDate() - (days - 1));
        start.setHours(0, 0, 0, 0); // 设置为开始日期的开始时间
        const window = series.filter((item) => {
          const itemDate = new Date(item.date);
          itemDate.setHours(0, 0, 0, 0);
          return itemDate >= start && itemDate <= end;
        });
        if (!window.length) return null;
        const total = window.reduce((acc, cur) => acc + cur.value, 0);
        return total / window.length;
      };

      const formatValueWithUnit = (val, unit) => {
        if (val === null || Number.isNaN(val)) return "--";
        const num = Number(val);
        // 体脂率：将小数转换为百分比
        if (unit === "%" && num < 1) {
          return `${(num * 100).toFixed(1)}%`;
        }
        // 空单位：不显示单位
        if (!unit || unit === "") {
          return num.toFixed(2);
        }
        // 3位有效数字：智能格式化（整数或包含小数点）
        const formatted = formatThreeSignificantDigits(num);
        return `${formatted} ${unit}`;
      };

      const formatThreeSignificantDigits = (num) => {
        if (num === 0) return "0";
        const absNum = Math.abs(num);
        // 如果数值 >= 1000，保留整数部分
        if (absNum >= 1000) {
          return Math.round(num).toString();
        }
        // 如果数值 < 1000，保留3位有效数字
        // 如果是整数或接近整数（小数部分小于0.001），显示整数
        if (Math.abs(num % 1) < 0.001) {
          return num.toString();
        }
        // 否则使用3位有效数字
        return num.toPrecision(3);
      };

      const formatDeltaColored = (current, previous) => {
        if (current === null || previous === null || previous === 0) return "—";
        const delta = ((current - previous) / previous) * 100;
        // 变化超过5%才标注颜色，否则使用默认颜色
        const absDelta = Math.abs(delta);
        const cls = absDelta >= 5 ? (delta > 0 ? "delta-pos" : "delta-neg") : "";
        const sign = delta > 0 ? "+" : "";
        return `<span class="${cls}">${sign}${delta.toFixed(1)}%</span>`;
      };

      const formatDeltaSigned = (current, previous) => {
        if (current === null || previous === null || previous === 0) return "—";
        const delta = ((current - previous) / previous) * 100;
        const cls = delta > 0 ? "delta-pos" : delta < 0 ? "delta-neg" : "";
        const sign = delta > 0 ? "+" : "";
        return `<span class="${cls}">${sign}${delta.toFixed(1)}%</span>`;
      };

      const formatClock = (minutes, wrapOverMidnight = false) => {
        if (minutes === null || Number.isNaN(minutes)) return "--";
        let mins = minutes;
        if (wrapOverMidnight && mins >= 24 * 60) {
          mins -= 24 * 60;
        }
        mins = Math.round(mins);
        const hh = String(Math.floor(mins / 60) % 24).padStart(2, "0");
        const mm = String(mins % 60).padStart(2, "0");
        return `${hh}:${mm}`;
      };

      const parseClockToMinutes = (text) => {
        if (!text) return null;
        const cleaned = text.trim();
        if (!cleaned) return null;
        if (cleaned.includes(":")) {
          const parts = cleaned.split(":");
          const hh = parseInt(parts[0], 10);
          const mm = parseInt(parts[1], 10);
          if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
          return hh * 60 + mm;
        }
        const num = parseFloat(cleaned);
        return Number.isNaN(num) ? null : num;
      };

      const parseScheduleSeries = (text, valueKey) => {
        const rows = parseCSV(text);
        if (!rows.length) return [];
        const headers = rows[0].map((h) => h.trim().toLowerCase());
        const idxDate = headers.indexOf("date");
        const idxVal = headers.indexOf(valueKey.toLowerCase());
        if (idxDate === -1 || idxVal === -1) return [];
        return rows
          .slice(1)
          .map((cells) => {
            const d = parseDate(cells[idxDate]);
            const v = parseClockToMinutes(cells[idxVal]);
            if (!d || v === null) return null;
            return { date: d, value: v };
          })
          .filter(Boolean)
          .sort((a, b) => a.date - b.date);
      };

      const setHighlightValue = (el, value) => {
        if (!el) return;
        el.textContent = value;
      };

      const setHighlightDelta = (el, current, previous) => {
        if (!el) return;
        el.innerHTML = formatDeltaSigned(current, previous);
      };

      const loadHealthHighlight = async () => {
        if (!highlightEls.weight) return;
        const highlightWindow = 7;
        const highlightOffset = 7;
        const calcAvg = (series) => avgWindowByDate(series, highlightWindow, 0);
        const calcPrev = (series) => avgWindowByDate(series, highlightWindow, highlightOffset);

        try {
          const { text } = await fetchFromSources(BODY_SOURCES);
          const weightSeries = parseMetricSeries(text, "weight_kg");
          const fatSeries = parseMetricSeries(text, "body_fat_pct");

          const weightAvg = calcAvg(weightSeries);
          const weightPrev = calcPrev(weightSeries);
          const fatAvg = calcAvg(fatSeries);
          const fatPrev = calcPrev(fatSeries);

          setHighlightValue(highlightEls.weight, formatValueWithUnit(weightAvg, "kg"));
          setHighlightDelta(highlightEls.weightWow, weightAvg, weightPrev);
          setHighlightValue(highlightEls.bodyFat, formatValueWithUnit(fatAvg, "%"));
          setHighlightDelta(highlightEls.bodyFatWow, fatAvg, fatPrev);
        } catch (error) {
          console.error("加载体重高亮失败:", error);
        }

        try {
          const { text } = await fetchFromSources(HEALTH_SOURCES);
          const sleepSeries = parseMetricSeries(text, "sleep_hours");
          const sleepAvg = calcAvg(sleepSeries);
          const sleepPrev = calcPrev(sleepSeries);
          setHighlightValue(highlightEls.sleep, formatValueWithUnit(sleepAvg, "小时"));
          setHighlightDelta(highlightEls.sleepWow, sleepAvg, sleepPrev);
        } catch (error) {
          console.error("加载睡眠高亮失败:", error);
        }

        try {
          const { text } = await fetchFromSources(SLEEP_SCHEDULE_SOURCES);
          const bedRaw = parseScheduleSeries(text, "bed_time");
          const wakeSeries = parseScheduleSeries(text, "wake_time");
          const bedSeries = bedRaw.map((item) => ({
            ...item,
            value: item.value < 12 * 60 ? item.value + 24 * 60 : item.value,
          }));

          const bedAvg = calcAvg(bedSeries);
          const bedPrev = calcPrev(bedSeries);
          const wakeAvg = calcAvg(wakeSeries);
          const wakePrev = calcPrev(wakeSeries);

          setHighlightValue(highlightEls.bedTime, formatClock(bedAvg, true));
          setHighlightDelta(highlightEls.bedTimeWow, bedAvg, bedPrev);
          setHighlightValue(highlightEls.wakeTime, formatClock(wakeAvg, false));
          setHighlightDelta(highlightEls.wakeTimeWow, wakeAvg, wakePrev);
        } catch (error) {
          console.error("加载睡眠作息高亮失败:", error);
        }

        try {
          const { text } = await fetchFromSources(HRV_SOURCES);
          const hrvSeries = parseMetricSeries(text, "sdnn_avg");
          const hrvAvg = calcAvg(hrvSeries);
          const hrvPrev = calcPrev(hrvSeries);
          setHighlightValue(highlightEls.hrv, formatValueWithUnit(hrvAvg, "ms"));
          setHighlightDelta(highlightEls.hrvWow, hrvAvg, hrvPrev);
        } catch (error) {
          console.error("加载 HRV 高亮失败:", error);
        }
      };

      const renderMetricTable = (rows) => {
        metricTableBody.innerHTML = "";
        if (!rows.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = "暂无数据";
          tr.appendChild(td);
          metricTableBody.appendChild(tr);
          return;
        }
        rows.forEach((row) => {
          const tr = document.createElement("tr");

          const nameCell = document.createElement("td");
          nameCell.textContent = row.label;
          nameCell.dataset.metricLabel = row.label;
          nameCell.classList.add("metric-link");
          nameCell.title = "点击查看趋势图";
          tr.appendChild(nameCell);

          const weekCell = document.createElement("td");
          weekCell.textContent = row.weekAvg;
          tr.appendChild(weekCell);

          const wowCell = document.createElement("td");
          wowCell.innerHTML = row.wow;
          tr.appendChild(wowCell);

          const momCell = document.createElement("td");
          momCell.innerHTML = row.mom;
          tr.appendChild(momCell);

          const yoyCell = document.createElement("td");
          yoyCell.innerHTML = row.yoy;
          tr.appendChild(yoyCell);


          metricTableBody.appendChild(tr);
        });
      };

      const loadMetricTable = async () => {
        try {
          if (healthStatus) {
            healthStatus.textContent = "正在加载健康数据...";
          }
          const rows = [];
          for (const def of healthMetricDefs) {
            if (def.enabled === false) continue;
            const category = def.category || "未分类";
            try {
              const { text } = await fetchFromSources(def.sources);
              const series = parseMetricSeries(text, def.valueKey);
              if (!series.length) {
                rows.push({
                  label: def.label,
                  category,
                  weekAvg: "--",
                  wow: "—",
                  mom: "—",
                  yoy: "—",
                });
                continue;
              }
              
              // 统一使用原始数据直接计算周日均值（7日滚动平均仅用于趋势图）
              const avg7 = avgWindowByDate(series, 7, 0);
              const prev7 = avgWindowByDate(series, 7, 7);
              const prev30 = avgWindowByDate(series, 30, 7);
              const avg365 = avgWindowByDate(series, 365, 0);

              rows.push({
                label: def.label,
                category,
                weekAvg: formatValueWithUnit(avg7, def.unit),
                wow: formatDeltaColored(avg7, prev7),
                mom: formatDeltaColored(avg7, prev30),
                yoy: formatDeltaColored(avg7, avg365),
              });
            } catch (error) {
              console.error(`加载指标 ${def.label} 失败:`, error);
              rows.push({
                label: def.label,
                category,
                weekAvg: "加载失败",
                wow: "—",
                mom: "—",
                yoy: "—",
              });
            }
          }
          metricRows = rows;
          applyHealthMetricFilters();
          if (healthStatus) {
            healthStatus.textContent = "健康数据已加载";
          }
        } catch (error) {
          console.error("加载指标表格失败:", error);
          metricRows = [];
          renderMetricTable([]);
          if (healthStatus) {
            healthStatus.textContent = "健康数据加载失败";
          }
        }
      };

      const initHealthMetricTable = async () => {
        await loadHealthMetricConfig();
        await loadMetricTable();
      };


      const fetchCSVSource = async () => {
        const errors = [];
        for (const source of CSV_SOURCES) {
          try {
            const response = await fetch(source.url, { cache: "no-store" });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const text = await response.text();
            const lastModified = await resolveLastModified(response, source.url);
            return { text, lastModified, sourceLabel: source.label };
          } catch (error) {
            errors.push(`${source.label}: ${error.message}`);
          }
        }
        throw new Error(errors.join(" | "));
      };

      const loadCSV = async () => {
        statusEl.textContent = "正在加载数据...";
        updateTimeEl.textContent = " 正在获取...";
        try {
          const { text, lastModified, sourceLabel } = await fetchCSVSource();
          if (lastModified) {
            updateTimeEl.textContent = formatUpdateTime(lastModified);
            updateTimeEl.title = `${lastModified.toString()} · 来源：${sourceLabel}`;
          } else {
            updateTimeEl.textContent = ` 无可用数据（来源：${sourceLabel})`;
            updateTimeEl.removeAttribute("title");
          }
          const rows = parseCSV(text);
          if (!rows.length) {
            statusEl.textContent = "CSV 文件为空";
            records = [];
            renderBody([]);
            return;
          }
          records = buildRecords(rows);
          applyFilters();
        } catch (error) {
          console.error(error);
          statusEl.textContent = "加载失败，请确认 CSV 文件路径正确";
          records = [];
          renderBody([]);
        }
      };

      renderCategoryChips();
      initLimitSelect();
      ensureLimitValue();
      renderHeader();
      renderBody([]);
      initHealthMetricTable();
      loadHealthHighlight();
      loadCSV();
    </script>
    <div class="modal" id="chart-modal" aria-hidden="true">
      <div class="modal-content">
        <button class="modal-close" id="modal-close" type="button">关闭</button>
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-chart" id="modal-chart"></div>
        <img class="modal-image" id="modal-image" src="" alt="" />
      </div>
    </div>
    <div class="modal" id="sleep-info-modal" aria-hidden="true">
      <div class="modal-content">
        <button class="modal-close" id="sleep-info-close" type="button">关闭</button>
        <div class="modal-title">睡眠时长 ≠ 起床 - 入睡</div>
        <div class="modal-text">
          睡眠时长来自实际睡眠片段的总和，清醒时段不会计入；入睡/起床取的是每晚最长睡眠段的开始与结束。
          因此两者差值代表“在床时长”，如果存在夜间醒来、分段睡眠或午休，差值就会大于实际睡眠时长。
        </div>
      </div>
    </div>
    <script>
      (() => {
        const metricTableBody = document.getElementById("health-metric-body");
        const modal = document.getElementById("chart-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalChart = document.getElementById("modal-chart");
        const modalImg = document.getElementById("modal-image");
        const modalClose = document.getElementById("modal-close");
        if (!metricTableBody || !modal || !modalTitle || !modalChart || !modalImg || !modalClose) return;

        const baseDefs =
          typeof healthMetricDefs === "undefined"
            ? typeof METRIC_DEFS === "undefined"
              ? []
              : METRIC_DEFS
            : healthMetricDefs;
        const extraDefs =
          typeof HIGHLIGHT_EXTRA_DEFS === "undefined" ? [] : HIGHLIGHT_EXTRA_DEFS;
        const metricDefMap = new Map(
          [...baseDefs, ...extraDefs].map((def) => [def.label, def])
        );

        const openModalShell = () => {
          modal.classList.add("modal--open");
          modal.setAttribute("aria-hidden", "false");
        };

        const closeModal = () => {
          modal.classList.remove("modal--open");
          modal.setAttribute("aria-hidden", "true");
          modalTitle.textContent = "";
          modalChart.innerHTML = "";
          modalChart.style.display = "none";
          modalImg.src = "";
          modalImg.alt = "";
          modalImg.style.display = "none";
        };

        let openToken = 0;

        const showLoading = (text) => {
          modalChart.style.display = "block";
          modalChart.textContent = text || "正在加载...";
          modalImg.style.display = "none";
        };

        const showImage = (src, alt) => {
          modalImg.src = src;
          modalImg.alt = alt || "";
          modalImg.style.display = "block";
          modalChart.style.display = "none";
          modalChart.innerHTML = "";
        };

        const formatYM = (d) => {
          const date = d instanceof Date ? d : new Date(d);
          if (Number.isNaN(date.getTime())) return "";
          const month = String(date.getMonth() + 1).padStart(2, "0");
          return `${date.getFullYear()}-${month}`;
        };

        const normalizeChartValue = (value, unit) => {
          if (value === null || Number.isNaN(value)) return null;
          let num = Number(value);
          if (unit === "%" && num < 1) num *= 100;
          return num;
        };

        const movingAvg = (values, window = 7) =>
          values.map((_, idx) => {
            const start = Math.max(0, idx - window + 1);
            const slice = values.slice(start, idx + 1);
            const total = slice.reduce((acc, cur) => acc + cur, 0);
            return total / slice.length;
          });

        const renderFallbackChart = async (def, token) => {
          showLoading("正在加载数据...");
          const { text } = await fetchFromSources(def.sources);
          const series = parseMetricSeries(text, def.valueKey);
          if (!series.length) {
            modalChart.textContent = "暂无数据";
            return;
          }

          const filtered = series
            .map((item) => ({
              date: item.date,
              value: normalizeChartValue(item.value, def.unit),
            }))
            .filter((item) => item.value !== null);
          if (!filtered.length) {
            modalChart.textContent = "暂无数据";
            return;
          }

          const ma = movingAvg(filtered.map((item) => item.value), 7);
          const chartData = filtered
            .map((item, idx) => ({ label: formatYM(item.date), value: ma[idx] }))
            .slice(-365);

          if (token !== openToken) return;
          modalChart.style.display = "block";
          renderLineChart(modalChart, chartData, { color: "#60a5fa" });
        };

        const openMetric = (label) => {
          const def = metricDefMap.get(label);
          if (!def) return;

          openToken += 1;
          const token = openToken;

          modalTitle.textContent = `${label} 趋势图`;
          openModalShell();

          const src = resolveChartsImage(def);
          if (!src) {
            renderFallbackChart(def, token).catch((error) => {
              console.error(error);
              if (token !== openToken) return;
              modalChart.textContent = "加载失败";
            });
            return;
          }

          showLoading("正在加载趋势图...");
          const probe = new Image();
          probe.onload = () => {
            if (token !== openToken) return;
            showImage(src, `${label} 趋势图`);
          };
          probe.onerror = () => {
            renderFallbackChart(def, token).catch((error) => {
              console.error(error);
              if (token !== openToken) return;
              modalChart.textContent = "加载失败";
            });
          };
          probe.src = src;
        };

        metricTableBody.addEventListener("click", (e) => {
          const cell = e.target.closest("td");
          if (!cell) return;
          const label = (cell.dataset.metricLabel || "").trim();
          if (!label) return;
          openMetric(label);
        });

        const healthHighlight = document.getElementById("health-highlight");
        if (healthHighlight) {
          healthHighlight.addEventListener("click", (e) => {
            const target = e.target.closest("[data-metric-label]");
            if (!target) return;
            const label = (target.dataset.metricLabel || "").trim();
            if (!label) return;
            openMetric(label);
          });
        }

        const infoTrigger = document.getElementById("sleep-info-trigger");
        const infoModal = document.getElementById("sleep-info-modal");
        const infoClose = document.getElementById("sleep-info-close");
        if (infoTrigger && infoModal && infoClose) {
          const openInfo = () => {
            infoModal.classList.add("modal--open");
            infoModal.setAttribute("aria-hidden", "false");
          };
          const closeInfo = () => {
            infoModal.classList.remove("modal--open");
            infoModal.setAttribute("aria-hidden", "true");
          };
          infoTrigger.addEventListener("click", (e) => {
            e.stopPropagation();
            openInfo();
          });
          infoClose.addEventListener("click", closeInfo);
          infoModal.addEventListener("click", (e) => {
            if (e.target === infoModal) closeInfo();
          });
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && infoModal.classList.contains("modal--open")) {
              closeInfo();
            }
          });
        }

        modalClose.addEventListener("click", closeModal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.classList.contains("modal--open")) {
            closeModal();
          }
        });

      })();
    </script>
  </body>
</html>
