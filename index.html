<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Key-Data-Management</title>
    <style>
      :root {
        font-family: "Inter", "PingFang SC", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #f8fafc;
        background-color: #020617;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 24px;
        display: flex;
        justify-content: center;
        background: radial-gradient(circle at top, rgba(37, 99, 235, 0.15), transparent 60%) #020617;
      }
      body.modal-open {
        overflow: hidden;
      }
      main {
        width: min(960px, 100%);
        background: #0f172a;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 30px 80px rgba(2, 8, 23, 0.85);
      }
      header {
        margin-bottom: 24px;
      }
      h1 {
        margin: 0 0 8px;
        font-size: 1.75rem;
      }
      p {
        margin: 0;
        color: #cbd5f5;
      }
      .status {
        margin-top: 16px;
        font-size: 0.95rem;
        color: #60a5fa;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        border-spacing: 0;
        font-size: 0.95rem;
      }
      thead {
        position: sticky;
        top: 0;
        background: rgba(30, 41, 59, 0.85);
        z-index: 1;
      }
      th,
      td {
        padding: 12px 14px;
        border-bottom: 1px solid rgba(99, 102, 241, 0.35);
        text-align: left;
        vertical-align: top;
      }
      th {
        font-weight: 600;
        color: #e2e8f0;
        letter-spacing: 0.02em;
      }
      tbody tr:nth-child(odd) {
        background-color: rgba(15, 23, 42, 0.7);
      }
      tbody tr:hover {
        background-color: rgba(37, 99, 235, 0.25);
      }
      a {
        color: #93c5fd;
        text-decoration: none;
      }
      a:hover {
        text-decoration: underline;
      }
      .scroll-wrap {
        overflow-x: auto;
        border-radius: 12px;
      }
      .filters {
        margin-top: 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
      }
      .filter-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 180px;
      }
      .filter-field span {
        font-size: 0.85rem;
        color: #475569;
      }
      .chip-group {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: transparent;
        color: #e2e8f0;
        padding: 6px 14px;
        border-radius: 999px;
        font-size: 14px;
        line-height: 17px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        min-height: 34px;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .chip:hover {
        border-color: #93c5fd;
        color: #93c5fd;
      }
      .chip--active {
        background: #1d4ed8;
        border-color: #1d4ed8;
        color: #fff;
        box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
      }
      input[type="number"],
      select {
        border: 1px solid rgba(148, 163, 184, 0.6);
        border-radius: 10px;
        padding: 8px 12px;
        font-size: 0.95rem;
        background: #1f2937;
        color: #e2e8f0;
      }
      .tab-bar {
        display: flex;
        gap: 12px;
        margin-bottom: 20px;
      }
      .tab-button {
        border: 1px solid transparent;
        background: rgba(255, 255, 255, 0.05);
        color: #cbd5f5;
        padding: 10px 18px;
        border-radius: 999px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .tab-button--active {
        background: #2563eb;
        border-color: #93c5fd;
        color: #fff;
        box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
      }
      .tab-panel {
        display: none;
      }
      .tab-panel--active {
        display: block;
      }
      .plan-block {
        margin: 12px 0 20px;
        padding: 16px 18px;
        border-radius: 12px;
        background: rgba(99, 102, 241, 0.08);
        border: 1px solid rgba(148, 163, 184, 0.25);
        color: #e2e8f0;
      }
      .plan-title {
        margin: 0 0 8px;
        font-weight: 700;
        font-size: 1.05rem;
      }
      .plan-section {
        margin: 6px 0;
      }
      .plan-section strong {
        color: #a5b4fc;
      }
      .plan-list {
        margin: 4px 0 0 14px;
        color: #cbd5f5;
        padding: 0;
        list-style-type: disc;
      }
      .note-heading {
        margin: 0 0 6px;
        font-weight: 600;
        color: #cbd5f5;
      }
      .note-divider {
        border: 0;
        height: 1px;
        margin: 12px 0;
        background: rgba(148, 163, 184, 0.35);
      }
      .table-note {
        margin: 6px 0 12px;
        color: #94a3b8;
        font-size: 0.92rem;
      }
      .delta-pos {
        color: #34d399;
        font-weight: 600;
      }
      .delta-neg {
        color: #f87171;
        font-weight: 600;
      }
      .metric-link {
        cursor: pointer;
        color: #93c5fd;
        font-weight: 600;
      }
      .metric-link:hover {
        text-decoration: underline;
      }
      .highlight-label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      #health-highlight .plan-list li {
        line-height: 1.7;
      }
      .info-badge {
        position: relative;
        top: 0;
        right: 0;
        margin-left: 2px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 1px solid rgba(148, 163, 184, 0.6);
        background: rgba(15, 23, 42, 0.9);
        color: #93c5fd;
        font-size: 11px;
        line-height: 14px;
        font-weight: 700;
        cursor: pointer;
        padding: 0;
      }
      .info-badge:hover {
        border-color: #93c5fd;
        color: #e2e8f0;
      }
      .metric-thumb-empty {
        color: #94a3b8;
        font-size: 0.85rem;
      }
      .modal-title {
        margin: 2px 0 12px;
        font-weight: 700;
        color: #e2e8f0;
      }
      .modal-chart {
        display: none;
        width: min(920px, 82vw);
        height: 70vh;
        max-height: 720px;
        min-height: 360px;
        margin-bottom: 20px;
      }
      .modal-content .modal-image {
        display: none;
      }
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.65);
        display: none;
        align-items: flex-start;
        justify-content: center;
        z-index: 999;
        padding: 20px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .modal--open {
        display: flex;
      }
      .modal-content {
        background: #0f172a;
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 12px;
        padding: 12px;
        padding-bottom: 36px;
        max-width: 90vw;
        max-height: none;
        margin: 24px auto;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }
      .modal-text {
        color: #cbd5f5;
        line-height: 1.6;
        max-width: 720px;
      }
      .modal-content img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 8px;
      }
      .modal-close {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(255, 255, 255, 0.05);
        color: #e2e8f0;
        border-radius: 8px;
        padding: 6px 10px;
        cursor: pointer;
        margin-bottom: 8px;
      }
      @media (max-width: 640px) {
        main {
          padding: 20px;
        }
        table {
          font-size: 0.85rem;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header style="margin-bottom: 16px;">
        <h1>Key-Data-Management</h1>
      </header>
      <div class="tab-bar">
        <button class="tab-button tab-button--active" data-tab="health">å¥åº·</button>
        <button class="tab-button" data-tab="entertainment">å¨±ä¹</button>
        <button class="tab-button" data-tab="wealth">è´¢äº§</button>
        <button class="tab-button" data-tab="ai-news">AIå’¨è¯¢</button>
        <button class="tab-button" data-tab="knowledge">çŸ¥è¯†åº“</button>
      </div>
      <section class="tab-panel tab-panel--active" id="tab-health">
        <!-- æ•°æ®æ›´æ–°æ—¶é—´å’Œå£å¾„è¯´æ˜ -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 0 0 16px;">
          <span style="font-size: 0.8rem; color: #64748b; background: rgba(100, 116, 139, 0.15); padding: 4px 10px; border-radius: 4px;">å£å¾„ï¼šå‘¨æ—¥å‡</span>
          <span style="font-size: 0.85rem; color: #64748b;">æ•°æ®æ›´æ–°ï¼š<span id="health-update-time">--</span></span>
        </div>
        
        <!-- è¿åŠ¨æ¨¡å— -->
        <div class="plan-block" id="health-exercise-block" style="margin-bottom: 16px;">
          <div id="viz1-advice" style="margin-bottom: 12px; padding: 10px 14px; background: rgba(34, 197, 94, 0.15); border-radius: 8px; border-left: 3px solid #22c55e;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 12px; color: #86efac; font-weight: 600;">ä»Šæ—¥è¿åŠ¨å»ºè®®</span>
              <button class="info-badge" id="exercise-advice-trigger" type="button" aria-label="è¿åŠ¨å»ºè®®è§„åˆ™è¯´æ˜" style="font-size: 10px; width: 14px; height: 14px; border-radius: 50%; background: #475569; color: #94a3b8; border: none; cursor: pointer;">?</button>
            </div>
            <div id="viz1-advice-text" style="font-size: 13px; color: #f8fafc; margin-top: 4px;">åŠ è½½ä¸­...</div>
          </div>
          <!-- è¿åŠ¨å»ºè®®è§„åˆ™å¼¹çª— -->
          <div id="exercise-advice-popup" class="info-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 16px 20px; z-index: 1000; max-width: 360px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 600; color: #f8fafc;">è¿åŠ¨å»ºè®®è§„åˆ™</span>
              <button id="exercise-advice-close" style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px;">&times;</button>
            </div>
            <div style="font-size: 12px; color: #94a3b8; line-height: 1.6;">
              <p style="margin: 0 0 8px; font-weight: 600; color: #86efac;">é˜ˆå€¼è®¾å®šï¼š</p>
              <ul style="margin: 0 0 12px; padding-left: 16px;">
                <li>å‘¨è¿åŠ¨ç›®æ ‡ï¼š4å¤©/å‘¨</li>
                <li>æœˆè¿åŠ¨ç›®æ ‡ï¼š16å¤©/æœˆ</li>
                <li>ç¡çœ è¾¾æ ‡ï¼šâ‰¥6å°æ—¶ï¼ˆé¢„è­¦çº¿ï¼‰</li>
                <li>HRVè¾¾æ ‡ï¼šâ‰¥30msï¼ˆé¢„è­¦çº¿ï¼‰</li>
              </ul>
              <p style="margin: 0 0 8px; font-weight: 600; color: #86efac;">åˆ¤æ–­é€»è¾‘ï¼š</p>
              <ul style="margin: 0; padding-left: 16px;">
                <li><span style="color: #22c55e;">å¯ä¼‘æ¯</span>ï¼šå‘¨+æœˆéƒ½è¾¾æ ‡</li>
                <li><span style="color: #3b82f6;">å»ºè®®è¿åŠ¨</span>ï¼šå‘¨è¾¾æ ‡ä½†æœˆæœªè¾¾æ ‡ï¼Œä¸”èº«ä½“çŠ¶æ€OK</li>
                <li><span style="color: #f97316;">å…ˆä¼‘æ¯</span>ï¼šè¿åŠ¨æœªè¾¾æ ‡ï¼Œä½†ç¡çœ ä¸è¶³æˆ–HRVåä½</li>
                <li><span style="color: #ef4444;">å¿«è¿åŠ¨</span>ï¼šå‘¨æœªè¾¾æ ‡ï¼Œèº«ä½“çŠ¶æ€OK</li>
              </ul>
            </div>
          </div>
          <div id="exercise-advice-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>
          
          <!-- è¿åŠ¨æŒ‡æ ‡å¡ç‰‡ -->
          <div id="exercise-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px;">
            <div class="viz-card" data-metric="exercise_time_min" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155; cursor: pointer;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">è¿åŠ¨å¤©æ•°</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-exercise">--</div>
              <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;" id="viz1-exercise-sub">æœ¬æœˆ --å¤©</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-exercise-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f97316, #22c55e); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;"><span style="color: #22d3ee;">ç›®æ ‡4å¤©</span> Â· <span style="color: #f97316;">é¢„è­¦2å¤©</span></div>
            </div>
            <div class="viz-card" data-metric="sleep_hours" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155; cursor: pointer;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">ç¡çœ æ—¶é•¿</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-sleep">--</div>
              <div style="font-size: 11px; margin-top: 4px;" id="viz1-sleep-delta">--</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-sleep-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f97316, #22c55e); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;"><span style="color: #22d3ee;">ç›®æ ‡8h</span> Â· <span style="color: #f97316;">é¢„è­¦6h</span></div>
            </div>
            <div class="viz-card" data-metric="weight_kg" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155; cursor: pointer;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">ä½“é‡</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-weight">--</div>
              <div style="font-size: 11px; margin-top: 4px;" id="viz1-weight-delta">--</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-weight-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #f97316); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;"><span style="color: #22d3ee;">ç›®æ ‡70kg</span> Â· <span style="color: #f97316;">é¢„è­¦80kg</span></div>
            </div>
          </div>
          
          <!-- è¿åŠ¨æ—¥å† - é»˜è®¤éšè— -->
          <div id="exercise-calendar-toggle" style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 14px; background: rgba(34, 197, 94, 0.08); border-radius: 8px; margin-bottom: 0;" onclick="toggleExerciseCalendar()">
            <span style="font-size: 13px; color: #86efac;">ğŸ“… æœ€è¿‘4å‘¨è¿åŠ¨è®°å½•</span>
            <span id="calendar-toggle-icon" style="font-size: 12px; color: #64748b; transition: transform 0.3s;">â–¼</span>
          </div>
          <div id="exercise-calendar-v1" style="display: none; background: #1e293b; border-radius: 0 0 12px 12px; padding: 16px; border: 1px solid #334155; border-top: none;">
            <div id="cal-v1-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px;"></div>
            <div style="display: flex; justify-content: space-around; margin-top: 10px; font-size: 10px; color: #64748b;">
              <span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span><span>å››</span><span>äº”</span><span>å…­</span><span>æ—¥</span>
            </div>
          </div>
          <!-- è¿åŠ¨è¯¦æƒ…å¼¹çª— -->
          <div id="exercise-detail-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 16px 20px; z-index: 1000; min-width: 200px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span id="exercise-detail-date" style="font-weight: 600; color: #f8fafc;">--</span>
              <button id="exercise-detail-close" style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px;">&times;</button>
            </div>
            <div id="exercise-detail-content" style="font-size: 13px; color: #cbd5f5; line-height: 1.8;"></div>
          </div>
          <div id="exercise-detail-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>
        </div>

        <!-- é¥®é£Ÿæ¨¡å— -->
        <div class="plan-block" id="health-diet-block" style="margin-bottom: 16px;">
          <div id="diet-advice" style="margin-bottom: 12px; padding: 10px 14px; background: rgba(251, 146, 60, 0.15); border-radius: 8px; border-left: 3px solid #fb923c;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 12px; color: #fdba74; font-weight: 600;">é¥®é£Ÿå»ºè®®</span>
              <button class="info-badge" id="diet-advice-trigger" type="button" style="font-size: 10px; width: 14px; height: 14px; border-radius: 50%; background: #475569; color: #94a3b8; border: none; cursor: pointer;">?</button>
            </div>
            <div id="diet-advice-text" style="font-size: 13px; color: #f8fafc; margin-top: 4px;">åŠ è½½ä¸­...</div>
            <div style="font-size: 11px; color: #94a3b8; margin-top: 6px; font-style: italic;">é¥®é£Ÿæ•°æ®æš‚æ—¶ä¸å…¨</div>
          </div>
          <!-- é¥®é£Ÿå»ºè®®è§„åˆ™å¼¹çª— -->
          <div id="diet-advice-popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1e293b; border: 1px solid #475569; border-radius: 12px; padding: 16px 20px; z-index: 1000; max-width: 360px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <span style="font-weight: 600; color: #f8fafc;">é¥®é£Ÿå»ºè®®è§„åˆ™</span>
              <button id="diet-advice-close" style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 18px;">&times;</button>
            </div>
            <div style="font-size: 12px; color: #94a3b8; line-height: 1.6;">
              <p style="margin: 0 0 8px; font-weight: 600; color: #fdba74;">çƒ­é‡å·®è®¡ç®—ï¼š</p>
              <ul style="margin: 0 0 12px; padding-left: 16px;">
                <li>çƒ­é‡å·® = æ‘„å…¥çƒ­é‡ - æ¶ˆè€—çƒ­é‡</li>
                <li>æ¶ˆè€—çƒ­é‡ = åŸºç¡€ä»£è°¢ + ä¸»åŠ¨èƒ½é‡</li>
                <li>å‡è„‚å»ºè®®ï¼šçƒ­é‡å·® -300~-500kcal</li>
                <li>ç»´æŒä½“é‡ï¼šçƒ­é‡å·® Â±200kcal</li>
              </ul>
              <p style="margin: 0 0 8px; font-weight: 600; color: #fdba74;">ä½“é‡ç›®æ ‡ï¼š</p>
              <ul style="margin: 0; padding-left: 16px;">
                <li><span style="color: #22d3ee;">ç›®æ ‡70kg</span> Â· <span style="color: #f97316;">é¢„è­¦80kg</span></li>
              </ul>
            </div>
          </div>
          <div id="diet-advice-overlay" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999;"></div>
          
          <!-- é¥®é£ŸæŒ‡æ ‡å¡ç‰‡ -->
          <div id="diet-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px;">
            <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">æ—¥å‡æ‘„å…¥</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-kcal">--</div>
              <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;" id="viz1-kcal-sub">--</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-kcal-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f97316, #22c55e); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;">å»ºè®® 1800-2200kcal</div>
            </div>
            <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">æ—¥å‡æ¶ˆè€—</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-burn">--</div>
              <div style="font-size: 11px; margin-top: 4px;" id="viz1-burn-detail">åŸºç¡€ä»£è°¢ + ä¸»åŠ¨èƒ½é‡</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-burn-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f97316, #22c55e); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;">çƒ­é‡å·®: <span id="viz1-calorie-diff" style="font-weight: 600;">--</span></div>
            </div>
            <div style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155; opacity: 0.6;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">è¡€ç³–</div>
              <div style="font-size: 24px; font-weight: 700; color: #64748b;">--</div>
              <div style="font-size: 11px; color: #64748b; margin-top: 4px;">æš‚æœªæ¥å…¥</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div style="height: 100%; width: 0%; background: #334155;"></div>
              </div>
              <div style="font-size: 10px; color: #475569; margin-top: 4px;">ç›®æ ‡ 4.0-5.5 mmol/L</div>
            </div>
          </div>
          
          <!-- è¥å…»æˆåˆ†æ‰‡å½¢å›¾ -->
          <div style="background: #1e293b; border-radius: 12px; padding: 16px; border: 1px solid #334155;">
            <div style="font-size: 12px; color: #94a3b8; margin-bottom: 12px;">è¥å…»æˆåˆ†å æ¯”ï¼ˆå‘¨å‡å€¼ï¼‰</div>
            <div style="display: flex; align-items: center; gap: 16px;">
              <div id="nutrition-pie" style="width: 100px; height: 100px; position: relative;">
                <svg viewBox="0 0 36 36" style="width: 100%; height: 100%; transform: rotate(-90deg);">
                  <circle cx="18" cy="18" r="15.9" fill="none" stroke="#334155" stroke-width="3"></circle>
                  <circle id="pie-protein" cx="18" cy="18" r="15.9" fill="none" stroke="#3b82f6" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"></circle>
                  <circle id="pie-fat" cx="18" cy="18" r="15.9" fill="none" stroke="#f59e0b" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"></circle>
                  <circle id="pie-carb" cx="18" cy="18" r="15.9" fill="none" stroke="#22c55e" stroke-width="3" stroke-dasharray="0, 100" stroke-linecap="round"></circle>
                </svg>
              </div>
              <div style="flex: 1; display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                  <span style="flex: 1; font-size: 12px; color: #e2e8f0;">è›‹ç™½è´¨</span>
                  <span style="font-size: 12px; color: #94a3b8;" id="viz1-protein">--g</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></div>
                  <span style="flex: 1; font-size: 12px; color: #e2e8f0;">è„‚è‚ª</span>
                  <span style="font-size: 12px; color: #94a3b8;" id="viz1-fat">--g</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 2px;"></div>
                  <span style="flex: 1; font-size: 12px; color: #e2e8f0;">ç¢³æ°´</span>
                  <span style="font-size: 12px; color: #94a3b8;" id="viz1-carb">--g</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ç¡çœ æ¨¡å— -->
        <div class="plan-block" id="health-sleep-block" style="margin-bottom: 16px;">
          <div id="sleep-advice" style="margin-bottom: 12px; padding: 10px 14px; background: rgba(139, 92, 246, 0.15); border-radius: 8px; border-left: 3px solid #8b5cf6;">
            <div style="display: flex; align-items: center; gap: 6px;">
              <span style="font-size: 12px; color: #c4b5fd; font-weight: 600;">ç¡çœ å»ºè®®</span>
              <button class="info-badge" id="sleep-info-trigger" type="button" style="font-size: 10px; width: 14px; height: 14px; border-radius: 50%; background: #475569; color: #94a3b8; border: none; cursor: pointer;">?</button>
            </div>
            <div id="sleep-advice-text" style="font-size: 13px; color: #f8fafc; margin-top: 4px;">åŠ è½½ä¸­...</div>
          </div>
          
          <!-- ç¡çœ æŒ‡æ ‡å¡ç‰‡ -->
          <div id="sleep-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px;">
            <div class="viz-card" data-metric="sleep_hours" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155; cursor: pointer;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">ç¡çœ æ—¶é•¿</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-sleep2">--</div>
              <div style="font-size: 11px; margin-top: 4px;" id="viz1-sleep2-delta">--</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-sleep2-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f97316, #8b5cf6); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;"><span style="color: #22d3ee;">ç›®æ ‡8h</span> Â· <span style="color: #f97316;">é¢„è­¦6h</span></div>
            </div>
            <div class="viz-card" data-metric="bed_time" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155; cursor: pointer;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">å…¥ç¡æ—¶é—´</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-bedtime">--</div>
              <div style="font-size: 11px; margin-top: 4px;" id="viz1-bedtime-delta">--</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-bedtime-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #22c55e, #8b5cf6); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;"><span style="color: #22d3ee;">ç›®æ ‡23:00</span> Â· <span style="color: #f97316;">é¢„è­¦00:00</span></div>
            </div>
            <div class="viz-card" data-metric="wake_time" style="background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); border-radius: 12px; padding: 14px; text-align: center; border: 1px solid #334155; cursor: pointer;">
              <div style="font-size: 12px; color: #94a3b8; margin-bottom: 4px;">èµ·åºŠæ—¶é—´</div>
              <div style="font-size: 24px; font-weight: 700; color: #f8fafc;" id="viz1-waketime">--</div>
              <div style="font-size: 11px; margin-top: 4px;" id="viz1-waketime-delta">--</div>
              <div style="margin-top: 8px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                <div id="viz1-waketime-bar" style="height: 100%; width: 0%; background: linear-gradient(90deg, #f59e0b, #8b5cf6); transition: width 0.5s;"></div>
              </div>
              <div style="font-size: 10px; color: #64748b; margin-top: 4px;"><span style="color: #22d3ee;">ç›®æ ‡07:00</span> Â· <span style="color: #f97316;">é¢„è­¦09:00</span></div>
            </div>
          </div>
          
          <!-- ç¡çœ è¶‹åŠ¿å›¾ - å‚ç›´æ—¶é—´è½´æ ·å¼ -->
          <div id="sleep-trend-container" style="background: #1e293b; border-radius: 12px; padding: 16px; border: 1px solid #334155;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <div style="font-size: 12px; color: #94a3b8;" id="sleep-trend-title">æœ€è¿‘7å¤©ç¡çœ è¶‹åŠ¿</div>
              <div style="display: flex; gap: 12px; font-size: 10px;">
                <span style="color: #6366f1;">â–  æ·±ç¡</span>
                <span style="color: #60a5fa;">â–  æµ…ç¡</span>
                <span style="color: #f97316;">â–  æ¸…é†’</span>
              </div>
            </div>
            <div style="display: flex; gap: 4px;">
              <!-- å·¦ä¾§æ—¶é—´è½´ -->
              <div style="display: flex; flex-direction: column; justify-content: space-between; padding: 0 8px 20px 0; font-size: 10px; color: #64748b; min-width: 40px; text-align: right;">
                <span>21:00</span>
                <span>23:00</span>
                <span>01:00</span>
                <span>03:00</span>
                <span>05:00</span>
                <span>07:00</span>
                <span>09:00</span>
                <span>11:00</span>
              </div>
              <!-- ç¡çœ æŸ±çŠ¶å›¾åŒºåŸŸ -->
              <div id="sleep-trend-chart" style="flex: 1; display: flex; gap: 8px; position: relative; height: 200px;"></div>
            </div>
            <div id="sleep-trend-labels" style="display: flex; justify-content: space-around; margin-top: 8px; margin-left: 48px; font-size: 10px; color: #64748b;"></div>
          </div>
        </div>

        <div id="health-status" class="status">æ­£åœ¨åŠ è½½å¥åº·æ•°æ®...</div>
        
        <!-- æ•°æ®æ˜ç»† -->
        <div style="margin-top: 20px;">
          <p style="margin: 0 0 12px; font-size: 14px; font-weight: 600; color: #e2e8f0;">æ•°æ®æ˜ç»†</p>
          <div class="filters">
            <div class="filter-field">
              <span>æŒ‡æ ‡åˆ†ç±»</span>
              <div class="chip-group" id="health-category-group"></div>
            </div>
          </div>
        </div>
        <div class="scroll-wrap" style="margin-top: 10px;">
          <table>
            <thead>
              <tr>
                <th>æŒ‡æ ‡å</th>
                <th>å‘¨æ—¥å‡</th>
                <th>å‘¨ç¯æ¯”</th>
                <th>æœˆç¯æ¯”</th>
                <th>å¹´åŒæ¯”</th>
              </tr>
            </thead>
            <tbody id="health-metric-body">
              <tr><td colspan="5">æ­£åœ¨è®¡ç®—...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- è¿­ä»£æ–¹å‘ -->
        <div class="plan-block" style="margin-top: 20px;">
          <p class="plan-title" style="margin: 0 0 6px;">è¿­ä»£æ–¹å‘</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>å¾…ç ´è§£ï¼šä¾‹è¡ŒåŒ–è·å–è‹¹æœå¥åº·æ–¹æ³•</li>
              <li>å¾…æ¥å…¥ï¼šè‹¹æœå¥åº·å…¶ä»–æŒ‡æ ‡ã€åˆ†éƒ¨ä½å¥èº«é¢‘ç‡ã€è¿åŠ¨çŠ¶æ€æ•°æ®ã€åŠ¨æ€è¡€ç³–ä»ªæ•°æ®</li>
              <li>æ¯æ—¥é¥®é£Ÿæˆåˆ†åˆ†æ</li>
              <li>å¾…è§„åˆ’ï¼šå¯è§†åŒ–å½¢æ€æ›´ç®€æ´ï¼Œæœ‰åŠ¨ä½œæŒ‡å¯¼ â€”â€” åç»­å°è¯•å¤§æ¨¡å‹ API</li>
            </ul>
          </div>
        </div>

      </section>
      <section class="tab-panel" id="tab-entertainment">
        <!-- Highlightè¯´æ˜ -->
        <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px; padding: 12px 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">âœ¨</span>
            <span style="font-size: 13px; color: #c4b5fd; font-weight: 500;">æ¯æ—¥è‡ªåŠ¨æ‹‰å–ä¼˜è´¨åšä¸»çš„æ›´æ–°ï¼Œé¿å¼€æ¨èæµå¯¹ç²¾åŠ›çš„æ¶ˆè€—</span>
          </div>
        </div>
        
        <!-- æ•°æ®æ›´æ–°æ—¶é—´ -->
        <p style="margin: 0 0 12px; font-size: 0.85rem; color: #64748b; text-align: right;">æ•°æ®æ›´æ–°ï¼š<span id="update-time">--</span></p>
        
        <!-- ç­›é€‰å’Œæ ‡ç­¾äº‘ -->
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
          <div id="ent-tags" style="display: flex; flex-wrap: wrap; gap: 8px; flex: 1;"></div>
          <div style="display: flex; align-items: center; gap: 6px; background: #1e293b; padding: 6px 12px; border-radius: 8px; border: 1px solid #334155;">
            <span style="font-size: 12px; color: #94a3b8;">æ¯ä½œè€…</span>
            <select id="limit-input" style="background: transparent; border: none; color: #f8fafc; font-size: 12px; cursor: pointer;"></select>
            <span style="font-size: 12px; color: #94a3b8;">æ¡</span>
          </div>
        </div>
        
        <!-- è§†é¢‘åˆ—è¡¨ -->
        <div id="ent-tag-cloud" style="background: #1e293b; border-radius: 12px; padding: 16px; border: 1px solid #334155;">
          <div id="status" class="status" style="margin: 0 0 12px; font-size: 13px;">æ­£åœ¨åŠ è½½æ•°æ®...</div>
          <div id="ent-video-list" style="display: flex; flex-direction: column; gap: 8px; max-height: 500px; overflow-y: auto;"></div>
        </div>

        <!-- è¿­ä»£æ–¹å‘ -->
        <div class="plan-block" style="margin-top: 20px;">
          <p class="plan-title" style="margin: 0 0 6px;">è¿­ä»£æ–¹å‘</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>æ¥å…¥ï¼šç‹è€…è£è€€è‡ªåŠ¨åŒ–æˆ˜ç»©åˆ†æï¼Œæ¯æ—¥è‹±é›„æ¢¯åº¦åˆ†æï¼Œå¼ºåŠ¿è‹±é›„æ¨è</li>
              <li>æ¥å…¥ï¼šåŸç¥è‡ªåŠ¨åŒ–ä»»åŠ¡å®Œæˆæƒ…å†µ</li>
            </ul>
          </div>
        </div>
      </section>
      <section class="tab-panel" id="tab-knowledge">
        <!-- è¯»ä¹¦ç¬”è®° -->
        <div class="plan-block" style="margin-bottom: 16px;">
          <p class="plan-title" style="margin: 0 0 12px;">è¯»ä¹¦ç¬”è®°</p>
          
          <div style="margin-bottom: 16px; padding: 14px; background: rgba(139, 92, 246, 0.08); border-radius: 10px; border-left: 3px solid #8b5cf6;">
            <div style="font-size: 13px; font-weight: 600; color: #c4b5fd; margin-bottom: 8px;">ã€Šé“å¾·ç»ã€‹</div>
            <blockquote style="margin: 0 0 8px; padding-left: 12px; border-left: 2px solid #475569; color: #94a3b8; font-style: italic;">
              "å¤©ä¸‹ä¸‡ç‰©ç”Ÿäºæœ‰ï¼Œæœ‰ç”Ÿäºæ— ã€‚"
            </blockquote>
            <p style="margin: 0; font-size: 13px; color: #cbd5f5; line-height: 1.6;">
              è¿™ä¸ªç«™ç‚¹çš„æ„ä¹‰åœ¨äºï¼Œç”¨æœ€å°‘çš„ç²¾åŠ›è·å¾—æœ€é‡è¦çš„ä¿¡æ¯ï¼Œè®©æ€ç»´æ¢å¤åˆ°"æ— "çš„çŠ¶æ€ï¼Œæ¢å¤çµæ„Ÿã€‚
            </p>
          </div>

          <div style="padding: 14px; background: rgba(59, 130, 246, 0.08); border-radius: 10px; border-left: 3px solid #3b82f6;">
            <div style="font-size: 13px; font-weight: 600; color: #93c5fd; margin-bottom: 8px;">ç½—æ°¸æµ© Ã— Minimax é—«ä¿Šæ° è®¿è°ˆ</div>
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div>
                <blockquote style="margin: 0 0 6px; padding-left: 12px; border-left: 2px solid #475569; color: #94a3b8; font-style: italic;">
                  "åˆä½œä¸é¡ºçš„æ ¹æœ¬ä¸Šæ˜¯ç»„ç»‡ä¸é¡ºã€‚"
                </blockquote>
                <p style="margin: 0; font-size: 13px; color: #cbd5f5;">AI Agent çš„ç»„ç»‡å½¢å¼æ˜¯å½±å“æ•ˆç‡çš„æ ¸å¿ƒåŸå› ã€‚</p>
              </div>
              <div>
                <blockquote style="margin: 0 0 6px; padding-left: 12px; border-left: 2px solid #475569; color: #94a3b8; font-style: italic;">
                  "å…¬å¸ç»„ç»‡ä¸ä¸€å®šæ˜¯æŒ‰ç…§å²—ä½åˆ’åˆ†çš„ï¼Œä¹Ÿå¯ä»¥æŒ‰ç…§è§’è‰²ç”»åƒè¿›è¡Œåˆ’åˆ†ã€‚"
                </blockquote>
                <p style="margin: 0; font-size: 13px; color: #cbd5f5; line-height: 1.6;">
                  å¦‚æœæŠŠä¸åŒçš„ AI èµ‹äºˆ"å·¥ç¨‹å¸ˆ"ã€"æ¶æ„å¸ˆ"ã€"äº§å“ç»ç†"çš„èº«ä»½å¹¶åˆ’å®šèŒè´£ï¼Œå®¹æ˜“äº§ç”Ÿå¹»è§‰ä¸é—å¿˜ã€‚
                  æ˜¯å¦åº”è¯¥å°è¯•èµ‹äºˆ AI ä¸åŒçš„æ€§æ ¼ç”»åƒï¼Ÿæ¯”å¦‚ï¼šè¾ƒçœŸçš„ AIã€å–„äºå‘ç°é—®é¢˜çš„ AIã€å–„äºç®¡ç†çš„ AIã€å–„äºå‘äººç±»æ±‡æŠ¥çš„ AIã€å–„äºæ€»ç»“æ²‰æ·€çš„ AIã€å–„äºè¿ç”¨ç¬¬ä¸€æ€§åŸç†æ‹†è§£åˆ†æé—®é¢˜çš„ AIã€‚
                </p>
              </div>
            </div>
          </div>
        </div>

        <p style="color: #64748b; font-size: 13px; margin-bottom: 16px;">æ›´å¤šçŸ¥è¯†åº“åŠŸèƒ½å¼€å‘ä¸­...</p>
        
        <!-- è¿­ä»£æ–¹å‘ -->
        <div class="plan-block">
          <p class="plan-title" style="margin: 0 0 6px;">è¿­ä»£æ–¹å‘</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>åˆ†æä¸­ï¼šå¾®ä¿¡è¯»ä¹¦ç¬”è®°æ¥å£</li>
              <li>å¾…è§„åˆ’ï¼šå¤§æ¨¡å‹ç†è§£å¹¶æ€»ç»“ç¬”è®°ã€æ’­å®¢ã€ä¼˜è´¨è§†é¢‘</li>
            </ul>
          </div>
        </div>
      </section>
      <section class="tab-panel" id="tab-wealth">
        <!-- èµ„äº§é…ç½®æ€»è§ˆ -->
        <div class="plan-block" style="margin-bottom: 16px;">
          <p class="plan-title" style="margin: 0 0 12px;">èµ„äº§é…ç½®</p>
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 200px; text-align: center; padding: 16px; background: linear-gradient(135deg, #1d4ed8 0%, #7c3aed 100%); border-radius: 12px;">
              <div style="font-size: 12px; color: rgba(255,255,255,0.7); margin-bottom: 4px;">æ€»èµ„äº§</div>
              <div style="font-size: 28px; font-weight: 700; color: #fff;">Â¥ --</div>
              <div style="font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 4px;">æœˆç¯æ¯” <span style="color: #4ade80;">+--</span></div>
            </div>
            <div style="flex: 2; min-width: 280px;">
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 12px; height: 12px; background: #3b82f6; border-radius: 2px;"></div>
                  <span style="flex: 1; font-size: 13px; color: #e2e8f0;">ç°é‡‘å­˜æ¬¾</span>
                  <span style="font-size: 13px; color: #94a3b8;">--%</span>
                  <div style="width: 100px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                    <div style="width: 40%; height: 100%; background: #3b82f6;"></div>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 12px; height: 12px; background: #22c55e; border-radius: 2px;"></div>
                  <span style="flex: 1; font-size: 13px; color: #e2e8f0;">ç†è´¢äº§å“</span>
                  <span style="font-size: 13px; color: #94a3b8;">--%</span>
                  <div style="width: 100px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                    <div style="width: 30%; height: 100%; background: #22c55e;"></div>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 12px; height: 12px; background: #f59e0b; border-radius: 2px;"></div>
                  <span style="flex: 1; font-size: 13px; color: #e2e8f0;">è‚¡ç¥¨åŸºé‡‘</span>
                  <span style="font-size: 13px; color: #94a3b8;">--%</span>
                  <div style="width: 100px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                    <div style="width: 20%; height: 100%; background: #f59e0b;"></div>
                  </div>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <div style="width: 12px; height: 12px; background: #ec4899; border-radius: 2px;"></div>
                  <span style="flex: 1; font-size: 13px; color: #e2e8f0;">å…¶ä»–</span>
                  <span style="font-size: 13px; color: #94a3b8;">--%</span>
                  <div style="width: 100px; height: 6px; background: #334155; border-radius: 3px; overflow: hidden;">
                    <div style="width: 10%; height: 100%; background: #ec4899;"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- å‚¨è“„ç›®æ ‡ -->
        <div class="plan-block" style="margin-bottom: 16px;">
          <p class="plan-title" style="margin: 0 0 12px;">å‚¨è“„ç›®æ ‡</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div style="padding: 14px; background: rgba(59, 130, 246, 0.1); border-radius: 10px; border: 1px solid rgba(59, 130, 246, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 13px; font-weight: 600; color: #f8fafc;">ä¹°è½¦ç›®æ ‡</span>
                <span style="font-size: 11px; color: #64748b;">Â¥200,000</span>
              </div>
              <div style="height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                <div style="width: 35%; height: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); border-radius: 4px;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 11px;">
                <span style="color: #3b82f6;">å·²æ”’ Â¥--</span>
                <span style="color: #64748b;">é¢„è®¡ -- ä¸ªæœˆ</span>
              </div>
            </div>
            <div style="padding: 14px; background: rgba(34, 197, 94, 0.1); border-radius: 10px; border: 1px solid rgba(34, 197, 94, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 13px; font-weight: 600; color: #f8fafc;">ä¹°æˆ¿é¦–ä»˜</span>
                <span style="font-size: 11px; color: #64748b;">Â¥1,000,000</span>
              </div>
              <div style="height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                <div style="width: 15%; height: 100%; background: linear-gradient(90deg, #22c55e, #4ade80); border-radius: 4px;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 11px;">
                <span style="color: #22c55e;">å·²æ”’ Â¥--</span>
                <span style="color: #64748b;">é¢„è®¡ -- ä¸ªæœˆ</span>
              </div>
            </div>
            <div style="padding: 14px; background: rgba(245, 158, 11, 0.1); border-radius: 10px; border: 1px solid rgba(245, 158, 11, 0.3);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-size: 13px; font-weight: 600; color: #f8fafc;">åº”æ€¥åŸºé‡‘</span>
                <span style="font-size: 11px; color: #64748b;">6ä¸ªæœˆæ”¯å‡º</span>
              </div>
              <div style="height: 8px; background: #334155; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                <div style="width: 80%; height: 100%; background: linear-gradient(90deg, #f59e0b, #fbbf24); border-radius: 4px;"></div>
              </div>
              <div style="display: flex; justify-content: space-between; font-size: 11px;">
                <span style="color: #f59e0b;">å·²å¤‡ Â¥--</span>
                <span style="color: #4ade80;">æ¥è¿‘è¾¾æˆ</span>
              </div>
            </div>
          </div>
        </div>

        <!-- æ”¶æ”¯ç›‘æ§ -->
        <div class="plan-block" style="margin-bottom: 16px;">
          <p class="plan-title" style="margin: 0 0 12px;">æœ¬æœˆæ”¶æ”¯</p>
          <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
            <div style="flex: 1; min-width: 100px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: #64748b;">æ”¶å…¥</div>
              <div style="font-size: 18px; font-weight: 700; color: #22c55e;">Â¥ --</div>
            </div>
            <div style="flex: 1; min-width: 100px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: #64748b;">æ”¯å‡º</div>
              <div style="font-size: 18px; font-weight: 700; color: #ef4444;">Â¥ --</div>
            </div>
            <div style="flex: 1; min-width: 100px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; text-align: center;">
              <div style="font-size: 11px; color: #64748b;">ç»“ä½™</div>
              <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">Â¥ --</div>
            </div>
          </div>
          <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">æ”¯å‡ºåˆ†ç±»</div>
          <div style="display: flex; flex-direction: column; gap: 6px;">
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(239, 68, 68, 0.05); border-radius: 6px;">
              <span style="width: 20px; text-align: center;">ğŸœ</span>
              <span style="flex: 1; font-size: 13px; color: #e2e8f0;">é¤é¥®</span>
              <span style="font-size: 13px; color: #ef4444;">Â¥ --</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(239, 68, 68, 0.03); border-radius: 6px;">
              <span style="width: 20px; text-align: center;">ğŸ </span>
              <span style="flex: 1; font-size: 13px; color: #e2e8f0;">æˆ¿ç§Ÿ</span>
              <span style="font-size: 13px; color: #f87171;">Â¥ --</span>
            </div>
            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: rgba(239, 68, 68, 0.02); border-radius: 6px;">
              <span style="width: 20px; text-align: center;">ğŸš—</span>
              <span style="flex: 1; font-size: 13px; color: #e2e8f0;">äº¤é€š</span>
              <span style="font-size: 13px; color: #fca5a5;">Â¥ --</span>
            </div>
          </div>
        </div>

        <!-- è¿­ä»£æ–¹å‘ -->
        <div class="plan-block" style="margin-top: 20px;">
          <p class="plan-title" style="margin: 0 0 6px;">è¿­ä»£æ–¹å‘</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>å½“å‰è´¢äº§é…ç½®</li>
              <li>ç†è´¢äº§å“æ”¶ç›Šç›‘æ§</li>
              <li>è·ç¦»ä¹°è½¦ä¹°æˆ¿ç›®æ ‡çš„è¾¾æˆæ—¶é—´ä¼°ç®—</li>
              <li>æ—¥æ¶ˆè´¹ç›‘æ§</li>
            </ul>
          </div>
        </div>
      </section>
      <!-- AIå’¨è¯¢ TAB -->
      <section class="tab-panel" id="tab-ai-news">
        <div class="plan-block">
          <p class="plan-title" style="margin: 0 0 6px;">Highlight</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>æ¯æœˆæ±‡æ€»å„å¤§AIäº§å“çš„é‡å¤§çªç ´ä¸å®ç”¨æŠ€å·§</li>
            </ul>
          </div>
        </div>
        
        <!-- æœ¬æœˆAIåŠ¨æ€ -->
        <div class="plan-block" style="margin-top: 16px;">
          <p class="plan-title" style="margin: 0 0 12px;">æœ¬æœˆAIäº§å“åŠ¨æ€</p>
          
          <!-- OpenAI -->
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border-left: 3px solid #10b981;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-weight: 600; color: #10b981;">OpenAI</span>
              <span style="font-size: 11px; color: #64748b; background: #1e293b; padding: 2px 8px; border-radius: 4px;">ChatGPT / GPT-4</span>
            </div>
            <ul class="plan-list" style="margin: 0; font-size: 13px;">
              <li>æ•°æ®å¾…æ¥å…¥...</li>
            </ul>
          </div>
          
          <!-- Anthropic -->
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #8b5cf6;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-weight: 600; color: #8b5cf6;">Anthropic</span>
              <span style="font-size: 11px; color: #64748b; background: #1e293b; padding: 2px 8px; border-radius: 4px;">Claude</span>
            </div>
            <ul class="plan-list" style="margin: 0; font-size: 13px;">
              <li>æ•°æ®å¾…æ¥å…¥...</li>
            </ul>
          </div>
          
          <!-- Google -->
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; border-left: 3px solid #3b82f6;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-weight: 600; color: #3b82f6;">Google</span>
              <span style="font-size: 11px; color: #64748b; background: #1e293b; padding: 2px 8px; border-radius: 4px;">Gemini</span>
            </div>
            <ul class="plan-list" style="margin: 0; font-size: 13px;">
              <li>æ•°æ®å¾…æ¥å…¥...</li>
            </ul>
          </div>
          
          <!-- å›½äº§å¤§æ¨¡å‹ -->
          <div style="margin-bottom: 16px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 3px solid #ef4444;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-weight: 600; color: #ef4444;">å›½äº§å¤§æ¨¡å‹</span>
              <span style="font-size: 11px; color: #64748b; background: #1e293b; padding: 2px 8px; border-radius: 4px;">æ–‡å¿ƒ / é€šä¹‰ / è±†åŒ… / Kimi</span>
            </div>
            <ul class="plan-list" style="margin: 0; font-size: 13px;">
              <li>æ•°æ®å¾…æ¥å…¥...</li>
            </ul>
          </div>
        </div>
        
        <!-- å®ç”¨Tips -->
        <div class="plan-block" style="margin-top: 16px;">
          <p class="plan-title" style="margin: 0 0 12px;">æœ¬æœˆå®ç”¨Tips</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 12px;">
            <div style="padding: 12px; background: #1e293b; border-radius: 8px;">
              <div style="font-size: 12px; color: #f59e0b; margin-bottom: 6px;">PromptæŠ€å·§</div>
              <p style="font-size: 13px; color: #e2e8f0; margin: 0;">æ•°æ®å¾…æ¥å…¥...</p>
            </div>
            <div style="padding: 12px; background: #1e293b; border-radius: 8px;">
              <div style="font-size: 12px; color: #06b6d4; margin-bottom: 6px;">æ•ˆç‡å·¥å…·</div>
              <p style="font-size: 13px; color: #e2e8f0; margin: 0;">æ•°æ®å¾…æ¥å…¥...</p>
            </div>
            <div style="padding: 12px; background: #1e293b; border-radius: 8px;">
              <div style="font-size: 12px; color: #ec4899; margin-bottom: 6px;">åˆ›æ„åº”ç”¨</div>
              <p style="font-size: 13px; color: #e2e8f0; margin: 0;">æ•°æ®å¾…æ¥å…¥...</p>
            </div>
          </div>
        </div>
        
        <p style="margin-top: 16px; color: #64748b; font-size: 13px;">æ•°æ®æ¥æºå¾…æ¥å…¥ï¼Œæ•¬è¯·æœŸå¾…ã€‚</p>

        <!-- è¿­ä»£æ–¹å‘ -->
        <div class="plan-block" style="margin-top: 20px;">
          <p class="plan-title" style="margin: 0 0 6px;">è¿­ä»£æ–¹å‘</p>
          <div class="plan-section">
            <ul class="plan-list">
              <li>æ¥å…¥ï¼šAIäº§å“æ›´æ–°RSSè®¢é˜…</li>
              <li>æ¥å…¥ï¼šAIè®ºæ–‡çƒ­ç‚¹è¿½è¸ª</li>
              <li>å¾…è§„åˆ’ï¼šå¤§æ¨¡å‹è‡ªåŠ¨æ€»ç»“æœ¬æœˆAIé¢†åŸŸåŠ¨æ€</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
    <script>
      const statusEl = document.getElementById("status");
      const updateTimeEl = document.getElementById("update-time");
      const headRow = document.getElementById("table-head");
      const bodyEl = document.getElementById("table-body");
      const categoryGroup = document.getElementById("category-group");
      const limitInput = document.getElementById("limit-input");
      const tabButtons = document.querySelectorAll(".tab-button");
      const tabPanels = document.querySelectorAll(".tab-panel");
      const healthStatus = document.getElementById("health-status");
      const metricTableBody = document.getElementById("health-metric-body");
      const healthCategoryGroup = document.getElementById("health-category-group");
      const highlightEls = {
        weight: document.getElementById("hl-weight"),
        weightWow: document.getElementById("hl-weight-wow"),
        bodyFat: document.getElementById("hl-bodyfat"),
        bodyFatWow: document.getElementById("hl-bodyfat-wow"),
        sleep: document.getElementById("hl-sleep"),
        sleepWow: document.getElementById("hl-sleep-wow"),
        bedTime: document.getElementById("hl-bedtime"),
        bedTimeWow: document.getElementById("hl-bedtime-wow"),
        wakeTime: document.getElementById("hl-wake"),
        wakeTimeWow: document.getElementById("hl-wake-wow"),
        hrv: document.getElementById("hl-hrv"),
        hrvWow: document.getElementById("hl-hrv-wow"),
        exerciseWeek: document.getElementById("hl-ex-week"),
        exerciseMonth: document.getElementById("hl-ex-month"),
        exerciseMsg: document.getElementById("hl-ex-msg"),
      };

      const CATEGORY_OPTIONS = ["å…¨éƒ¨", "è¶…ä¼˜è´¨", "å†å²åŒº", "åˆ›æ„åŒº", "è¿åŠ¨åŒº", "æ¸¸æˆåŒº", "å½±è§†ç»¼", "æ•°åˆ†"];
      const DEFAULT_CATEGORY = "è¶…ä¼˜è´¨";
      const DEFAULT_LIMIT = 1;
      const MAX_LIMIT = 10;
      const CSV_SOURCES = [{ url: "video/video_ls.csv", label: "Local" }];
      const HEALTH_SOURCES = [{ url: "health/data/sleep_daily.csv", label: "Local" }];
      const WEIGHT_SOURCES = [{ url: "health/data/weight_daily.csv", label: "Local" }];
      const STEPS_SOURCES = [{ url: "health/data/steps_daily.csv", label: "Local" }];
      const ENERGY_SOURCES = [{ url: "health/data/energy_daily.csv", label: "Local" }];
      const DIET_SOURCES = [
        { url: "health/data/diet_daily.csv", label: "Local" },
      ];
      const HR_SOURCES = [
        { url: "health/data/heart_rate_daily.csv", label: "Local" },
      ];
      const REST_HR_SOURCES = [
        { url: "health/data/resting_hr_daily.csv", label: "Local" },
      ];
      const WALK_HR_SOURCES = [
        { url: "health/data/walking_hr_daily.csv", label: "Local" },
      ];
      const RESP_SOURCES = [
        { url: "health/data/respiratory_daily.csv", label: "Local" },
      ];
      const VO2_SOURCES = [
        { url: "health/data/vo2max_daily.csv", label: "Local" },
      ];
      const WALK_METRIC_SOURCES = [
        { url: "health/data/walking_metrics_daily.csv", label: "Local" },
      ];
      const WALK_STEP_LEN_SOURCES = [
        { url: "health/data/walking_step_length_daily.csv", label: "Local" },
      ];
      const WALK_DS_SOURCES = [
        { url: "health/data/walking_double_support_daily.csv", label: "Local" },
      ];
      const WALK_ASYM_SOURCES = [
        { url: "health/data/walking_asymmetry_daily.csv", label: "Local" },
      ];
      const WALK_STEADY_SOURCES = [
        { url: "health/data/walking_steadiness_daily.csv", label: "Local" },
      ];
      const RUN_SPEED_SOURCES = [
        { url: "health/data/running_speed_daily.csv", label: "Local" },
      ];
      const RUN_POWER_SOURCES = [
        { url: "health/data/running_power_daily.csv", label: "Local" },
      ];
      const RUN_VERT_SOURCES = [
        { url: "health/data/running_vertical_osc_daily.csv", label: "Local" },
      ];
      const RUN_GC_SOURCES = [
        { url: "health/data/running_ground_contact_daily.csv", label: "Local" },
      ];
      const RUN_STRIDE_SOURCES = [
        { url: "health/data/running_stride_length_daily.csv", label: "Local" },
      ];
      const STAIR_ASC_SOURCES = [
        { url: "health/data/stair_ascent_speed_daily.csv", label: "Local" },
      ];
      const STAIR_DESC_SOURCES = [
        { url: "health/data/stair_descent_speed_daily.csv", label: "Local" },
      ];
      const AUDIO_ENV_SOURCES = [
        { url: "health/data/audio_exposure_daily.csv", label: "Local" },
      ];
      const AUDIO_HEAD_SOURCES = [
        { url: "health/data/headphone_audio_daily.csv", label: "Local" },
      ];
      const EXERCISE_SOURCES = [
        { url: "health/data/exercise_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/exercise_daily.csv", label: "GitHub Raw" },
      ];
      const DISTANCE_SOURCES = [
        { url: "health/data/distance_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/distance_daily.csv", label: "GitHub Raw" },
      ];
      const RESTING_HR_SOURCES = [
        { url: "health/data/resting_hr_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/resting_hr_daily.csv", label: "GitHub Raw" },
      ];
      const BODY_SOURCES = [
        { url: "health/data/body_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/body_daily.csv", label: "GitHub Raw" },
      ];
      const HEART_RATE_SOURCES = [
        { url: "health/data/heart_rate_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/heart_rate_daily.csv", label: "GitHub Raw" },
      ];
      const HRV_SOURCES = [
        { url: "health/data/hrv_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/hrv_daily.csv", label: "GitHub Raw" },
      ];
      const RESPIRATORY_SOURCES = [
        { url: "health/data/respiratory_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/respiratory_daily.csv", label: "GitHub Raw" },
      ];
      const SPO2_SOURCES = [
        { url: "health/data/spo2_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/spo2_daily.csv", label: "GitHub Raw" },
      ];
      const VO2MAX_SOURCES = [
        { url: "health/data/vo2max_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/vo2max_daily.csv", label: "GitHub Raw" },
      ];
      const FLIGHTS_SOURCES = [
        { url: "health/data/flights_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/flights_daily.csv", label: "GitHub Raw" },
      ];
      const DAYLIGHT_SOURCES = [
        { url: "health/data/daylight_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/daylight_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_HR_SOURCES = [
        { url: "health/data/walking_hr_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/walking_hr_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_METRICS_SOURCES = [
        { url: "health/data/walking_metrics_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/walking_metrics_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_STEP_LENGTH_SOURCES = [
        { url: "health/data/walking_step_length_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/walking_step_length_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_DOUBLE_SUPPORT_SOURCES = [
        { url: "health/data/walking_double_support_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/walking_double_support_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_ASYMMETRY_SOURCES = [
        { url: "health/data/walking_asymmetry_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/walking_asymmetry_daily.csv", label: "GitHub Raw" },
      ];
      const WALKING_STEADINESS_SOURCES = [
        { url: "health/data/walking_steadiness_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/walking_steadiness_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_SPEED_SOURCES = [
        { url: "health/data/running_speed_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/running_speed_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_POWER_SOURCES = [
        { url: "health/data/running_power_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/running_power_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_STRIDE_LENGTH_SOURCES = [
        { url: "health/data/running_stride_length_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/running_stride_length_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_VERTICAL_OSC_SOURCES = [
        { url: "health/data/running_vertical_osc_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/running_vertical_osc_daily.csv", label: "GitHub Raw" },
      ];
      const RUNNING_GROUND_CONTACT_SOURCES = [
        { url: "health/data/running_ground_contact_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/running_ground_contact_daily.csv", label: "GitHub Raw" },
      ];
      const STAIR_ASCENT_SPEED_SOURCES = [
        { url: "health/data/stair_ascent_speed_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/stair_ascent_speed_daily.csv", label: "GitHub Raw" },
      ];
      const STAIR_DESCENT_SPEED_SOURCES = [
        { url: "health/data/stair_descent_speed_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/stair_descent_speed_daily.csv", label: "GitHub Raw" },
      ];
      const AUDIO_EXPOSURE_SOURCES = [
        { url: "health/data/audio_exposure_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/audio_exposure_daily.csv", label: "GitHub Raw" },
      ];
      const HEADPHONE_AUDIO_SOURCES = [
        { url: "health/data/headphone_audio_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/headphone_audio_daily.csv", label: "GitHub Raw" },
      ];
      const SLEEP_TEMP_SOURCES = [
        { url: "health/data/sleep_temp_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/sleep_temp_daily.csv", label: "GitHub Raw" },
      ];
      const SLEEP_SCHEDULE_SOURCES = [
        { url: "health/data/sleep_schedule_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/sleep_schedule_daily.csv", label: "GitHub Raw" },
      ];
      const DISTANCE_CYCLING_SOURCES = [
        { url: "health/data/distance_daily.csv", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/health/data/distance_daily.csv", label: "GitHub Raw" },
      ];

      const METRIC_DEFS = [
        { label: "ç¡çœ æ—¶é•¿", valueKey: "sleep_hours", unit: "å°æ—¶", sources: HEALTH_SOURCES },
        { label: "ä½“é‡", valueKey: "weight_kg", unit: "kg", sources: WEIGHT_SOURCES },
        { label: "æ­¥æ•°", valueKey: "steps", unit: "æ­¥", sources: STEPS_SOURCES },
        { label: "ä¸»åŠ¨èƒ½é‡", valueKey: "active_energy", unit: "kcal", sources: ENERGY_SOURCES },
        { label: "åŸºç¡€ä»£è°¢", valueKey: "basal_energy", unit: "kcal", sources: ENERGY_SOURCES },
        { label: "èº«ä½“è´Ÿè·æŒ‡æ•°", valueKey: "physical_effort", unit: "AU", sources: ENERGY_SOURCES },
        { label: "é”»ç‚¼æ—¶é•¿", valueKey: "exercise_time_min", unit: "åˆ†é’Ÿ", sources: EXERCISE_SOURCES },
        { label: "ç«™ç«‹æ—¶é•¿", valueKey: "stand_time_min", unit: "åˆ†é’Ÿ", sources: EXERCISE_SOURCES },
        { label: "ç«™ç«‹å°æ—¶æ•°", valueKey: "stand_hours", unit: "å°æ—¶", sources: EXERCISE_SOURCES },
        { label: "æ­¥è¡Œè·‘æ­¥è·ç¦»", valueKey: "distance_walk_run_km", unit: "km", sources: DISTANCE_SOURCES },
        { label: "éª‘è¡Œè·ç¦»", valueKey: "distance_cycling_km", unit: "km", sources: DISTANCE_CYCLING_SOURCES },
        { label: "çˆ¬æ¥¼å±‚æ•°", valueKey: "flights_climbed", unit: "å±‚", sources: FLIGHTS_SOURCES },
        { label: "æˆ·å¤–æ—¥ç…§æ—¶é•¿", valueKey: "time_in_daylight_min", unit: "åˆ†é’Ÿ", sources: DAYLIGHT_SOURCES },
        { label: "é™æ¯å¿ƒç‡", valueKey: "resting_hr_avg", unit: "bpm", sources: RESTING_HR_SOURCES },
        { label: "å¿ƒç‡å‡å€¼", valueKey: "hr_avg", unit: "bpm", sources: HEART_RATE_SOURCES },
        { label: "å¿ƒç‡æœ€å°å€¼", valueKey: "hr_min", unit: "bpm", sources: HEART_RATE_SOURCES },
        { label: "å¿ƒç‡æœ€å¤§å€¼", valueKey: "hr_max", unit: "bpm", sources: HEART_RATE_SOURCES },
        { label: "æ­¥è¡Œå¿ƒç‡å‡å€¼", valueKey: "walk_hr_avg", unit: "bpm", sources: WALKING_HR_SOURCES },
        { label: "HRV-SDNNå‡å€¼", valueKey: "sdnn_avg", unit: "ms", sources: HRV_SOURCES },
        { label: "å‘¼å¸é¢‘ç‡å‡å€¼", valueKey: "resp_avg", unit: "æ¬¡/åˆ†", sources: RESPIRATORY_SOURCES },
        { label: "è¡€æ°§å‡å€¼", valueKey: "spo2_avg", unit: "%", sources: SPO2_SOURCES },
        { label: "æœ€å¤§æ‘„æ°§é‡å‡å€¼", valueKey: "vo2max_avg", unit: "mlÂ·kgâ»Â¹Â·minâ»Â¹", sources: VO2MAX_SOURCES },
        { label: "BMI", valueKey: "bmi", unit: "", sources: BODY_SOURCES },
        { label: "ä½“è„‚ç‡", valueKey: "body_fat_pct", unit: "%", sources: BODY_SOURCES },
        { label: "å»è„‚ä½“é‡", valueKey: "lean_mass_kg", unit: "kg", sources: BODY_SOURCES },
        { label: "è¡Œèµ°é€Ÿåº¦å‡å€¼", valueKey: "walking_speed_avg", unit: "m/s", sources: WALKING_METRICS_SOURCES },
        { label: "æ­¥é•¿å‡å€¼", valueKey: "step_length_avg", unit: "cm", sources: WALKING_STEP_LENGTH_SOURCES },
        { label: "åŒæ”¯æ’‘å æ¯”å‡å€¼", valueKey: "double_support_pct_avg", unit: "%", sources: WALKING_DOUBLE_SUPPORT_SOURCES },
        { label: "æ­¥æ€ä¸å¯¹ç§°å‡å€¼", valueKey: "asymmetry_pct_avg", unit: "%", sources: WALKING_ASYMMETRY_SOURCES },
        { label: "æ­¥æ€ç¨³å®šåº¦å‡å€¼", valueKey: "steady_avg", unit: "åˆ†", sources: WALKING_STEADINESS_SOURCES },
        { label: "è·‘æ­¥é€Ÿåº¦å‡å€¼", valueKey: "running_speed_avg", unit: "m/s", sources: RUNNING_SPEED_SOURCES },
        { label: "è·‘æ­¥åŠŸç‡å‡å€¼", valueKey: "running_power_avg", unit: "W", sources: RUNNING_POWER_SOURCES },
        { label: "è·‘æ­¥æ­¥å¹…å‡å€¼", valueKey: "running_stride_len_avg", unit: "m", sources: RUNNING_STRIDE_LENGTH_SOURCES },
        { label: "è·‘æ­¥å‚ç›´æŒ¯å¹…å‡å€¼", valueKey: "running_vertical_osc_avg", unit: "cm", sources: RUNNING_VERTICAL_OSC_SOURCES },
        { label: "ç€åœ°æ—¶é—´å‡å€¼", valueKey: "ground_contact_ms_avg", unit: "ms", sources: RUNNING_GROUND_CONTACT_SOURCES },
        { label: "ä¸Šæ¥¼é€Ÿåº¦å‡å€¼", valueKey: "stair_ascent_speed_avg", unit: "m/s", sources: STAIR_ASCENT_SPEED_SOURCES },
        { label: "ä¸‹æ¥¼é€Ÿåº¦å‡å€¼", valueKey: "stair_descent_speed_avg", unit: "m/s", sources: STAIR_DESCENT_SPEED_SOURCES },
        { label: "ç¯å¢ƒå™ªå£°å‡å€¼", valueKey: "env_audio_avg", unit: "dB", sources: AUDIO_EXPOSURE_SOURCES },
        { label: "è€³æœºéŸ³é‡å‡å€¼", valueKey: "headphone_audio_avg", unit: "dB", sources: HEADPHONE_AUDIO_SOURCES },
        { label: "ç¡çœ æ‰‹è…•æ¸©åº¦å‡å€¼", valueKey: "temp_avg", unit: "Â°C", sources: SLEEP_TEMP_SOURCES },
      ];

      const HIGHLIGHT_EXTRA_DEFS = [
        { label: "å…¥ç¡æ—¶é—´", valueKey: "bed_time", unit: "", sources: SLEEP_SCHEDULE_SOURCES },
        { label: "èµ·åºŠæ—¶é—´", valueKey: "wake_time", unit: "", sources: SLEEP_SCHEDULE_SOURCES },
        { label: "æœ¬å‘¨è¿åŠ¨å¤©æ•°", valueKey: "exercise_days", unit: "å¤©", sources: EXERCISE_SOURCES },
        { label: "æœ¬æœˆè¿åŠ¨å¤©æ•°", valueKey: "exercise_days", unit: "å¤©", sources: EXERCISE_SOURCES },
      ];

      const EXERCISE_DAY_THRESHOLD_MIN = 30;

      const HEALTH_METRIC_CONFIG_SOURCES = [
        { url: "config/health_metrics.json", label: "Local" },
        { url: "https://raw.githubusercontent.com/xujl1999/Key-Data-Management/main/config/health_metrics.json", label: "GitHub Raw" },
      ];

      const DEFAULT_HEALTH_METRIC_CATEGORY = "åŸºç¡€ä½“å¾";
      let healthMetricDefs = METRIC_DEFS.slice();
      let healthMetricCategories = ["å…¨éƒ¨"];
      let activeHealthMetricCategory = DEFAULT_HEALTH_METRIC_CATEGORY;
      let metricRows = [];

      let records = [];
      let activeCategory = CATEGORY_OPTIONS.includes(DEFAULT_CATEGORY) ? DEFAULT_CATEGORY : CATEGORY_OPTIONS[0];

      const fallbackHeader = (text, index) => {
        if (text && text.trim()) return text.trim();
        return index === 0 ? "id" : `col_${index}`;
      };

      const parseCSV = (text) => {
        const rows = [];
        let current = "";
        let row = [];
        let inQuotes = false;

        for (let i = 0; i < text.length; i++) {
          const char = text[i];
          const next = text[i + 1];

          if (char === "\r" && next === "\n" && !inQuotes) {
            continue;
          }

          if (char === "\n" && !inQuotes) {
            row.push(current);
            rows.push(row);
            row = [];
            current = "";
            continue;
          }

          if (char === '"') {
            if (inQuotes && next === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
            continue;
          }

          if (char === "," && !inQuotes) {
            row.push(current);
            current = "";
            continue;
          }

          current += char;
        }

        if (current.length > 0 || row.length) {
          row.push(current);
          rows.push(row);
        }

        return rows.filter((cells) => cells.some((cell) => cell.trim().length));
      };

      const normalizeKey = (text) => text.trim().toLowerCase();

      const parseDate = (text) => {
        const d = new Date(text);
        return Number.isNaN(d.getTime()) ? null : d;
      };

      const createCell = (tag, text, linkHref = "") => {
        const cell = document.createElement(tag);
        if (linkHref && text) {
          const link = document.createElement("a");
          link.href = linkHref;
          link.target = "_blank";
          link.rel = "noopener";
          link.textContent = text;
          cell.appendChild(link);
        } else {
          cell.textContent = text || "";
        }
        return cell;
      };

      const parsePublishDate = (text) => {
        if (!text) return 0;
        const now = new Date();
        const cleaned = text.trim();
        if (!cleaned) return 0;

        const normalized = cleaned.replace(/\./g, "-");
        const direct = Date.parse(normalized);
        if (!Number.isNaN(direct)) {
          return direct;
        }

        const mmddPattern = /^(\d{1,2})-(\d{1,2})(?:\s+(\d{1,2}):(\d{2}))?$/;
        const mmddMatch = cleaned.match(mmddPattern);
        if (mmddMatch) {
          const year = now.getFullYear();
          const month = parseInt(mmddMatch[1], 10) - 1;
          const day = parseInt(mmddMatch[2], 10);
          const hour = mmddMatch[3] ? parseInt(mmddMatch[3], 10) : 0;
          const minute = mmddMatch[4] ? parseInt(mmddMatch[4], 10) : 0;
          const guessed = new Date(year, month, day, hour, minute);
          if (guessed > now) {
            guessed.setFullYear(year - 1);
          }
          return guessed.getTime();
        }

        const relHour = cleaned.match(/^(\d+)\s*å°æ—¶å‰$/);
        if (relHour) {
          const diff = parseInt(relHour[1], 10);
          const d = new Date(now);
          d.setHours(d.getHours() - diff);
          return d.getTime();
        }

        const relMinute = cleaned.match(/^(\d+)\s*åˆ†é’Ÿå‰$/);
        if (relMinute) {
          const diff = parseInt(relMinute[1], 10);
          const d = new Date(now);
          d.setMinutes(d.getMinutes() - diff);
          return d.getTime();
        }

        const yesterdayMatch = cleaned.match(/^æ˜¨å¤©(?:\s+(\d{1,2}):(\d{2}))?$/);
        if (yesterdayMatch) {
          const d = new Date(now);
          d.setDate(d.getDate() - 1);
          const hour = yesterdayMatch[1] ? parseInt(yesterdayMatch[1], 10) : 0;
          const minute = yesterdayMatch[2] ? parseInt(yesterdayMatch[2], 10) : 0;
          d.setHours(hour, minute, 0, 0);
          return d.getTime();
        }

        const todayTime = cleaned.match(/^(\d{1,2}):(\d{2})$/);
        if (todayTime) {
          const d = new Date(now);
          d.setHours(parseInt(todayTime[1], 10), parseInt(todayTime[2], 10), 0, 0);
          return d.getTime();
        }

        if (cleaned === "åˆšåˆš") {
          return now.getTime();
        }

        return 0;
      };

      const ensureLimitValue = () => {
        if (!limitInput) return DEFAULT_LIMIT;
        let value = parseInt(limitInput.value, 10);
        if (Number.isNaN(value) || value < 1) {
          value = DEFAULT_LIMIT;
        }
        value = Math.min(value, MAX_LIMIT);
        limitInput.value = value;
        return value;
      };

      const initLimitSelect = () => {
        if (!limitInput) return;
        limitInput.innerHTML = "";
        for (let i = 1; i <= MAX_LIMIT; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          if (i === DEFAULT_LIMIT) {
            option.selected = true;
          }
          limitInput.appendChild(option);
        }
      };

      const switchTab = (target) => {
        tabButtons.forEach((button) => {
          button.classList.toggle("tab-button--active", button.dataset.tab === target);
        });
        tabPanels.forEach((panel) => {
          panel.classList.toggle("tab-panel--active", panel.id === `tab-${target}`);
        });
      };

      const renderLineChart = (container, data, options = {}) => {
        container.innerHTML = "";
        if (!data.length) {
          container.textContent = "æš‚æ— æ•°æ®";
          return;
        }
        const width = options.width || 800;
        const height = options.height || 280;
        const padding = 30;

        const xs = data.map((_, idx) => idx);
        const ys = data.map((d) => d.value);
        const minY = Math.min(...ys, 0);
        const maxY = Math.max(...ys, 1);
        const yRange = maxY - minY || 1;

        const scaleX = (x) =>
          padding + (x / Math.max(xs.length - 1, 1)) * (width - padding * 2);
        const scaleY = (y) =>
          height - padding - ((y - minY) / yRange) * (height - padding * 2);

        const points = data.map((d, idx) => `${scaleX(idx)},${scaleY(d.value)}`).join(" ");

        const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
        svg.setAttribute("width", "100%");
        svg.setAttribute("height", "320");

        // Axes (minimal)
        const axis = document.createElementNS("http://www.w3.org/2000/svg", "line");
        axis.setAttribute("x1", padding);
        axis.setAttribute("y1", scaleY(minY));
        axis.setAttribute("x2", width - padding);
        axis.setAttribute("y2", scaleY(minY));
        axis.setAttribute("stroke", "rgba(148,163,184,0.4)");
        axis.setAttribute("stroke-width", "1");
        svg.appendChild(axis);

        const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        polyline.setAttribute("points", points);
        polyline.setAttribute("fill", "none");
        polyline.setAttribute("stroke", options.color || "#60a5fa");
        polyline.setAttribute("stroke-width", "2");
        svg.appendChild(polyline);

        // Labels (first/last)
        const addLabel = (text, x, y) => {
          const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
          t.setAttribute("x", x);
          t.setAttribute("y", y);
          t.setAttribute("fill", "#cbd5f5");
          t.setAttribute("font-size", "12");
          t.textContent = text;
          svg.appendChild(t);
        };

        if (data.length) {
          addLabel(data[0].label, scaleX(0), height - padding + 14);
          addLabel(data[data.length - 1].label, scaleX(data.length - 1) - 20, height - padding + 14);
          addLabel(maxY.toFixed(1), padding, scaleY(maxY) - 6);
          addLabel(minY.toFixed(1), padding, scaleY(minY) + 14);
        }

        container.appendChild(svg);
      };

      const renderCategoryChips = () => {
        if (!categoryGroup) return;
        categoryGroup.innerHTML = "";
        CATEGORY_OPTIONS.forEach((label) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = `chip${label === activeCategory ? " chip--active" : ""}`;
          chip.textContent = label;
          chip.addEventListener("click", () => {
            if (activeCategory === label) return;
            activeCategory = label;
            renderCategoryChips();
            applyFilters();
          });
          categoryGroup.appendChild(chip);
        });
      };

      const buildRecords = (rows) => {
        if (!rows.length) return [];
        const headers = rows[0].map(fallbackHeader).map(normalizeKey);
        return rows.slice(1).map((row) => {
          const record = {};
          headers.forEach((key, idx) => {
            record[key] = (row[idx] || "").trim();
          });
          record._timestamp = parsePublishDate(record.publish_date || record["publish_date"]);
          return record;
        });
      };

      const renderHeader = () => {
        if (!headRow) return;
        headRow.innerHTML = "";
        ["ä½œè€…", "è§†é¢‘å‘å¸ƒæ—¶é—´", "è§†é¢‘åç§°"].forEach((text) => {
          headRow.appendChild(createCell("th", text));
        });
      };

      const renderBody = (rows) => {
        if (!bodyEl) return;
        bodyEl.innerHTML = "";
        if (!rows.length) {
          const tr = document.createElement("tr");
          const cell = document.createElement("td");
          cell.colSpan = 3;
          cell.textContent = "æš‚æ— æ•°æ®";
          tr.appendChild(cell);
          bodyEl.appendChild(tr);
          return;
        }

        rows.forEach((item) => {
          const tr = document.createElement("tr");
          tr.appendChild(createCell("td", item.author || "-"));
          tr.appendChild(createCell("td", item.publish_date || "-"));
          tr.appendChild(createCell("td", item.title || "", item.url || ""));
          bodyEl.appendChild(tr);
        });
      };

      const applyFilters = () => {
        if (!records.length) {
          renderBody([]);
          statusEl.textContent = "æš‚æ— æ•°æ®";
          return;
        }

        const limit = ensureLimitValue();
        const authorCounts = new Map();
        const authorSet = new Set();
        const rows = [];

        records.forEach((record) => {
          const category = record.category || record["category"] || "";
          if (!record.author || !record.title) return;
          if (activeCategory !== "å…¨éƒ¨" && category !== activeCategory) return;

          const used = authorCounts.get(record.author) || 0;
          if (used >= limit) return;

          authorCounts.set(record.author, used + 1);
          authorSet.add(record.author);
          rows.push(record);
        });

        rows.sort((a, b) => (b._timestamp || 0) - (a._timestamp || 0));

        renderBody(rows);

        if (rows.length) {
          statusEl.textContent = `ç­›é€‰ï¼š${activeCategory} Â· ä½œè€… ${authorSet.size} ä½ï¼Œå…± ${rows.length} æ¡ï¼ˆæ¯ä½æœ€å¤š ${limit} æ¡ï¼‰`;
        } else {
          statusEl.textContent = "æš‚æ— åŒ¹é…æ•°æ®";
        }
      };

      if (limitInput) {
        limitInput.addEventListener("change", () => {
          ensureLimitValue();
          applyFilters();
        });
      }

      tabButtons.forEach((button) => {
        button.addEventListener("click", () => switchTab(button.dataset.tab));
      });

      const formatUpdateTime = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        return ` ${year}-${month}-${day} ${hours}:${minutes}`;
      };

      const isSameOrigin = (url) => {
        try {
          const absolute = new URL(url, window.location.href);
          return absolute.origin === window.location.origin;
        } catch (error) {
          console.warn("Invalid URL for origin check", url, error);
          return false;
        }
      };

      const resolveLastModified = async (response, url) => {
        const headerValue = response.headers.get("Last-Modified");
        if (headerValue) {
          const parsed = new Date(headerValue);
          if (!Number.isNaN(parsed.getTime())) {
            return parsed;
          }
        }
        if (!isSameOrigin(url)) {
          return null;
        }
        try {
          const headResp = await fetch(url, { method: "HEAD", cache: "no-store" });
          if (headResp.ok) {
            const headValue = headResp.headers.get("Last-Modified");
            if (headValue) {
              const fallback = new Date(headValue);
              if (!Number.isNaN(fallback.getTime())) {
                return fallback;
              }
            }
          }
        } catch (error) {
          console.warn("HEAD request failed", error);
        }
        return null;
      };


      const avgWindow = (series, count, offset = 0) => {
        if (series.length < count + offset) return null;
        const slice = series.slice(series.length - count - offset, series.length - offset);
        const total = slice.reduce((acc, cur) => acc + cur.ma, 0);
        return total / slice.length;
      };

      const formatDelta = (current, previous) => {
        if (current === null || previous === null || previous === 0) return { text: "â€”", cls: "" };
        const delta = ((current - previous) / previous) * 100;
        const cls = delta > 0 ? "positive" : delta < 0 ? "negative" : "";
        const sign = delta > 0 ? "+" : "";
        return { text: `${sign}${delta.toFixed(1)}%`, cls };
      };

      const fetchFromSources = async (sourceList) => {
        const errors = [];
        for (const source of sourceList) {
          try {
            const response = await fetch(source.url, { cache: "no-store" });
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const text = await response.text();
            return { text, sourceLabel: source.label };
          } catch (error) {
            errors.push(`${source.label}: ${error.message}`);
          }
        }
        throw new Error(errors.join(" | "));
      };

      const fetchJsonFromSources = async (sourceList) => {
        const { text, sourceLabel } = await fetchFromSources(sourceList);
        try {
          return JSON.parse(text);
        } catch (error) {
          throw new Error(`${sourceLabel}: JSON è§£æå¤±è´¥`);
        }
      };

      const uniqueList = (list) => Array.from(new Set(list.filter(Boolean)));

      const applyHealthMetricConfig = (config) => {
        const configMetrics = Array.isArray(config?.metrics) ? config.metrics : [];
        const configMap = new Map();
        configMetrics.forEach((item) => {
          if (!item || !item.valueKey) return;
          const key = String(item.valueKey).trim();
          if (key) configMap.set(key, item);
        });

        const defs = METRIC_DEFS.map((def) => {
          const item = configMap.get(def.valueKey);
          return {
            ...def,
            category: item && item.category ? item.category : "æœªåˆ†ç±»",
            enabled: item ? item.enabled !== false : true,
          };
        });

        const categories =
          Array.isArray(config?.categories) && config.categories.length
            ? config.categories.filter((item) => typeof item === "string" && item.trim())
            : uniqueList(defs.map((def) => def.category));

        return { defs, categories };
      };

      const renderHealthCategoryChips = () => {
        if (!healthCategoryGroup) return;
        healthCategoryGroup.innerHTML = "";
        healthMetricCategories.forEach((label) => {
          const chip = document.createElement("button");
          chip.type = "button";
          chip.className = `chip${label === activeHealthMetricCategory ? " chip--active" : ""}`;
          chip.textContent = label;
          chip.addEventListener("click", () => {
            if (activeHealthMetricCategory === label) return;
            activeHealthMetricCategory = label;
            renderHealthCategoryChips();
            applyHealthMetricFilters();
          });
          healthCategoryGroup.appendChild(chip);
        });
      };

      const loadHealthMetricConfig = async () => {
        try {
          const config = await fetchJsonFromSources(HEALTH_METRIC_CONFIG_SOURCES);
          const applied = applyHealthMetricConfig(config);
          healthMetricDefs = applied.defs;
          healthMetricCategories = applied.categories.length
            ? applied.categories
            : uniqueList(applied.defs.map((def) => def.category));
        } catch (error) {
          console.error("åŠ è½½å¥åº·æŒ‡æ ‡é…ç½®å¤±è´¥:", error);
          healthMetricDefs = METRIC_DEFS.map((def) => ({
            ...def,
            category: "æœªåˆ†ç±»",
            enabled: true,
          }));
          healthMetricCategories = uniqueList(healthMetricDefs.map((def) => def.category));
        }

        healthMetricCategories = uniqueList(["å…¨éƒ¨", ...healthMetricCategories]);
        if (healthMetricCategories.includes(DEFAULT_HEALTH_METRIC_CATEGORY)) {
          activeHealthMetricCategory = DEFAULT_HEALTH_METRIC_CATEGORY;
        } else if (!healthMetricCategories.includes(activeHealthMetricCategory)) {
          activeHealthMetricCategory = healthMetricCategories[0];
        }
        renderHealthCategoryChips();
      };

      const applyHealthMetricFilters = () => {
        const rows =
          activeHealthMetricCategory === "å…¨éƒ¨"
            ? metricRows
            : metricRows.filter((row) => row.category === activeHealthMetricCategory);
        renderMetricTable(rows);
      };

      const parseMetricSeries = (text, valueKey) => {
        const rows = parseCSV(text);
        if (!rows.length) return [];
        const headers = rows[0].map((h) => h.trim().toLowerCase());
        const idxDate = headers.indexOf("date");
        const idxVal = headers.indexOf(valueKey.toLowerCase());
        if (idxDate === -1 || idxVal === -1) return [];
        return rows
          .slice(1)
          .map((cells) => {
            const d = parseDate(cells[idxDate]);
            const v = parseFloat(cells[idxVal]);
            if (!d || Number.isNaN(v)) return null;
            return { date: d, value: v };
          })
          .filter(Boolean)
          .sort((a, b) => a.date - b.date);
      };

      const avgWindowByDate = (series, days, offsetDays = 0) => {
        if (!series.length) return null;
        const lastDate = series[series.length - 1].date;
        const end = new Date(lastDate);
        end.setHours(23, 59, 59, 999); // è®¾ç½®ä¸ºå½“å¤©çš„ç»“æŸæ—¶é—´
        end.setDate(end.getDate() - offsetDays);
        const start = new Date(end);
        start.setDate(start.getDate() - (days - 1));
        start.setHours(0, 0, 0, 0); // è®¾ç½®ä¸ºå¼€å§‹æ—¥æœŸçš„å¼€å§‹æ—¶é—´
        const window = series.filter((item) => {
          const itemDate = new Date(item.date);
          itemDate.setHours(0, 0, 0, 0);
          return itemDate >= start && itemDate <= end;
        });
        if (!window.length) return null;
        const total = window.reduce((acc, cur) => acc + cur.value, 0);
        return total / window.length;
      };

      const formatValueWithUnit = (val, unit) => {
        if (val === null || Number.isNaN(val)) return "--";
        const num = Number(val);
        // ä½“è„‚ç‡ï¼šå°†å°æ•°è½¬æ¢ä¸ºç™¾åˆ†æ¯”
        if (unit === "%" && num < 1) {
          return `${(num * 100).toFixed(1)}%`;
        }
        // ç©ºå•ä½ï¼šä¸æ˜¾ç¤ºå•ä½
        if (!unit || unit === "") {
          return num.toFixed(2);
        }
        // 3ä½æœ‰æ•ˆæ•°å­—ï¼šæ™ºèƒ½æ ¼å¼åŒ–ï¼ˆæ•´æ•°æˆ–åŒ…å«å°æ•°ç‚¹ï¼‰
        const formatted = formatThreeSignificantDigits(num);
        return `${formatted} ${unit}`;
      };

      const formatThreeSignificantDigits = (num) => {
        if (num === 0) return "0";
        const absNum = Math.abs(num);
        // å¦‚æœæ•°å€¼ >= 1000ï¼Œä¿ç•™æ•´æ•°éƒ¨åˆ†
        if (absNum >= 1000) {
          return Math.round(num).toString();
        }
        // å¦‚æœæ•°å€¼ < 1000ï¼Œä¿ç•™3ä½æœ‰æ•ˆæ•°å­—
        // å¦‚æœæ˜¯æ•´æ•°æˆ–æ¥è¿‘æ•´æ•°ï¼ˆå°æ•°éƒ¨åˆ†å°äº0.001ï¼‰ï¼Œæ˜¾ç¤ºæ•´æ•°
        if (Math.abs(num % 1) < 0.001) {
          return num.toString();
        }
        // å¦åˆ™ä½¿ç”¨3ä½æœ‰æ•ˆæ•°å­—
        return num.toPrecision(3);
      };

      const formatDeltaColored = (current, previous) => {
        if (current === null || previous === null || previous === 0) return "â€”";
        const delta = ((current - previous) / previous) * 100;
        // å˜åŒ–è¶…è¿‡5%æ‰æ ‡æ³¨é¢œè‰²ï¼Œå¦åˆ™ä½¿ç”¨é»˜è®¤é¢œè‰²
        const absDelta = Math.abs(delta);
        const cls = absDelta >= 5 ? (delta > 0 ? "delta-pos" : "delta-neg") : "";
        const sign = delta > 0 ? "+" : "";
        return `<span class="${cls}">${sign}${delta.toFixed(1)}%</span>`;
      };

      const formatDeltaSigned = (current, previous) => {
        if (current === null || previous === null || previous === 0) return "â€”";
        const delta = ((current - previous) / previous) * 100;
        const cls = delta > 0 ? "delta-pos" : delta < 0 ? "delta-neg" : "";
        const sign = delta > 0 ? "+" : "";
        return `<span class="${cls}">${sign}${delta.toFixed(1)}%</span>`;
      };

      const formatClock = (minutes, wrapOverMidnight = false) => {
        if (minutes === null || Number.isNaN(minutes)) return "--";
        let mins = minutes;
        if (wrapOverMidnight && mins >= 24 * 60) {
          mins -= 24 * 60;
        }
        mins = Math.round(mins);
        const hh = String(Math.floor(mins / 60) % 24).padStart(2, "0");
        const mm = String(mins % 60).padStart(2, "0");
        return `${hh}:${mm}`;
      };

      const parseClockToMinutes = (text) => {
        if (!text) return null;
        const cleaned = text.trim();
        if (!cleaned) return null;
        if (cleaned.includes(":")) {
          const parts = cleaned.split(":");
          const hh = parseInt(parts[0], 10);
          const mm = parseInt(parts[1], 10);
          if (Number.isNaN(hh) || Number.isNaN(mm)) return null;
          return hh * 60 + mm;
        }
        const num = parseFloat(cleaned);
        return Number.isNaN(num) ? null : num;
      };

      const isDirtySleepTime = (valueKey, minutes) => {
        if (minutes === null || Number.isNaN(minutes)) return true;
        if (valueKey !== "bed_time" && valueKey !== "wake_time") return false;
        return minutes >= 12 * 60 && minutes < 18 * 60;
      };

      const parseScheduleSeries = (text, valueKey) => {
        const rows = parseCSV(text);
        if (!rows.length) return [];
        const headers = rows[0].map((h) => h.trim().toLowerCase());
        const idxDate = headers.indexOf("date");
        const idxVal = headers.indexOf(valueKey.toLowerCase());
        if (idxDate === -1 || idxVal === -1) return [];
        return rows
          .slice(1)
          .map((cells) => {
            const d = parseDate(cells[idxDate]);
            const v = parseClockToMinutes(cells[idxVal]);
            if (!d || v === null) return null;
            if (isDirtySleepTime(valueKey, v)) return null;
            return { date: d, value: v };
          })
          .filter(Boolean)
          .sort((a, b) => a.date - b.date);
      };

      const normalizeBedtimeForAverage = (minutes) =>
        minutes < 12 * 60 ? minutes + 24 * 60 : minutes;

      const setHighlightValue = (el, value) => {
        if (!el) return;
        el.textContent = value;
      };

      const setHighlightDelta = (el, current, previous) => {
        if (!el) return;
        el.innerHTML = formatDeltaSigned(current, previous);
      };

      const loadHealthHighlight = async () => {
        // ä¸å†ä¾èµ– highlight å…ƒç´ ï¼Œä»ªè¡¨ç›˜æ•°æ®å§‹ç»ˆåŠ è½½
        const highlightWindow = 7;
        const highlightOffset = 7;
        const calcAvg = (series) => avgWindowByDate(series, highlightWindow, 0);
        const calcPrev = (series) => avgWindowByDate(series, highlightWindow, highlightOffset);
        const countWindowByDate = (series, days, offsetDays = 0) => {
          if (!series.length) return null;
          const lastDate = series[series.length - 1].date;
          const end = new Date(lastDate);
          end.setHours(23, 59, 59, 999);
          end.setDate(end.getDate() - offsetDays);
          const start = new Date(end);
          start.setDate(start.getDate() - (days - 1));
          start.setHours(0, 0, 0, 0);
          const window = series.filter((item) => {
            const itemDate = new Date(item.date);
            itemDate.setHours(0, 0, 0, 0);
            return itemDate >= start && itemDate <= end;
          });
          if (!window.length) return null;
          return window.reduce(
            (acc, cur) => acc + (cur.value >= EXERCISE_DAY_THRESHOLD_MIN ? 1 : 0),
            0
          );
        };

        try {
          const { text } = await fetchFromSources(BODY_SOURCES);
          const weightSeries = parseMetricSeries(text, "weight_kg");
          const fatSeries = parseMetricSeries(text, "body_fat_pct");

          const weightAvg = calcAvg(weightSeries);
          const weightPrev = calcPrev(weightSeries);
          const fatAvg = calcAvg(fatSeries);
          const fatPrev = calcPrev(fatSeries);

          setHighlightValue(highlightEls.weight, formatValueWithUnit(weightAvg, "kg"));
          setHighlightDelta(highlightEls.weightWow, weightAvg, weightPrev);
          setHighlightValue(highlightEls.bodyFat, formatValueWithUnit(fatAvg, "%"));
          setHighlightDelta(highlightEls.bodyFatWow, fatAvg, fatPrev);
          // æ›´æ–°å¯è§†åŒ–æ–¹æ¡ˆ
          updateVizPanels({ weight: weightAvg, weightPrev: weightPrev });
        } catch (error) {
          console.error("åŠ è½½ä½“é‡é«˜äº®å¤±è´¥:", error);
        }

        try {
          const { text } = await fetchFromSources(HEALTH_SOURCES);
          const sleepSeries = parseMetricSeries(text, "sleep_hours");
          const sleepAvg = calcAvg(sleepSeries);
          const sleepPrev = calcPrev(sleepSeries);
          setHighlightValue(highlightEls.sleep, formatValueWithUnit(sleepAvg, "å°æ—¶"));
          setHighlightDelta(highlightEls.sleepWow, sleepAvg, sleepPrev);
          // æ›´æ–°å¯è§†åŒ–æ–¹æ¡ˆ
          updateVizPanels({ sleep: sleepAvg, sleepPrev: sleepPrev });
        } catch (error) {
          console.error("åŠ è½½ç¡çœ é«˜äº®å¤±è´¥:", error);
        }

        try {
          const { text } = await fetchFromSources(SLEEP_SCHEDULE_SOURCES);
          const bedRaw = parseScheduleSeries(text, "bed_time");
          const wakeSeries = parseScheduleSeries(text, "wake_time");
          const bedSeries = bedRaw.map((item) => ({
            ...item,
            value: normalizeBedtimeForAverage(item.value),
          }));

          const bedAvg = calcAvg(bedSeries);
          const bedPrev = calcPrev(bedSeries);
          const wakeAvg = calcAvg(wakeSeries);
          const wakePrev = calcPrev(wakeSeries);

          setHighlightValue(highlightEls.bedTime, formatClock(bedAvg, true));
          setHighlightDelta(highlightEls.bedTimeWow, bedAvg, bedPrev);
          setHighlightValue(highlightEls.wakeTime, formatClock(wakeAvg, false));
          setHighlightDelta(highlightEls.wakeTimeWow, wakeAvg, wakePrev);
          // æ›´æ–°å¯è§†åŒ–æ–¹æ¡ˆ
          updateVizPanels({ bedTime: bedAvg, bedTimePrev: bedPrev, wakeTime: wakeAvg, wakeTimePrev: wakePrev });
        } catch (error) {
          console.error("åŠ è½½ç¡çœ ä½œæ¯é«˜äº®å¤±è´¥:", error);
        }

        try {
          const { text } = await fetchFromSources(HRV_SOURCES);
          const hrvSeries = parseMetricSeries(text, "sdnn_avg");
          const hrvAvg = calcAvg(hrvSeries);
          const hrvPrev = calcPrev(hrvSeries);
          setHighlightValue(highlightEls.hrv, formatValueWithUnit(hrvAvg, "ms"));
          setHighlightDelta(highlightEls.hrvWow, hrvAvg, hrvPrev);
          // æ›´æ–°å¯è§†åŒ–æ–¹æ¡ˆ
          updateVizPanels({ hrv: hrvAvg, hrvPrev: hrvPrev });
        } catch (error) {
          console.error("åŠ è½½ HRV é«˜äº®å¤±è´¥:", error);
        }

        try {
          const { text } = await fetchFromSources(EXERCISE_SOURCES);
          const exerciseSeries = parseMetricSeries(text, "exercise_time_min");
          const weekCount = countWindowByDate(exerciseSeries, 7, 0);
          const monthCount = countWindowByDate(exerciseSeries, 30, 0);
          setHighlightValue(highlightEls.exerciseWeek, weekCount === null ? "--" : weekCount);
          setHighlightValue(highlightEls.exerciseMonth, monthCount === null ? "--" : monthCount);
          const canRest = (weekCount || 0) >= 5 || (monthCount || 0) >= 21;
          setHighlightValue(highlightEls.exerciseMsg, canRest ? "ä»Šå¤©å¯ä»¥ä¼‘æ¯ï½" : "ä»Šå¤©è¦ç»§ç»­åŠ æ²¹");
          // æ›´æ–°å¯è§†åŒ–æ–¹æ¡ˆ
          updateVizPanels({ exerciseWeek: weekCount, exerciseMonth: monthCount, canRest });
        } catch (error) {
          console.error("åŠ è½½è¿åŠ¨å¤©æ•°é«˜äº®å¤±è´¥:", error);
        }
        
        // åŠ è½½é¥®é£Ÿæ•°æ®
        try {
          const { text } = await fetchFromSources(DIET_SOURCES);
          const kcalSeries = parseMetricSeries(text, "dietary_kcal");
          const proteinSeries = parseMetricSeries(text, "dietary_protein_g");
          const fatSeries = parseMetricSeries(text, "dietary_fat_g");
          const carbSeries = parseMetricSeries(text, "dietary_carb_g");
          
          const kcalAvg = calcAvg(kcalSeries);
          const proteinAvg = calcAvg(proteinSeries);
          const fatAvg = calcAvg(fatSeries);
          const carbAvg = calcAvg(carbSeries);
          
          updateVizPanels({ kcal: kcalAvg, protein: proteinAvg, fat: fatAvg, carb: carbAvg });
        } catch (error) {
          console.error("åŠ è½½é¥®é£Ÿæ•°æ®å¤±è´¥:", error);
        }
        
        // åŠ è½½èƒ½é‡æ¶ˆè€—æ•°æ®ï¼ˆåŸºç¡€ä»£è°¢+ä¸»åŠ¨èƒ½é‡ï¼‰
        try {
          const { text } = await fetchFromSources(ENERGY_SOURCES);
          const basalSeries = parseMetricSeries(text, "basal_energy");
          const activeSeries = parseMetricSeries(text, "active_energy");
          
          const basalAvg = calcAvg(basalSeries);
          const activeAvg = calcAvg(activeSeries);
          const totalBurn = (basalAvg || 0) + (activeAvg || 0);
          
          updateVizPanels({ basalEnergy: basalAvg, activeEnergy: activeAvg, totalBurn: totalBurn });
        } catch (error) {
          console.error("åŠ è½½èƒ½é‡æ¶ˆè€—æ•°æ®å¤±è´¥:", error);
        }
        
        // åŠ è½½ç¡çœ è¶‹åŠ¿æ•°æ®ï¼ˆæœ€è¿‘7å¤©å…¥ç¡/èµ·åºŠæ—¶é—´ï¼‰
        try {
          const { text } = await fetchFromSources(SLEEP_SCHEDULE_SOURCES);
          const rows = text.trim().split("\n").slice(1);
          const scheduleData = rows.map(row => {
            const [date, bed_time, wake_time] = row.split(",");
            return { date, bed_time, wake_time };
          }).filter(d => d.date && d.bed_time && d.wake_time);
          const recent7 = scheduleData.slice(-7);
          updateVizPanels({ sleepScheduleTrend: recent7 });
        } catch (error) {
          console.error("åŠ è½½ç¡çœ è¶‹åŠ¿æ•°æ®å¤±è´¥:", error);
        }
        
        // è®¾ç½®å¥åº·æ•°æ®æ›´æ–°æ—¶é—´
        try {
          const response = await fetch("health/data/sleep_daily.csv", { method: "HEAD", cache: "no-store" });
          const lastModified = response.headers.get("Last-Modified");
          const healthUpdateEl = document.getElementById("health-update-time");
          if (healthUpdateEl && lastModified) {
            const date = new Date(lastModified);
            healthUpdateEl.textContent = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")} ${String(date.getHours()).padStart(2, "0")}:${String(date.getMinutes()).padStart(2, "0")}`;
          }
        } catch (error) {
          console.error("è·å–å¥åº·æ•°æ®æ›´æ–°æ—¶é—´å¤±è´¥:", error);
        }
      };

      // å¯è§†åŒ–æ–¹æ¡ˆæ•°æ®ç¼“å­˜
      const vizData = { weight: null, weightPrev: null, sleep: null, sleepPrev: null, hrv: null, hrvPrev: null, exerciseWeek: null, exerciseMonth: null, bedTime: null, bedTimePrev: null, wakeTime: null, wakeTimePrev: null, kcal: null, protein: null, fat: null, carb: null, basalEnergy: null, activeEnergy: null, totalBurn: null, sleepScheduleTrend: null };

      const updateVizPanels = (data) => {
        Object.assign(vizData, data);
        const { weight, weightPrev, sleep, sleepPrev, hrv, hrvPrev, exerciseWeek, exerciseMonth, canRest, bedTime, bedTimePrev, wakeTime, wakeTimePrev, kcal, protein, fat, carb, basalEnergy, activeEnergy, totalBurn, sleepScheduleTrend } = vizData;

        // è¾…åŠ©å‡½æ•°
        const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        const setHtml = (id, html) => { const el = document.getElementById(id); if (el) el.innerHTML = html; };
        const setStyle = (id, prop, val) => { const el = document.getElementById(id); if (el) el.style[prop] = val; };
        const deltaHtml = (cur, prev) => formatDeltaSigned(cur, prev);
        
        // é¥®é£Ÿæ•°æ®
        if (kcal !== null) {
          setEl("viz1-kcal", Math.round(kcal) + "kcal");
          const kcalPct = Math.max(0, Math.min(100, (kcal / 2200) * 100));
          setStyle("viz1-kcal-bar", "width", kcalPct + "%");
        }
        if (protein !== null) setEl("viz1-protein", Math.round(protein) + "g");
        if (fat !== null) setEl("viz1-fat", Math.round(fat) + "g");
        if (carb !== null) setEl("viz1-carb", Math.round(carb) + "g");
        
        // èƒ½é‡æ¶ˆè€—æ•°æ®
        if (totalBurn !== null && totalBurn > 0) {
          setEl("viz1-burn", Math.round(totalBurn) + "kcal");
          setEl("viz1-burn-detail", `åŸºç¡€${Math.round(basalEnergy || 0)} + ä¸»åŠ¨${Math.round(activeEnergy || 0)}`);
          const burnPct = Math.max(0, Math.min(100, (totalBurn / 2500) * 100));
          setStyle("viz1-burn-bar", "width", burnPct + "%");
          
          // è®¡ç®—çƒ­é‡å·®
          if (kcal !== null) {
            const calorieDiff = Math.round(kcal - totalBurn);
            const diffColor = calorieDiff > 200 ? "#ef4444" : calorieDiff < -500 ? "#3b82f6" : "#22c55e";
            const diffSign = calorieDiff > 0 ? "+" : "";
            setHtml("viz1-calorie-diff", `<span style="color: ${diffColor}">${diffSign}${calorieDiff}kcal</span>`);
          }
        }
        
        // è¥å…»æˆåˆ†æ‰‡å½¢å›¾
        if (protein !== null && fat !== null && carb !== null) {
          const total = protein + fat + carb;
          if (total > 0) {
            const proteinPct = (protein / total) * 100;
            const fatPct = (fat / total) * 100;
            const carbPct = (carb / total) * 100;
            
            const pieProtein = document.getElementById("pie-protein");
            const pieFat = document.getElementById("pie-fat");
            const pieCarb = document.getElementById("pie-carb");
            
            if (pieProtein) pieProtein.setAttribute("stroke-dasharray", `${proteinPct}, 100`);
            if (pieFat) {
              pieFat.setAttribute("stroke-dasharray", `${fatPct}, 100`);
              pieFat.setAttribute("stroke-dashoffset", `-${proteinPct}`);
            }
            if (pieCarb) {
              pieCarb.setAttribute("stroke-dasharray", `${carbPct}, 100`);
              pieCarb.setAttribute("stroke-dashoffset", `-${proteinPct + fatPct}`);
            }
          }
        }

        // æ–¹æ¡ˆä¸€ï¼šä»ªè¡¨ç›˜å¡ç‰‡
        if (weight !== null) {
          setEl("viz1-weight", weight.toFixed(1) + "kg");
          setHtml("viz1-weight-delta", deltaHtml(weight, weightPrev));
          const weightPct = Math.max(0, Math.min(100, ((80 - weight) / (80 - 70)) * 100));
          setStyle("viz1-weight-bar", "width", weightPct + "%");
        }
        if (sleep !== null) {
          setEl("viz1-sleep", sleep.toFixed(1) + "h");
          setHtml("viz1-sleep-delta", deltaHtml(sleep, sleepPrev));
          const sleepPct = Math.max(0, Math.min(100, (sleep / 8) * 100));
          setStyle("viz1-sleep-bar", "width", sleepPct + "%");
        }
        if (hrv !== null) {
          setEl("viz1-hrv", hrv.toFixed(0) + "ms");
          setHtml("viz1-hrv-delta", deltaHtml(hrv, hrvPrev));
          const hrvPct = Math.max(0, Math.min(100, (hrv / 50) * 100));
          setStyle("viz1-hrv-bar", "width", hrvPct + "%");
        }
        if (exerciseWeek !== null) {
          setEl("viz1-exercise", exerciseWeek + "å¤©");
          setEl("viz1-exercise-sub", "æœ¬æœˆ " + (exerciseMonth || "--") + "å¤©");
          const exPct = Math.max(0, Math.min(100, (exerciseWeek / 4) * 100));
          setStyle("viz1-exercise-bar", "width", exPct + "%");
        }
        // å…¥ç¡/èµ·åºŠæ—¶é—´ (bedTime/wakeTime æ˜¯åˆ†é’Ÿæ•°)
        const formatClockFromMinutes = (mins, isBed) => {
          if (mins === null || mins === undefined || Number.isNaN(mins)) return "--";
          let totalMins = Math.round(mins);
          // å…¥ç¡æ—¶é—´å¯èƒ½è¶…è¿‡24å°æ—¶ï¼ˆè·¨åˆå¤œï¼‰ï¼Œéœ€è¦å‡å›æ¥
          if (isBed && totalMins >= 24 * 60) totalMins -= 24 * 60;
          const hh = Math.floor(totalMins / 60) % 24;
          const mm = totalMins % 60;
          return String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
        };
        if (bedTime !== null) {
          setEl("viz1-bedtime", formatClockFromMinutes(bedTime, true));
          setHtml("viz1-bedtime-delta", deltaHtml(bedTime, bedTimePrev));
          // ç›®æ ‡23:00(23*60=1380)ï¼Œé¢„è­¦00:00(24*60=1440 normalized)ï¼Œè¶Šæ—©è¶Šå¥½
          // bedTime æ˜¯åˆ†é’Ÿæ•°ï¼Œå¯èƒ½æ˜¯ 1380-1560 èŒƒå›´ï¼ˆ23:00-02:00è·¨åˆå¤œå+1440ï¼‰
          const bedPct = Math.max(0, Math.min(100, ((1500 - bedTime) / (1500 - 1380)) * 100));
          setStyle("viz1-bedtime-bar", "width", bedPct + "%");
        }
        if (wakeTime !== null) {
          setEl("viz1-waketime", formatClockFromMinutes(wakeTime, false));
          setHtml("viz1-waketime-delta", deltaHtml(wakeTime, wakeTimePrev));
          // ç›®æ ‡07:00(420)ï¼Œé¢„è­¦09:00(540)ï¼Œè¶Šæ—©è¶Šå¥½
          const wakePct = Math.max(0, Math.min(100, ((540 - wakeTime) / (540 - 420)) * 100));
          setStyle("viz1-waketime-bar", "width", wakePct + "%");
        }
        
        // åŒæ­¥ç¡çœ æ¨¡å—çš„æ•°æ®
        if (sleep !== null) {
          setEl("viz1-sleep2", sleep.toFixed(1) + "h");
          setHtml("viz1-sleep2-delta", deltaHtml(sleep, sleepPrev));
          const sleepPct2 = Math.max(0, Math.min(100, (sleep / 8) * 100));
          setStyle("viz1-sleep2-bar", "width", sleepPct2 + "%");
        }

        // è¿åŠ¨å»ºè®®è§„åˆ™
        // è§„åˆ™ï¼šç»¼åˆåˆ¤æ–­è¿åŠ¨å¤©æ•°ã€HRVã€ç¡çœ æ¥ç»™å‡ºä»Šæ—¥è¿åŠ¨å»ºè®®
        const getExerciseAdvice = () => {
          const weekGoal = 4, monthGoal = 16;
          const sleepOk = sleep !== null && sleep >= 6;
          const hrvOk = hrv !== null && hrv >= 30;
          const weekOk = exerciseWeek !== null && exerciseWeek >= weekGoal;
          const monthOk = exerciseMonth !== null && exerciseMonth >= monthGoal;
          const bodyReady = sleepOk && hrvOk;

          // å·²è¾¾æ ‡ï¼Œå¯ä»¥ä¼‘æ¯
          if (weekOk && monthOk) {
            return { level: "rest", text: "æœ¬å‘¨æœ¬æœˆéƒ½è¾¾æ ‡äº†ï¼Œä»Šå¤©å¯ä»¥ä¼‘æ¯ï½", color: "#22c55e" };
          }
          // æœ¬å‘¨è¾¾æ ‡ä½†æœ¬æœˆæœªè¾¾æ ‡
          if (weekOk && !monthOk) {
            if (bodyReady) {
              return { level: "suggest", text: "æœ¬å‘¨è¾¾æ ‡ä½†æœ¬æœˆè¿˜å·®ä¸€ç‚¹ï¼Œèº«ä½“çŠ¶æ€ä¸é”™ï¼Œå¯ä»¥åŠ ç»ƒ", color: "#3b82f6" };
            }
            return { level: "rest", text: "æœ¬å‘¨è¾¾æ ‡ï¼Œä»Šå¤©ä¼‘æ¯ä¹Ÿè¡Œ", color: "#22c55e" };
          }
          // æœ¬å‘¨æœªè¾¾æ ‡
          if (!weekOk) {
            if (!bodyReady) {
              const reason = !sleepOk ? "ç¡çœ ä¸è¶³" : "HRVåä½";
              return { level: "warn", text: `è¿åŠ¨æœªè¾¾æ ‡ï¼Œä½†${reason}ï¼Œå…ˆä¼‘æ¯æ¢å¤`, color: "#f97316" };
            }
            const gap = weekGoal - (exerciseWeek || 0);
            return { level: "go", text: `æœ¬å‘¨è¿˜å·®${gap}å¤©ï¼Œèº«ä½“çŠ¶æ€OKï¼Œå¿«èµ·æ¥è¿åŠ¨ï¼`, color: "#ef4444" };
          }
          return { level: "unknown", text: "æ•°æ®åŠ è½½ä¸­...", color: "#64748b" };
        };

        if (exerciseWeek !== null && sleep !== null && hrv !== null) {
          const advice = getExerciseAdvice();
          // ä»ªè¡¨ç›˜è¿åŠ¨å»ºè®®
          setEl("viz1-advice-text", advice.text);
          const adviceBox1 = document.getElementById("viz1-advice");
          if (adviceBox1) adviceBox1.style.borderLeftColor = advice.color;
        }
        
        // é¥®é£Ÿå»ºè®® - è€ƒè™‘çƒ­é‡å·®
        const getDietAdvice = () => {
          if (weight === null) return { text: "æ•°æ®åŠ è½½ä¸­...", color: "#64748b" };
          const issues = [];
          let mainAdvice = "";
          let color = "#22c55e";
          
          // ä½“é‡åˆ¤æ–­
          if (weight > 80) {
            issues.push("ä½“é‡è¶…è¿‡é¢„è­¦å€¼80kg");
            color = "#ef4444";
          } else if (weight > 75) {
            issues.push("ä½“é‡ç•¥é«˜äºç›®æ ‡");
            color = "#f97316";
          }
          
          // çƒ­é‡å·®åˆ¤æ–­
          if (kcal !== null && totalBurn !== null && totalBurn > 0) {
            const calorieDiff = kcal - totalBurn;
            if (weight > 75) {
              // éœ€è¦å‡é‡
              if (calorieDiff > 0) {
                issues.push("çƒ­é‡ç›ˆä½™ä¸åˆ©äºå‡é‡");
                mainAdvice = "å»ºè®®åˆ¶é€ 300-500kcalçƒ­é‡ç¼ºå£";
              } else if (calorieDiff > -300) {
                mainAdvice = "çƒ­é‡ç¼ºå£ä¸å¤Ÿï¼Œå¯ä»¥å†å°‘åƒä¸€ç‚¹æˆ–å¤šè¿åŠ¨";
              } else if (calorieDiff < -800) {
                mainAdvice = "çƒ­é‡ç¼ºå£è¿‡å¤§ï¼Œæ³¨æ„è¥å…»å‡è¡¡";
                color = "#f97316";
              } else {
                mainAdvice = "çƒ­é‡ç¼ºå£åˆç†ï¼Œç»§ç»­ä¿æŒ";
                color = "#22c55e";
              }
            } else {
              // ç»´æŒä½“é‡
              if (Math.abs(calorieDiff) <= 200) {
                mainAdvice = "çƒ­é‡å¹³è¡¡ï¼Œä½“é‡ç¨³å®š";
              } else if (calorieDiff > 200) {
                mainAdvice = "çƒ­é‡ç•¥æœ‰ç›ˆä½™ï¼Œæ³¨æ„æ§åˆ¶";
              } else {
                mainAdvice = "çƒ­é‡ç•¥æœ‰ç¼ºå£ï¼Œå¯é€‚å½“è¡¥å……";
              }
            }
          } else {
            mainAdvice = weight > 75 ? "å»ºè®®æ§åˆ¶é¥®é£Ÿçƒ­é‡" : "ä¿æŒå‡è¡¡é¥®é£Ÿ";
          }
          
          return { 
            text: issues.length > 0 ? issues.join("ï¼Œ") + "ã€‚" + mainAdvice : mainAdvice, 
            color 
          };
        };
        if (weight !== null) {
          const dietAdvice = getDietAdvice();
          setEl("diet-advice-text", dietAdvice.text);
          const dietBox = document.getElementById("diet-advice");
          if (dietBox) dietBox.style.borderLeftColor = dietAdvice.color;
        }
        
        // ç¡çœ å»ºè®® - é‡ç‚¹è€ƒè™‘å…¥ç¡æ—¶é—´ï¼Œå¼ºè°ƒæ—©ç¡æ—©èµ·
        const getSleepAdvice = () => {
          if (sleep === null || bedTime === null) return { text: "æ•°æ®åŠ è½½ä¸­...", color: "#64748b" };
          const issues = [];
          let mainAdvice = "";
          let color = "#22c55e";
          
          // å…¥ç¡æ—¶é—´åˆ¤æ–­ï¼ˆæœ€é‡è¦ï¼‰- bedTimeæ˜¯åˆ†é’Ÿæ•°ï¼Œå¯èƒ½è¶…è¿‡1440ï¼ˆè·¨åˆå¤œï¼‰
          const bedHour = bedTime >= 1440 ? (bedTime - 1440) / 60 : bedTime / 60;
          const isLateBed = bedTime > 1440 || bedHour >= 24 || (bedHour >= 0 && bedHour < 6); // 00:00åå…¥ç¡
          const isVeryLateBed = bedTime > 1500 || (bedHour >= 1 && bedHour < 6); // 01:00åå…¥ç¡
          
          if (isVeryLateBed) {
            issues.push("å…¥ç¡æ—¶é—´å¤ªæ™šï¼ˆè¶…è¿‡å‡Œæ™¨1ç‚¹ï¼‰");
            mainAdvice = "è¯·åŠ¡å¿…æ—©ç¡ï¼é•¿æœŸç†¬å¤œä¼¤èº«ä½“";
            color = "#ef4444";
          } else if (isLateBed) {
            issues.push("å…¥ç¡æ—¶é—´åæ™šï¼ˆè¶…è¿‡åˆå¤œï¼‰");
            mainAdvice = "å»ºè®®23ç‚¹å‰å…¥ç¡ï¼Œæ—©ç¡æ—©èµ·èº«ä½“å¥½";
            color = "#f97316";
          }
          
          // ç¡çœ æ—¶é•¿åˆ¤æ–­
          if (sleep < 6) {
            issues.push("ç¡çœ æ—¶é•¿ä¸è¶³6å°æ—¶");
            if (!mainAdvice) mainAdvice = "ç¡çœ ä¸¥é‡ä¸è¶³ï¼Œå½±å“æ¢å¤å’Œå…ç–«åŠ›";
            color = "#ef4444";
          } else if (sleep < 7) {
            if (!issues.length) issues.push("ç¡çœ æ—¶é•¿ç•¥å°‘");
            if (!mainAdvice) mainAdvice = "å»ºè®®ä¿è¯7-8å°æ—¶ç¡çœ ";
            if (color === "#22c55e") color = "#f97316";
          }
          
          // èµ·åºŠæ—¶é—´åˆ¤æ–­
          if (wakeTime > 600) { // 10:00å
            issues.push("èµ·åºŠå¤ªæ™š");
            if (!mainAdvice) mainAdvice = "å»ºè®®7-8ç‚¹èµ·åºŠï¼Œä¿æŒè§„å¾‹ä½œæ¯";
            if (color === "#22c55e") color = "#f97316";
          }
          
          if (issues.length === 0) {
            return { text: "ç¡çœ çŠ¶æ€è‰¯å¥½ï¼Œæ—©ç¡æ—©èµ·ï¼Œç»§ç»­ä¿æŒï¼", color: "#22c55e" };
          }
          
          return { text: issues.join("ï¼Œ") + "ã€‚" + mainAdvice, color };
        };
        if (sleep !== null) {
          const sleepAdvice = getSleepAdvice();
          setEl("sleep-advice-text", sleepAdvice.text);
          const sleepBox = document.getElementById("sleep-advice");
          if (sleepBox) sleepBox.style.borderLeftColor = sleepAdvice.color;
        }
        
        // ç¡çœ è¶‹åŠ¿å›¾æ¸²æŸ“ - å‚ç›´æ—¶é—´è½´æ ·å¼
        if (sleepScheduleTrend && sleepScheduleTrend.length > 0) {
          const chartContainer = document.getElementById("sleep-trend-chart");
          const labelsContainer = document.getElementById("sleep-trend-labels");
          const titleEl = document.getElementById("sleep-trend-title");
          if (chartContainer && labelsContainer) {
            // æ›´æ–°æ ‡é¢˜æ˜¾ç¤ºæ—¥æœŸèŒƒå›´
            const firstDate = new Date(sleepScheduleTrend[0].date);
            const lastDate = new Date(sleepScheduleTrend[sleepScheduleTrend.length - 1].date);
            if (titleEl) {
              titleEl.textContent = `${firstDate.getFullYear()}å¹´${firstDate.getMonth() + 1}æœˆ${firstDate.getDate()}æ—¥è‡³${lastDate.getDate()}æ—¥`;
            }
            
            // æ—¶é—´è½´èŒƒå›´ï¼š21:00 åˆ° 11:00ï¼ˆè·¨åˆå¤œï¼Œå…±14å°æ—¶ï¼‰
            const timeMin = 21 * 60; // 21:00 = 1260åˆ†é’Ÿ
            const timeMax = (24 + 11) * 60; // 11:00 next day = 2100åˆ†é’Ÿ
            const totalRange = timeMax - timeMin; // 840åˆ†é’Ÿ
            
            // è§£ææ—¶é—´å­—ç¬¦ä¸²ä¸ºåˆ†é’Ÿæ•°ï¼ˆç›¸å¯¹äºå½“å¤©0ç‚¹ï¼‰
            const parseTimeToMins = (timeStr) => {
              const [hh, mm] = timeStr.split(":").map(Number);
              return hh * 60 + mm;
            };
            
            // å°†æ—¶é—´è½¬æ¢ä¸ºå›¾è¡¨ä½ç½®ï¼ˆç™¾åˆ†æ¯”ï¼‰
            const timeToPosition = (mins, isBed) => {
              let adjustedMins = mins;
              // å…¥ç¡æ—¶é—´ï¼šå¦‚æœåœ¨0-21ç‚¹ä¹‹é—´ï¼Œè¯´æ˜æ˜¯è·¨åˆå¤œåçš„æ—¶é—´ï¼Œéœ€è¦+1440
              if (isBed && mins < timeMin) adjustedMins = mins + 24 * 60;
              // èµ·åºŠæ—¶é—´ï¼šå¦‚æœåœ¨0-11ç‚¹ä¹‹é—´ï¼Œè¯´æ˜æ˜¯ç¬¬äºŒå¤©ï¼Œéœ€è¦+1440
              if (!isBed && mins < 12 * 60) adjustedMins = mins + 24 * 60;
              return ((adjustedMins - timeMin) / totalRange) * 100;
            };
            
            chartContainer.innerHTML = sleepScheduleTrend.map((d, i) => {
              const bedMins = parseTimeToMins(d.bed_time);
              const wakeMins = parseTimeToMins(d.wake_time);
              
              const bedPos = timeToPosition(bedMins, true);
              const wakePos = timeToPosition(wakeMins, false);
              const height = wakePos - bedPos;
              
              // åªä½¿ç”¨3ç§é¢œè‰²ï¼šæ·±ç¡(#6366f1)ã€æµ…ç¡(#60a5fa)ã€æ¸…é†’(#f97316)
              // æ•´ä½“ä½¿ç”¨æ·±ç¡+æµ…ç¡æ¸å˜ï¼Œæ¨¡æ‹Ÿç¡çœ å‘¨æœŸ
              return `<div style="flex: 1; position: relative; height: 100%;">
                <div style="position: absolute; top: ${bedPos}%; height: ${Math.max(height, 2)}%; width: 100%; background: linear-gradient(180deg, #6366f1 0%, #60a5fa 30%, #6366f1 50%, #60a5fa 70%, #6366f1 100%); border-radius: 3px; opacity: 0.85;"></div>
              </div>`;
            }).join("");
            
            // æ¸²æŸ“åº•éƒ¨æ—¥æœŸæ ‡ç­¾
            labelsContainer.innerHTML = sleepScheduleTrend.map(d => {
              const date = new Date(d.date);
              const dayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
              return `<span>${dayNames[date.getDay()]}</span>`;
            }).join("");
          }
        }
      };

      const renderMetricTable = (rows) => {
        metricTableBody.innerHTML = "";
        if (!rows.length) {
          const tr = document.createElement("tr");
          const td = document.createElement("td");
          td.colSpan = 6;
          td.textContent = "æš‚æ— æ•°æ®";
          tr.appendChild(td);
          metricTableBody.appendChild(tr);
          return;
        }
        rows.forEach((row) => {
          const tr = document.createElement("tr");

          const nameCell = document.createElement("td");
          nameCell.textContent = row.label;
          nameCell.dataset.metricLabel = row.label;
          nameCell.classList.add("metric-link");
          nameCell.title = "ç‚¹å‡»æŸ¥çœ‹è¶‹åŠ¿å›¾";
          tr.appendChild(nameCell);

          const weekCell = document.createElement("td");
          weekCell.textContent = row.weekAvg;
          tr.appendChild(weekCell);

          const wowCell = document.createElement("td");
          wowCell.innerHTML = row.wow;
          tr.appendChild(wowCell);

          const momCell = document.createElement("td");
          momCell.innerHTML = row.mom;
          tr.appendChild(momCell);

          const yoyCell = document.createElement("td");
          yoyCell.innerHTML = row.yoy;
          tr.appendChild(yoyCell);


          metricTableBody.appendChild(tr);
        });
      };

      const loadMetricTable = async () => {
        try {
          if (healthStatus) {
            healthStatus.textContent = "æ­£åœ¨åŠ è½½å¥åº·æ•°æ®...";
          }
          const rows = [];
          for (const def of healthMetricDefs) {
            if (def.enabled === false) continue;
            const category = def.category || "æœªåˆ†ç±»";
            try {
              const { text } = await fetchFromSources(def.sources);
              const series = parseMetricSeries(text, def.valueKey);
              if (!series.length) {
                rows.push({
                  label: def.label,
                  category,
                  weekAvg: "--",
                  wow: "â€”",
                  mom: "â€”",
                  yoy: "â€”",
                });
                continue;
              }
              
              // ç»Ÿä¸€ä½¿ç”¨åŸå§‹æ•°æ®ç›´æ¥è®¡ç®—å‘¨æ—¥å‡å€¼ï¼ˆ7æ—¥æ»šåŠ¨å¹³å‡ä»…ç”¨äºè¶‹åŠ¿å›¾ï¼‰
              const avg7 = avgWindowByDate(series, 7, 0);
              const prev7 = avgWindowByDate(series, 7, 7);
              const prev30 = avgWindowByDate(series, 30, 7);
              const avg365 = avgWindowByDate(series, 365, 0);

              rows.push({
                label: def.label,
                category,
                weekAvg: formatValueWithUnit(avg7, def.unit),
                wow: formatDeltaColored(avg7, prev7),
                mom: formatDeltaColored(avg7, prev30),
                yoy: formatDeltaColored(avg7, avg365),
              });
            } catch (error) {
              console.error(`åŠ è½½æŒ‡æ ‡ ${def.label} å¤±è´¥:`, error);
              rows.push({
                label: def.label,
                category,
                weekAvg: "åŠ è½½å¤±è´¥",
                wow: "â€”",
                mom: "â€”",
                yoy: "â€”",
              });
            }
          }
          metricRows = rows;
          applyHealthMetricFilters();
          if (healthStatus) {
            healthStatus.textContent = "å¥åº·æ•°æ®å·²åŠ è½½";
          }
        } catch (error) {
          console.error("åŠ è½½æŒ‡æ ‡è¡¨æ ¼å¤±è´¥:", error);
          metricRows = [];
          renderMetricTable([]);
          if (healthStatus) {
            healthStatus.textContent = "å¥åº·æ•°æ®åŠ è½½å¤±è´¥";
          }
        }
      };

      const initHealthMetricTable = async () => {
        await loadHealthMetricConfig();
        await loadMetricTable();
      };


      const fetchCSVSource = async () => {
        const errors = [];
        for (const source of CSV_SOURCES) {
          try {
            const response = await fetch(source.url, { cache: "no-store" });
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            const text = await response.text();
            const lastModified = await resolveLastModified(response, source.url);
            return { text, lastModified, sourceLabel: source.label };
          } catch (error) {
            errors.push(`${source.label}: ${error.message}`);
          }
        }
        throw new Error(errors.join(" | "));
      };

      const loadCSV = async () => {
        if (statusEl) statusEl.textContent = "æ­£åœ¨åŠ è½½æ•°æ®...";
        if (updateTimeEl) updateTimeEl.textContent = " æ­£åœ¨è·å–...";
        try {
          const { text, lastModified, sourceLabel } = await fetchCSVSource();
          if (lastModified) {
            if (updateTimeEl) {
              updateTimeEl.textContent = formatUpdateTime(lastModified);
              updateTimeEl.title = `${lastModified.toString()} Â· æ¥æºï¼š${sourceLabel}`;
            }
          } else {
            if (updateTimeEl) {
              updateTimeEl.textContent = ` æ— å¯ç”¨æ•°æ®ï¼ˆæ¥æºï¼š${sourceLabel})`;
              updateTimeEl.removeAttribute("title");
            }
          }
          const rows = parseCSV(text);
          if (!rows.length) {
            if (statusEl) statusEl.textContent = "CSV æ–‡ä»¶ä¸ºç©º";
            records = [];
            renderBody([]);
            return;
          }
          records = buildRecords(rows);
          applyFilters();
        } catch (error) {
          console.error(error);
          if (statusEl) statusEl.textContent = "åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®è®¤ CSV æ–‡ä»¶è·¯å¾„æ­£ç¡®";
          records = [];
          renderBody([]);
        }
      };

      renderCategoryChips();
      initLimitSelect();
      ensureLimitValue();
      renderHeader();
      renderBody([]);
      initHealthMetricTable();
      loadHealthHighlight();
      loadCSV();
    </script>
    <div class="modal" id="chart-modal" aria-hidden="true">
      <div class="modal-content">
        <button class="modal-close" id="modal-close" type="button">å…³é—­</button>
        <div class="modal-title" id="modal-title"></div>
        <div class="modal-chart" id="modal-chart"></div>
        <img class="modal-image" id="modal-image" alt="" />
      </div>
    </div>
    <div class="modal" id="sleep-info-modal" aria-hidden="true">
      <div class="modal-content">
        <button class="modal-close" id="sleep-info-close" type="button">å…³é—­</button>
        <div class="modal-title">ç¡çœ å»ºè®®è§„åˆ™</div>
        <div class="modal-text" style="font-size: 13px; line-height: 1.8;">
          <p style="margin: 0 0 12px; font-weight: 600; color: #c4b5fd;">é˜ˆå€¼è®¾å®šï¼š</p>
          <ul style="margin: 0 0 16px; padding-left: 20px; color: #94a3b8;">
            <li>ç¡çœ æ—¶é•¿ç›®æ ‡ï¼š8å°æ—¶ Â· é¢„è­¦ï¼š6å°æ—¶</li>
            <li>å…¥ç¡æ—¶é—´ç›®æ ‡ï¼š23:00å‰ Â· é¢„è­¦ï¼š00:00å</li>
            <li>èµ·åºŠæ—¶é—´ç›®æ ‡ï¼š07:00å‰ Â· é¢„è­¦ï¼š09:00å</li>
          </ul>
          <p style="margin: 0 0 12px; font-weight: 600; color: #c4b5fd;">åˆ¤æ–­é€»è¾‘ï¼š</p>
          <ul style="margin: 0; padding-left: 20px; color: #94a3b8;">
            <li><span style="color: #22c55e;">æ—©ç¡æ—©èµ·</span>ï¼šå…¥ç¡â‰¤23:00 ä¸” ç¡çœ â‰¥7h</li>
            <li><span style="color: #3b82f6;">ç¡çœ å……è¶³</span>ï¼šç¡çœ â‰¥7h ä½†å…¥ç¡è¾ƒæ™š</li>
            <li><span style="color: #f97316;">æ³¨æ„ä½œæ¯</span>ï¼šå…¥ç¡åœ¨00:00-01:00ä¹‹é—´</li>
            <li><span style="color: #ef4444;">ä¸¥é‡ç†¬å¤œ</span>ï¼šå…¥ç¡â‰¥01:00</li>
            <li><span style="color: #ef4444;">ç¡çœ ä¸è¶³</span>ï¼šç¡çœ ï¼œ6h</li>
          </ul>
        </div>
      </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js" crossorigin="anonymous"></script>
    <script>
      (() => {
        const metricTableBody = document.getElementById("health-metric-body");
        const modal = document.getElementById("chart-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalChart = document.getElementById("modal-chart");
        const modalImg = document.getElementById("modal-image");
        const modalClose = document.getElementById("modal-close");
        if (!metricTableBody || !modal || !modalTitle || !modalChart || !modalImg || !modalClose) return;

        const baseDefs =
          typeof healthMetricDefs === "undefined"
            ? typeof METRIC_DEFS === "undefined"
              ? []
              : METRIC_DEFS
            : healthMetricDefs;
        const extraDefs =
          typeof HIGHLIGHT_EXTRA_DEFS === "undefined" ? [] : HIGHLIGHT_EXTRA_DEFS;
        const metricDefMap = new Map(
          [...baseDefs, ...extraDefs].map((def) => [def.label, def])
        );

        const GUIDE_LINES = {
          // ç¡çœ ç›¸å…³
          sleep_hours: [
            { value: 8, label: "ç›®æ ‡ 8h", color: "#22d3ee" },
            { value: 6, label: "é¢„è­¦ 6h", color: "#f97316" },
          ],
          bed_time: [
            { value: 23 * 60, label: "ç›®æ ‡ 23:00", color: "#22d3ee" },
            { value: 24 * 60, label: "é¢„è­¦ 00:00", color: "#f97316" },
          ],
          wake_time: [
            { value: 7 * 60, label: "ç›®æ ‡ 7:00", color: "#22d3ee" },
            { value: 9 * 60, label: "é¢„è­¦ 9:00", color: "#f97316" },
          ],
          // ä½“é‡ä½“è„‚
          weight_kg: [
            { value: 70, label: "ç›®æ ‡ 70kg", color: "#22d3ee" },
            { value: 80, label: "é¢„è­¦ 80kg", color: "#f97316" },
          ],
          bmi: [
            { value: 22, label: "ç›®æ ‡ 22", color: "#22d3ee" },
            { value: 25, label: "é¢„è­¦ 25", color: "#f97316" },
          ],
          body_fat_pct: [
            { value: 15, label: "ç›®æ ‡ 15%", color: "#22d3ee" },
            { value: 25, label: "é¢„è­¦ 25%", color: "#f97316" },
          ],
          // è¿åŠ¨ç›¸å…³
          steps: [
            { value: 10000, label: "ç›®æ ‡ 10000æ­¥", color: "#22d3ee" },
            { value: 5000, label: "é¢„è­¦ 5000æ­¥", color: "#f97316" },
          ],
          active_energy: [
            { value: 500, label: "ç›®æ ‡ 500kcal", color: "#22d3ee" },
            { value: 200, label: "é¢„è­¦ 200kcal", color: "#f97316" },
          ],
          exercise_time_min: [
            { value: 30, label: "ç›®æ ‡ 30åˆ†é’Ÿ", color: "#22d3ee" },
            { value: 10, label: "é¢„è­¦ 10åˆ†é’Ÿ", color: "#f97316" },
          ],
          stand_hours: [
            { value: 12, label: "ç›®æ ‡ 12å°æ—¶", color: "#22d3ee" },
            { value: 8, label: "é¢„è­¦ 8å°æ—¶", color: "#f97316" },
          ],
          // å¿ƒç‡ç›¸å…³
          resting_hr_avg: [
            { value: 60, label: "ç›®æ ‡ 60bpm", color: "#22d3ee" },
            { value: 80, label: "é¢„è­¦ 80bpm", color: "#f97316" },
          ],
          sdnn_avg: [
            { value: 50, label: "ç›®æ ‡ 50ms", color: "#22d3ee" },
            { value: 30, label: "é¢„è­¦ 30ms", color: "#f97316" },
          ],
          // è¡€æ°§
          spo2_avg: [
            { value: 98, label: "ç›®æ ‡ 98%", color: "#22d3ee" },
            { value: 95, label: "é¢„è­¦ 95%", color: "#f97316" },
          ],
          // æœ€å¤§æ‘„æ°§é‡
          vo2max_avg: [
            { value: 45, label: "ç›®æ ‡ 45", color: "#22d3ee" },
            { value: 35, label: "é¢„è­¦ 35", color: "#f97316" },
          ],
          // å™ªå£°
          env_audio_avg: [
            { value: 50, label: "ç›®æ ‡ <50dB", color: "#22d3ee" },
            { value: 70, label: "é¢„è­¦ 70dB", color: "#f97316" },
          ],
          headphone_audio_avg: [
            { value: 60, label: "ç›®æ ‡ <60dB", color: "#22d3ee" },
            { value: 80, label: "é¢„è­¦ 80dB", color: "#f97316" },
          ],
        };

        const TIME_VALUE_KEYS = new Set(["bed_time", "wake_time"]);
        const TIME_UNWRAP_KEYS = new Set(["bed_time"]);
        const MAIN_CHART_COLOR = "#60a5fa";

        let openToken = 0;
        let currentChart = null;
        let currentResizeHandler = null;

        const disposeChart = () => {
          if (currentResizeHandler) {
            window.removeEventListener("resize", currentResizeHandler);
            currentResizeHandler = null;
          }
          if (currentChart) {
            currentChart.dispose();
            currentChart = null;
          }
        };

        const openModalShell = () => {
          modal.classList.add("modal--open");
          modal.setAttribute("aria-hidden", "false");
          document.body.classList.add("modal-open");
        };

        const closeModal = () => {
          modal.classList.remove("modal--open");
          modal.setAttribute("aria-hidden", "true");
          document.body.classList.remove("modal-open");
          modalTitle.textContent = "";
          disposeChart();
          modalChart.innerHTML = "";
          modalChart.style.display = "none";
          modalImg.removeAttribute("src");
          modalImg.alt = "";
          modalImg.style.display = "none";
        };

        const showLoading = (text) => {
          disposeChart();
          modalChart.style.display = "block";
          modalChart.textContent = text || "æ­£åœ¨åŠ è½½...";
          modalImg.style.display = "none";
          modalImg.removeAttribute("src");
        };

        const formatYM = (d) => {
          const date = d instanceof Date ? d : new Date(d);
          if (Number.isNaN(date.getTime())) return "";
          const month = String(date.getMonth() + 1).padStart(2, "0");
          return `${date.getFullYear()}-${month}`;
        };

        const formatMonthDay = (value) => {
          const date = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(date.getTime())) return "";
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${month}-${day}`;
        };

        const formatYearMonth = (value) => {
          const date = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(date.getTime())) return "";
          const month = String(date.getMonth() + 1).padStart(2, "0");
          return `${date.getFullYear()}-${month}`;
        };

        const formatFullDate = (value) => {
          const date = value instanceof Date ? value : new Date(value);
          if (Number.isNaN(date.getTime())) return "";
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const day = String(date.getDate()).padStart(2, "0");
          return `${date.getFullYear()}-${month}-${day}`;
        };

        const formatChartNumber = (value) => {
          if (value === null || value === undefined || Number.isNaN(value)) return "";
          const abs = Math.abs(value);
          if (abs >= 1000) return String(Math.round(value));
          if (abs >= 100) return value.toFixed(1).replace(/\.0$/, "");
          if (abs >= 10) return value.toFixed(1).replace(/\.0$/, "");
          return value
            .toFixed(2)
            .replace(/\.00$/, "")
            .replace(/(\.\d)0$/, "$1");
        };

        const formatChartValue = (value, isTime) =>
          isTime ? formatClock(value, true) : formatChartNumber(value);

        const normalizeChartValue = (value, unit) => {
          if (value === null || Number.isNaN(value)) return null;
          let num = Number(value);
          if (unit === "%" && num < 1) num *= 100;
          return num;
        };

        const movingAvg = (values, window = 7) =>
          values.map((_, idx) => {
            const start = Math.max(0, idx - window + 1);
            const slice = values.slice(start, idx + 1);
            const total = slice.reduce((acc, cur) => acc + cur, 0);
            return total / slice.length;
          });

        const computeRollingAvg = (series, window = 7) => {
          const out = [];
          const queue = [];
          let sum = 0;
          series.forEach((point) => {
            queue.push(point.value);
            sum += point.value;
            if (queue.length > window) {
              sum -= queue.shift();
            }
            out.push({ date: point.date, value: sum / queue.length });
          });
          return out;
        };

        const computeTimeUnwrapPivot = (values) => {
          if (!values.length) return 720;
          const sorted = values.slice().sort((a, b) => a - b);
          if (sorted.length === 1) return (sorted[0] + 720) % 1440;
          let maxGap = -1;
          let pivot = 720;
          for (let i = 0; i < sorted.length; i += 1) {
            const current = sorted[i];
            const next = sorted[(i + 1) % sorted.length];
            const gap = (next - current + 1440) % 1440;
            if (gap > maxGap) {
              maxGap = gap;
              pivot = (current + gap / 2) % 1440;
            }
          }
          return pivot;
        };

        const unwrapTimeValue = (value, pivot) => (value < pivot ? value + 1440 : value);

        const buildSeries = (def, text) => {
          if (def.valueKey === "exercise_days") {
            const baseSeries = parseMetricSeries(text, "exercise_time_min");
            const normalized = baseSeries
              .map((item) => ({
                date: item.date,
                value: item.value >= EXERCISE_DAY_THRESHOLD_MIN ? 1 : 0,
              }))
              .filter((item) => item.value !== null);
            normalized.sort((a, b) => a.date - b.date);
            return { series: normalized, isTime: false };
          }
          const isTime = TIME_VALUE_KEYS.has(def.valueKey);
          const baseSeries = isTime
            ? parseScheduleSeries(text, def.valueKey)
            : parseMetricSeries(text, def.valueKey);
          if (!baseSeries.length) return { series: [], isTime };
          const normalized = baseSeries
            .map((item) => ({
              date: item.date,
              value: isTime ? item.value : normalizeChartValue(item.value, def.unit),
            }))
            .filter((item) => item.value !== null);
          if (!normalized.length) return { series: [], isTime };
          if (isTime && TIME_UNWRAP_KEYS.has(def.valueKey)) {
            const pivot = computeTimeUnwrapPivot(normalized.map((item) => item.value));
            normalized.forEach((item) => {
              item.value = unwrapTimeValue(item.value, pivot);
            });
          }
          normalized.sort((a, b) => a.date - b.date);
          return { series: normalized, isTime };
        };

        const calcExtent = (series, guideLines, isTime) => {
          if (!series.length) return { min: 0, max: 1 };
          let minVal = Math.min(...series.map((item) => item.value));
          let maxVal = Math.max(...series.map((item) => item.value));
          (guideLines || []).forEach((line) => {
            if (typeof line.value !== "number") return;
            minVal = Math.min(minVal, line.value);
            maxVal = Math.max(maxVal, line.value);
          });
          if (minVal === maxVal) {
            minVal -= 1;
            maxVal += 1;
          }
          const pad = isTime
            ? Math.max((maxVal - minVal) * 0.1, 30)
            : Math.max((maxVal - minVal) * 0.1, 0.2);
          return { min: minVal - pad, max: maxVal + pad };
        };

        const buildMarkLine = (guideLines) => {
          if (!guideLines || !guideLines.length) return null;
          return {
            symbol: "none",
            silent: true,
            data: guideLines.map((line) => ({
              yAxis: line.value,
              lineStyle: { color: line.color, type: "dashed", width: 1 },
              label: {
                formatter: line.label,
                color: line.color,
                position: "end",
              },
            })),
          };
        };

        const renderFallbackChart = async (def, token) => {
          showLoading("æ­£åœ¨åŠ è½½æ•°æ®...");
          const { text } = await fetchFromSources(def.sources);
          const series = parseMetricSeries(text, def.valueKey);
          if (!series.length) {
            modalChart.textContent = "æš‚æ— æ•°æ®";
            return;
          }

          const filtered = series
            .map((item) => ({
              date: item.date,
              value: normalizeChartValue(item.value, def.unit),
            }))
            .filter((item) => item.value !== null);
          if (!filtered.length) {
            modalChart.textContent = "æš‚æ— æ•°æ®";
            return;
          }

          const ma = movingAvg(filtered.map((item) => item.value), 7);
          const chartData = filtered
            .map((item, idx) => ({ label: formatYM(item.date), value: ma[idx] }))
            .slice(-365);

          if (token !== openToken) return;
          modalChart.style.display = "block";
          renderLineChart(modalChart, chartData, { color: MAIN_CHART_COLOR });
        };

        const renderEchartsChart = async (def, token) => {
          showLoading("æ­£åœ¨åŠ è½½æ•°æ®...");
          const { text } = await fetchFromSources(def.sources);
          const built = buildSeries(def, text);
          if (!built.series.length) {
            modalChart.textContent = "æš‚æ— æ•°æ®";
            return;
          }

          const { series, isTime } = built;
          const lastDate = series[series.length - 1].date;
          const monthStart = new Date(lastDate.getTime() - 29 * 86400000);
          const yearStart = new Date(lastDate.getTime() - 364 * 86400000);
          const topSeries = series.filter((point) => point.date >= monthStart);
          const yearSeries = series.filter((point) => point.date >= yearStart);
          const bottomSeries = computeRollingAvg(yearSeries, 7);

          if (!topSeries.length || !bottomSeries.length) {
            modalChart.textContent = "æš‚æ— æ•°æ®";
            return;
          }

          if (token !== openToken) return;
          modalChart.style.display = "block";
          modalChart.textContent = "";
          modalImg.style.display = "none";

          if (!window.echarts) {
            modalChart.textContent = "ECharts æœªåŠ è½½";
            return;
          }

          requestAnimationFrame(() => {
            if (token !== openToken) return;
            disposeChart();
            const chart = window.echarts.init(modalChart);
            currentChart = chart;

            const rect = modalChart.getBoundingClientRect();
            const chartWidth = rect.width || 920;
            const chartHeight = rect.height || 720;
            const isShort = chartHeight < 520;
            const gridTop = isShort ? 54 : 70;
            const gridGap = Math.max(isShort ? 20 : 36, Math.round(chartHeight * (isShort ? 0.04 : 0.07)));
            const gridBottomMargin = isShort ? 30 : 40;
            const availableHeight = Math.max(0, chartHeight - gridTop - gridBottomMargin - gridGap);
            const gridHeight = Math.floor(availableHeight / 2);
            const gridBottomTop = gridTop + gridHeight + gridGap;
            const isCompact = chartWidth < 560;
            const isUltraCompact = chartWidth < 420;
            const compactStep = isUltraCompact ? 3 : 2;
            const compactLabel = (value, index, formatter) => {
              if (!isCompact || typeof index !== "number") return formatter(value);
              return index % compactStep === 0 ? formatter(value) : "";
            };
            const pointLabelStep = isUltraCompact ? 5 : isCompact ? 3 : 1;

            const guideLines = GUIDE_LINES[def.valueKey] || [];
            const topExtent = calcExtent(topSeries, guideLines, isTime);
            const bottomExtent = calcExtent(bottomSeries, guideLines, isTime);
            const markLine = buildMarkLine(guideLines);

            const topData = topSeries.map((point) => ({
              value: [point.date.getTime(), point.value],
            }));
            const bottomData = bottomSeries.map((point) => ({
              value: [point.date.getTime(), point.value],
            }));
            const showPointLabel = (index) =>
              !isCompact ||
              index === 0 ||
              index === topData.length - 1 ||
              index % pointLabelStep === 0;

            const option = {
              backgroundColor: "#0f172a",
              textStyle: { color: "#cbd5f5" },
              title: [
                {
                  text: "æœ¬æœˆåˆ†å¤©æŒ‡æ ‡æ˜ç»†",
                  left: 60,
                  top: Math.max(32, gridTop - 26),
                  textStyle: { color: "#e2e8f0", fontSize: 13, fontWeight: 600 },
                },
                {
                  text: "æœ¬å¹´æ ¸å¿ƒæŒ‡æ ‡è¶‹åŠ¿ï¼ˆæ»‘åŠ¨7æ—¥çª—å£å¹³å‡ï¼‰",
                  left: 60,
                  top: Math.max(32, gridBottomTop - 26),
                  textStyle: { color: "#e2e8f0", fontSize: 13, fontWeight: 600 },
                },
              ],
              grid: [
                { left: 60, right: 30, top: gridTop, height: gridHeight, containLabel: true },
                { left: 60, right: 30, top: gridBottomTop, height: gridHeight, containLabel: true },
              ],
              tooltip: {
                trigger: "axis",
                axisPointer: { type: "line" },
                backgroundColor: "rgba(15,23,42,0.95)",
                borderColor: "rgba(148,163,184,0.4)",
                textStyle: { color: "#e2e8f0" },
                formatter: (params) => {
                  const items = Array.isArray(params) ? params : [params];
                  if (!items.length) return "";
                  const dateLabel = formatFullDate(items[0].value[0]);
                  const lines = items.map(
                    (item) =>
                      `${item.marker}${item.seriesName}ï¼š${formatChartValue(item.value[1], isTime)}`
                  );
                  return [dateLabel, ...lines].join("<br/>");
                },
              },
              xAxis: [
                {
                  type: "time",
                  gridIndex: 0,
                  axisLine: { lineStyle: { color: "rgba(148,163,184,0.7)" } },
                  axisTick: { show: true },
                  axisLabel: {
                    color: "#cbd5f5",
                    hideOverlap: true,
                    showMinLabel: true,
                    showMaxLabel: true,
                    rotate: isCompact ? 30 : 0,
                    formatter: (value, index) => compactLabel(value, index, formatMonthDay),
                  },
                  splitLine: { show: false },
                },
                {
                  type: "time",
                  gridIndex: 1,
                  axisLine: { lineStyle: { color: "rgba(148,163,184,0.7)" } },
                  axisTick: { show: true },
                  axisLabel: {
                    color: "#cbd5f5",
                    hideOverlap: true,
                    showMinLabel: true,
                    showMaxLabel: true,
                    rotate: isCompact ? 30 : 0,
                    formatter: (value, index) => compactLabel(value, index, formatYearMonth),
                  },
                  splitLine: { show: false },
                },
              ],
              yAxis: [
                {
                  type: "value",
                  gridIndex: 0,
                  min: topExtent.min,
                  max: topExtent.max,
                  splitNumber: 5,
                  axisLine: { lineStyle: { color: "rgba(148,163,184,0.7)" } },
                  axisLabel: {
                    color: "#cbd5f5",
                    formatter: (value) => formatChartValue(value, isTime),
                  },
                  splitLine: { lineStyle: { color: "rgba(148,163,184,0.18)" } },
                },
                {
                  type: "value",
                  gridIndex: 1,
                  min: bottomExtent.min,
                  max: bottomExtent.max,
                  splitNumber: 5,
                  axisLine: { lineStyle: { color: "rgba(148,163,184,0.7)" } },
                  axisLabel: {
                    color: "#cbd5f5",
                    formatter: (value) => formatChartValue(value, isTime),
                  },
                  splitLine: { lineStyle: { color: "rgba(148,163,184,0.18)" } },
                },
              ],
              series: [
                {
                  name: "æœ¬æœˆåˆ†å¤©æŒ‡æ ‡æ˜ç»†",
                  type: "line",
                  xAxisIndex: 0,
                  yAxisIndex: 0,
                  data: topData,
                  smooth: true,
                  symbol: "circle",
                  symbolSize: isCompact ? 4 : 6,
                  lineStyle: { color: MAIN_CHART_COLOR, width: 2 },
                  itemStyle: { color: MAIN_CHART_COLOR },
                  label: {
                    show: true,
                    color: "#e2e8f0",
                    fontSize: 10,
                    formatter: (params) =>
                      showPointLabel(params.dataIndex)
                        ? formatChartValue(params.value[1], isTime)
                        : "",
                  },
                  labelLayout: { hideOverlap: true },
                  markLine: markLine || undefined,
                },
                {
                  name: "æœ¬å¹´æ ¸å¿ƒæŒ‡æ ‡è¶‹åŠ¿ï¼ˆæ»‘åŠ¨7æ—¥çª—å£å¹³å‡ï¼‰",
                  type: "line",
                  xAxisIndex: 1,
                  yAxisIndex: 1,
                  data: bottomData,
                  smooth: true,
                  symbol: "none",
                  lineStyle: { color: MAIN_CHART_COLOR, width: 2 },
                  itemStyle: { color: MAIN_CHART_COLOR },
                  sampling: "lttb",
                  areaStyle: {
                    color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [
                      { offset: 0, color: "rgba(96,165,250,0.35)" },
                      { offset: 1, color: "rgba(96,165,250,0.05)" },
                    ]),
                  },
                  markLine: markLine || undefined,
                },
              ],
            };

            chart.setOption(option, true);
            currentResizeHandler = () => {
              if (!currentChart || currentChart.isDisposed()) return;
              currentChart.resize();
            };
            window.addEventListener("resize", currentResizeHandler);
          });
        };

        const openMetric = (label) => {
          const def = metricDefMap.get(label);
          if (!def) return;

          openToken += 1;
          const token = openToken;

          modalTitle.textContent = label + " è¶‹åŠ¿å›¾";
          openModalShell();

          renderEchartsChart(def, token).catch((error) => {
            console.error(error);
            if (token !== openToken) return;
            modalChart.textContent = "åŠ è½½å¤±è´¥";
          });
        };

        metricTableBody.addEventListener("click", (e) => {
          const cell = e.target.closest("td");
          if (!cell) return;
          const label = (cell.dataset.metricLabel || "").trim();
          if (!label) return;
          openMetric(label);
        });

        const healthHighlight = document.getElementById("health-highlight");
        if (healthHighlight) {
          healthHighlight.addEventListener("click", (e) => {
            const target = e.target.closest("[data-metric-label]");
            if (!target) return;
            const label = (target.dataset.metricLabel || "").trim();
            if (!label) return;
            openMetric(label);
          });
        }

        const infoTrigger = document.getElementById("sleep-info-trigger");
        const infoModal = document.getElementById("sleep-info-modal");
        const infoClose = document.getElementById("sleep-info-close");
        if (infoTrigger && infoModal && infoClose) {
          const openInfo = () => {
            infoModal.classList.add("modal--open");
            infoModal.setAttribute("aria-hidden", "false");
          };
          const closeInfo = () => {
            infoModal.classList.remove("modal--open");
            infoModal.setAttribute("aria-hidden", "true");
          };
          infoTrigger.addEventListener("click", (e) => {
            e.stopPropagation();
            openInfo();
          });
          infoClose.addEventListener("click", closeInfo);
          infoModal.addEventListener("click", (e) => {
            if (e.target === infoModal) closeInfo();
          });
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && infoModal.classList.contains("modal--open")) {
              closeInfo();
            }
          });
        }

        // è¿åŠ¨å»ºè®®è§„åˆ™å¼¹çª—
        const exerciseAdviceTrigger = document.getElementById("exercise-advice-trigger");
        const exerciseAdvicePopup = document.getElementById("exercise-advice-popup");
        const exerciseAdviceClose = document.getElementById("exercise-advice-close");
        const exerciseAdviceOverlay = document.getElementById("exercise-advice-overlay");
        if (exerciseAdviceTrigger && exerciseAdvicePopup && exerciseAdviceClose && exerciseAdviceOverlay) {
          const openExerciseAdvice = () => {
            exerciseAdvicePopup.style.display = "block";
            exerciseAdviceOverlay.style.display = "block";
          };
          const closeExerciseAdvice = () => {
            exerciseAdvicePopup.style.display = "none";
            exerciseAdviceOverlay.style.display = "none";
          };
          exerciseAdviceTrigger.addEventListener("click", (e) => {
            e.stopPropagation();
            openExerciseAdvice();
          });
          exerciseAdviceClose.addEventListener("click", closeExerciseAdvice);
          exerciseAdviceOverlay.addEventListener("click", closeExerciseAdvice);
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && exerciseAdvicePopup.style.display === "block") {
              closeExerciseAdvice();
            }
          });
        }

        // é¥®é£Ÿå»ºè®®è§„åˆ™å¼¹çª—
        const dietAdviceTrigger = document.getElementById("diet-advice-trigger");
        const dietAdvicePopup = document.getElementById("diet-advice-popup");
        const dietAdviceClose = document.getElementById("diet-advice-close");
        const dietAdviceOverlay = document.getElementById("diet-advice-overlay");
        if (dietAdviceTrigger && dietAdvicePopup && dietAdviceClose && dietAdviceOverlay) {
          const openDietAdvice = () => {
            dietAdvicePopup.style.display = "block";
            dietAdviceOverlay.style.display = "block";
          };
          const closeDietAdvice = () => {
            dietAdvicePopup.style.display = "none";
            dietAdviceOverlay.style.display = "none";
          };
          dietAdviceTrigger.addEventListener("click", (e) => {
            e.stopPropagation();
            openDietAdvice();
          });
          dietAdviceClose.addEventListener("click", closeDietAdvice);
          dietAdviceOverlay.addEventListener("click", closeDietAdvice);
          document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && dietAdvicePopup.style.display === "block") {
              closeDietAdvice();
            }
          });
        }

        modalClose.addEventListener("click", closeModal);
        modal.addEventListener("click", (e) => {
          if (e.target === modal) closeModal();
        });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && modal.classList.contains("modal--open")) {
            closeModal();
          }
        });

        // ä»ªè¡¨ç›˜å¡ç‰‡ç‚¹å‡»æ˜¾ç¤ºè¶‹åŠ¿å›¾ - ç»‘å®šåˆ°å„ä¸ªå¡ç‰‡å®¹å™¨
        const cardContainers = ['exercise-cards', 'diet-cards', 'sleep-cards'];
        const metricLabelMap = {
          weight_kg: "ä½“é‡",
          sleep_hours: "ç¡çœ æ—¶é•¿",
          sdnn_avg: "HRV-SDNNå‡å€¼",
          exercise_time_min: "é”»ç‚¼æ—¶é•¿",
          bed_time: "å…¥ç¡æ—¶é—´",
          wake_time: "èµ·åºŠæ—¶é—´",
        };
        
        cardContainers.forEach(containerId => {
          const container = document.getElementById(containerId);
          if (container) {
            container.addEventListener("click", (e) => {
              const card = e.target.closest(".viz-card[data-metric]");
              if (!card) return;
              const metricKey = card.dataset.metric;
              const label = metricLabelMap[metricKey];
              if (label) {
                openMetric(label);
              }
            });
            
            // æ‚¬åœæ•ˆæœ
            container.addEventListener("mouseover", (e) => {
              const card = e.target.closest(".viz-card[data-metric]");
              if (card) card.style.borderColor = "#60a5fa";
            });
            container.addEventListener("mouseout", (e) => {
              const card = e.target.closest(".viz-card[data-metric]");
              if (card) card.style.borderColor = "#334155";
            });
          }
        });

      })();
    </script>
    
    <!-- è¿åŠ¨æ—¥å†å’Œå¨±ä¹Tabæ¸²æŸ“ -->
    <script>
      // è¿åŠ¨æ—¥å†å±•å¼€/æ”¶èµ·
      let calendarExpanded = false;
      window.toggleExerciseCalendar = function() {
        calendarExpanded = !calendarExpanded;
        const calendar = document.getElementById("exercise-calendar-v1");
        const toggleIcon = document.getElementById("calendar-toggle-icon");
        const toggleBtn = document.getElementById("exercise-calendar-toggle");
        if (calendar) {
          calendar.style.display = calendarExpanded ? "block" : "none";
          if (toggleBtn) {
            toggleBtn.style.borderRadius = calendarExpanded ? "8px 8px 0 0" : "8px";
          }
        }
        if (toggleIcon) {
          toggleIcon.style.transform = calendarExpanded ? "rotate(180deg)" : "rotate(0deg)";
        }
      };
      
      // è¿åŠ¨è¯¦æƒ…å¼¹çª—
      window.showExerciseDetail = function(date, minutes, energy, type) {
        const popup = document.getElementById("exercise-detail-popup");
        const overlay = document.getElementById("exercise-detail-overlay");
        const dateEl = document.getElementById("exercise-detail-date");
        const contentEl = document.getElementById("exercise-detail-content");
        if (!popup || !overlay || !dateEl || !contentEl) return;
        
        const dateObj = new Date(date);
        const dayNames = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"];
        dateEl.textContent = `${dateObj.getMonth() + 1}æœˆ${dateObj.getDate()}æ—¥ ${dayNames[dateObj.getDay()]}`;
        
        if (minutes === 0 && energy === 0) {
          contentEl.innerHTML = '<div style="color: #64748b;">å½“æ—¥æ— è¿åŠ¨è®°å½•</div>';
        } else {
          const typeIcon = type === "è·‘æ­¥" ? "ğŸƒ" : type === "éª‘è¡Œ" ? "ğŸš´" : type === "åŠ›é‡" ? "ğŸ‹ï¸" : type === "æ¸¸æ³³" ? "ğŸŠ" : "âš½";
          contentEl.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <span style="font-size: 24px;">${typeIcon}</span>
              <span style="font-size: 16px; font-weight: 600; color: #f8fafc;">${type || "è¿åŠ¨"}</span>
            </div>
            <div>â±ï¸ è¿åŠ¨æ—¶é•¿ï¼š<span style="color: #22c55e; font-weight: 600;">${Math.round(minutes)} åˆ†é’Ÿ</span></div>
            <div>ğŸ”¥ æ¶ˆè€—çƒ­é‡ï¼š<span style="color: #fb923c; font-weight: 600;">${Math.round(energy)} kcal</span></div>
          `;
        }
        
        popup.style.display = "block";
        overlay.style.display = "block";
      };
      
      // å…³é—­è¿åŠ¨è¯¦æƒ…å¼¹çª—
      document.getElementById("exercise-detail-close")?.addEventListener("click", () => {
        document.getElementById("exercise-detail-popup").style.display = "none";
        document.getElementById("exercise-detail-overlay").style.display = "none";
      });
      document.getElementById("exercise-detail-overlay")?.addEventListener("click", () => {
        document.getElementById("exercise-detail-popup").style.display = "none";
        document.getElementById("exercise-detail-overlay").style.display = "none";
      });
      
      (() => {
        // è¿åŠ¨æ—¥å†æ¸²æŸ“ - æ”¯æŒå¤šè¿åŠ¨ç±»å‹
        let workoutsData = {}; // å­˜å‚¨æ¯å¤©çš„è¿åŠ¨ç±»å‹æ•°æ®
        
        const loadExerciseCalendar = async () => {
          try {
            // åŠ è½½è¿åŠ¨æ•°æ®
            const exerciseRes = await fetch("health/data/exercise_daily.csv", { cache: "no-store" });
            if (!exerciseRes.ok) return;
            const exerciseText = await exerciseRes.text();
            const exerciseRows = exerciseText.trim().split("\n").slice(1);
            const exerciseData = {};
            exerciseRows.forEach(row => {
              const [date, exercise_time] = row.split(",");
              if (date) exerciseData[date] = parseFloat(exercise_time) || 0;
            });
            
            // åŠ è½½èƒ½é‡æ•°æ®
            let energyData = {};
            try {
              const energyRes = await fetch("health/data/energy_daily.csv", { cache: "no-store" });
              if (energyRes.ok) {
                const energyText = await energyRes.text();
                const energyRows = energyText.trim().split("\n").slice(1);
                energyRows.forEach(row => {
                  const parts = row.split(",");
                  const date = parts[0];
                  const activeEnergy = parseFloat(parts[1]) || 0;
                  if (date) energyData[date] = activeEnergy;
                });
              }
            } catch (e) {
              console.warn("åŠ è½½èƒ½é‡æ•°æ®å¤±è´¥:", e);
            }
            
            // åŠ è½½è¿åŠ¨ç±»å‹æ•°æ®
            try {
              const workoutsRes = await fetch("health/data/workouts_daily.csv", { cache: "no-store" });
              if (workoutsRes.ok) {
                const workoutsText = await workoutsRes.text();
                const workoutsRows = workoutsText.trim().split("\n").slice(1);
                workoutsRows.forEach(row => {
                  const [date, workout_type, duration_min, energy_kcal] = row.split(",");
                  if (date) {
                    if (!workoutsData[date]) workoutsData[date] = [];
                    workoutsData[date].push({
                      type: workout_type,
                      duration: parseFloat(duration_min) || 0,
                      energy: parseFloat(energy_kcal) || 0
                    });
                  }
                });
                // æ¯å¤©æŒ‰æ—¶é•¿æ’åºï¼ˆæœ€é•¿çš„æ’å‰é¢ï¼‰
                Object.keys(workoutsData).forEach(date => {
                  workoutsData[date].sort((a, b) => b.duration - a.duration);
                });
              }
            } catch (e) {
              console.warn("åŠ è½½è¿åŠ¨ç±»å‹æ•°æ®å¤±è´¥:", e);
            }
            
            // åˆå¹¶æ•°æ®
            const allDates = new Set([...Object.keys(exerciseData), ...Object.keys(energyData)]);
            const data = Array.from(allDates).map(date => ({
              date,
              minutes: exerciseData[date] || 0,
              energy: energyData[date] || 0,
              workouts: workoutsData[date] || []
            })).sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // æ¸²æŸ“æ—¥å†
            renderCalendarV1(data);
          } catch (e) {
            console.error("åŠ è½½è¿åŠ¨æ—¥å†å¤±è´¥:", e);
          }
        };
        
        // æ ¹æ®çƒ­é‡æ¶ˆè€—è·å–é¢œè‰²ï¼ˆæŸ”å’Œçš„è“ç´«è‰²ç³»ï¼Œä¸ä¸»é¢˜æ›´æ­é…ï¼‰
        const getEnergyColor = (energy) => {
          if (energy === 0) return "#1e293b";
          if (energy < 200) return "#475569"; // æ·±ç°è“
          if (energy < 400) return "#6366f1"; // é›è“
          if (energy < 600) return "#8b5cf6"; // ç´«è‰²
          if (energy < 800) return "#a855f7"; // äº®ç´«
          return "#c084fc"; // æµ…ç´«
        };
        
        // è¿åŠ¨ç±»å‹æ˜ å°„åˆ°ä¸­æ–‡å’Œå›¾æ ‡
        const workoutTypeMap = {
          Running: { name: "è·‘æ­¥", icon: "ğŸƒ" },
          Cycling: { name: "éª‘è¡Œ", icon: "ğŸš´" },
          TraditionalStrengthTraining: { name: "åŠ›é‡", icon: "ğŸ‹ï¸" },
          Swimming: { name: "æ¸¸æ³³", icon: "ğŸŠ" },
          Stairs: { name: "çˆ¬æ¥¼", icon: "ğŸªœ" },
          Walking: { name: "æ­¥è¡Œ", icon: "ğŸš¶" },
          Hiking: { name: "å¾’æ­¥", icon: "ğŸ¥¾" },
          Yoga: { name: "ç‘œä¼½", icon: "ğŸ§˜" },
          Dance: { name: "èˆè¹ˆ", icon: "ğŸ’ƒ" },
          Elliptical: { name: "æ¤­åœ†æœº", icon: "ğŸ”„" },
          Rowing: { name: "åˆ’èˆ¹", icon: "ğŸš£" },
          StairClimbing: { name: "çˆ¬æ¥¼", icon: "ğŸªœ" },
        };
        
        // è·å–è¿åŠ¨å›¾æ ‡ï¼ˆæ”¯æŒå¤šè¿åŠ¨ï¼‰
        const getWorkoutIcons = (workouts) => {
          if (!workouts || workouts.length === 0) return "";
          // å–å‰2ä¸ªè¿åŠ¨ç±»å‹çš„å›¾æ ‡
          return workouts.slice(0, 2).map(w => {
            const info = workoutTypeMap[w.type] || { icon: "âš½" };
            return info.icon;
          }).join("");
        };
        
        // è·å–è¿åŠ¨ç±»å‹åç§°
        const getWorkoutTypeName = (type) => {
          const info = workoutTypeMap[type];
          return info ? info.name : type;
        };
        
        const getIntensityLabel = (minutes, energy) => {
          if (minutes === 0 && energy === 0) return "ä¼‘æ¯";
          if (energy < 200) return "ä½æ¶ˆè€—";
          if (energy < 400) return "ä¸­æ¶ˆè€—";
          if (energy < 600) return "è¾ƒé«˜æ¶ˆè€—";
          return "é«˜æ¶ˆè€—";
        };
        
        // æ˜¾ç¤ºè¿åŠ¨è¯¦æƒ…å¼¹çª—
        window.showExerciseDetailV2 = function(date, minutes, energy, workoutsJson) {
          const popup = document.getElementById("exercise-detail-popup");
          const overlay = document.getElementById("exercise-detail-overlay");
          const dateEl = document.getElementById("exercise-detail-date");
          const contentEl = document.getElementById("exercise-detail-content");
          if (!popup || !overlay || !dateEl || !contentEl) return;
          
          const workouts = JSON.parse(decodeURIComponent(workoutsJson));
          const dateObj = new Date(date);
          const weekDay = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"][dateObj.getDay()];
          dateEl.textContent = `${date} ${weekDay}`;
          
          let content = "";
          if (workouts && workouts.length > 0) {
            content = workouts.map(w => {
              const info = workoutTypeMap[w.type] || { name: w.type, icon: "âš½" };
              return `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 0; border-bottom: 1px solid #334155;">
                <span style="font-size: 16px;">${info.icon}</span>
                <span style="flex: 1; color: #e2e8f0;">${info.name}</span>
                <span style="color: #94a3b8;">${w.duration.toFixed(0)}åˆ†é’Ÿ</span>
              </div>`;
            }).join("");
            content += `<div style="margin-top: 12px; padding-top: 8px; border-top: 1px solid #475569; display: flex; justify-content: space-between;">
              <span style="color: #94a3b8;">æ€»è®¡</span>
              <span style="color: #c4b5fd; font-weight: 600;">${minutes.toFixed(0)}åˆ†é’Ÿ Â· ${energy.toFixed(0)}kcal</span>
            </div>`;
          } else if (minutes > 0) {
            content = `<div style="color: #94a3b8;">è¿åŠ¨æ—¶é•¿: ${minutes.toFixed(0)}åˆ†é’Ÿ</div>
              <div style="color: #94a3b8; margin-top: 4px;">æ¶ˆè€—èƒ½é‡: ${energy.toFixed(0)}kcal</div>`;
          } else {
            content = `<div style="color: #64748b; text-align: center; padding: 12px 0;">ä¼‘æ¯æ—¥</div>`;
          }
          
          contentEl.innerHTML = content;
          popup.style.display = "block";
          overlay.style.display = "block";
        };
        
        const renderCalendarV1 = (data) => {
          const grid = document.getElementById("cal-v1-grid");
          if (!grid) return;
          
          // å–æœ€è¿‘28å¤©
          const today = new Date();
          const days = [];
          for (let i = 27; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split("T")[0];
            const found = data.find(r => r.date === dateStr);
            days.push({
              date: dateStr,
              minutes: found ? found.minutes : 0,
              energy: found ? found.energy : 0,
              workouts: found ? found.workouts : [],
              dayOfWeek: d.getDay()
            });
          }
          
          // è·å–è¿åŠ¨ç±»å‹æ–‡å­—ï¼ˆå–å‰2ä¸ªï¼Œç”¨ç®€ç§°ï¼‰
          const getWorkoutText = (workouts) => {
            if (!workouts || workouts.length === 0) return "";
            const shortNames = {
              Running: "è·‘", Cycling: "éª‘", TraditionalStrengthTraining: "åŠ›", Swimming: "æ³³",
              Stairs: "æ¥¼", Walking: "èµ°", Hiking: "å¾’", Yoga: "ç‘œ", Dance: "èˆ",
              Elliptical: "æ¤­", Rowing: "åˆ’", StairClimbing: "æ¥¼"
            };
            return workouts.slice(0, 2).map(w => shortNames[w.type] || "åŠ¨").join("");
          };
          
          grid.innerHTML = days.map(d => {
            const color = getEnergyColor(d.energy);
            const text = getWorkoutText(d.workouts);
            const textColor = d.energy > 300 ? '#fff' : '#94a3b8';
            const workoutsJson = encodeURIComponent(JSON.stringify(d.workouts));
            return `<div onclick="showExerciseDetailV2('${d.date}', ${d.minutes}, ${d.energy}, '${workoutsJson}')" style="aspect-ratio: 1; background: ${color}; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 500; color: ${textColor}; border: 1px solid ${d.energy > 0 ? 'rgba(139, 92, 246, 0.3)' : '#334155'}; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">${text}</div>`;
          }).join("");
        };
        
        const renderCalendarV2 = (data) => {
          const weekRing = document.getElementById("cal-v2-week-ring");
          const weekCount = document.getElementById("cal-v2-week-count");
          const monthRing = document.getElementById("cal-v2-month-ring");
          const monthCount = document.getElementById("cal-v2-month-count");
          const daysContainer = document.getElementById("cal-v2-days");
          if (!weekRing || !monthRing || !daysContainer) return;
          
          const today = new Date();
          const THRESHOLD = 30;
          
          // è®¡ç®—æœ¬å‘¨è¿åŠ¨å¤©æ•°
          const weekDays = [];
          for (let i = 6; i >= 0; i--) {
            const d = new Date(today);
            d.setDate(d.getDate() - i);
            const dateStr = d.toISOString().split("T")[0];
            const found = data.find(r => r.date === dateStr);
            weekDays.push({
              date: dateStr,
              minutes: found ? found.minutes : 0,
              dayName: ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][d.getDay()]
            });
          }
          const weekExDays = weekDays.filter(d => d.minutes >= THRESHOLD).length;
          
          // è®¡ç®—æœ¬æœˆè¿åŠ¨å¤©æ•°
          const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
          let monthExDays = 0;
          for (const d of data) {
            const dDate = new Date(d.date);
            if (dDate >= monthStart && dDate <= today && d.minutes >= THRESHOLD) {
              monthExDays++;
            }
          }
          
          // æ›´æ–°ç¯å½¢è¿›åº¦
          const weekPct = Math.min(100, (weekExDays / 4) * 100);
          const monthPct = Math.min(100, (monthExDays / 16) * 100);
          weekRing.setAttribute("stroke-dasharray", `${weekPct}, 100`);
          monthRing.setAttribute("stroke-dasharray", `${monthPct}, 100`);
          weekCount.textContent = weekExDays;
          monthCount.textContent = monthExDays;
          
          // æ¸²æŸ“å‘¨è¯¦æƒ…
          daysContainer.innerHTML = weekDays.map(d => {
            const isActive = d.minutes >= THRESHOLD;
            const bg = isActive ? "#22c55e" : "#334155";
            const textColor = isActive ? "#fff" : "#94a3b8";
            return `<div style="text-align: center;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: ${bg}; display: flex; align-items: center; justify-content: center; margin-bottom: 4px;">
                <span style="font-size: 11px; color: ${textColor}; font-weight: 600;">${d.minutes >= THRESHOLD ? "âœ“" : ""}</span>
              </div>
              <div style="font-size: 10px; color: #64748b;">${d.dayName}</div>
            </div>`;
          }).join("");
        };
        
        const renderCalendarV3 = (data) => {
          const list = document.getElementById("cal-v3-list");
          if (!list) return;
          
          // å–æœ€è¿‘14å¤©æœ‰è¿åŠ¨çš„è®°å½•
          const recent = data.filter(d => d.minutes > 0).slice(-14).reverse();
          
          if (!recent.length) {
            list.innerHTML = '<div style="color: #64748b; font-size: 13px; padding: 8px;">æš‚æ— è¿åŠ¨è®°å½•</div>';
            return;
          }
          
          list.innerHTML = recent.map((d, idx) => {
            const intensity = getIntensityLabel(d.minutes);
            const color = d.minutes >= 60 ? "#4ade80" : d.minutes >= 30 ? "#22c55e" : "#166534";
            const dateObj = new Date(d.date);
            const dateLabel = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
            const dayName = ["å‘¨æ—¥", "å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­"][dateObj.getDay()];
            return `<div style="margin-bottom: 12px; position: relative;">
              <div style="position: absolute; left: -14px; top: 4px; width: 8px; height: 8px; background: ${color}; border-radius: 50%; box-shadow: 0 0 6px ${color};"></div>
              <div style="font-size: 10px; color: #64748b; margin-bottom: 2px;">${dateLabel} ${dayName}</div>
              <div style="background: rgba(34, 197, 94, 0.1); border-radius: 6px; padding: 8px 12px; border: 1px solid rgba(34, 197, 94, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <span style="font-size: 13px; color: #f8fafc;">${d.minutes.toFixed(0)} åˆ†é’Ÿ</span>
                  <span style="font-size: 11px; padding: 2px 8px; background: ${color}; color: #fff; border-radius: 10px;">${intensity}</span>
                </div>
              </div>
            </div>`;
          }).join("");
        };
        
        // å¨±ä¹Tabåˆ†ç±»æ ‡ç­¾äº‘æ¸²æŸ“ - ä»é…ç½®æ–‡ä»¶åŠ è½½åˆ†ç±»
        const renderEntertainmentTagCloud = async () => {
          const tagsContainer = document.getElementById("ent-tags");
          const videoList = document.getElementById("ent-video-list");
          if (!tagsContainer || !videoList) return;
          
          // ä½¿ç”¨å…¨å±€ records
          if (typeof records === "undefined" || !records.length) {
            setTimeout(renderEntertainmentTagCloud, 500);
            return;
          }
          
          // ä»é…ç½®æ–‡ä»¶åŠ è½½åˆ†ç±»é¡ºåº
          let categoryOrder = ["è¶…ä¼˜è´¨", "å†å²åŒº", "åˆ›æ„åŒº", "è¿åŠ¨åŒº", "æ¸¸æˆåŒº", "å½±è§†ç»¼", "æ•°åˆ†"];
          try {
            const configRes = await fetch("config/bilibili_authors.json", { cache: "no-store" });
            if (configRes.ok) {
              const config = await configRes.json();
              // è·å–é…ç½®æ–‡ä»¶ä¸­çš„æ‰€æœ‰åˆ†ç±»ï¼ˆæ’é™¤_è¯´æ˜å­—æ®µï¼‰
              categoryOrder = Object.keys(config).filter(key => !key.startsWith("_"));
            }
          } catch (e) {
            console.warn("åŠ è½½åˆ†ç±»é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é¡ºåº:", e);
          }
          
          // ç»Ÿè®¡å„åˆ†ç±»æ•°é‡
          const categoryCount = {};
          records.forEach(r => {
            const cat = r.category || "å…¶ä»–";
            categoryCount[cat] = (categoryCount[cat] || 0) + 1;
          });
          
          // æŒ‰é…ç½®æ–‡ä»¶é¡ºåºæ’åˆ—ï¼Œç¡®ä¿æ‰€æœ‰é…ç½®çš„åˆ†ç±»éƒ½æ˜¾ç¤ºï¼ˆå³ä½¿æ•°é‡ä¸º0ï¼‰
          const sortedCats = [];
          categoryOrder.forEach(cat => {
            sortedCats.push([cat, categoryCount[cat] || 0]);
          });
          // æ·»åŠ æœªåœ¨é…ç½®æ–‡ä»¶ä¸­çš„åˆ†ç±»
          Object.entries(categoryCount).forEach(([cat, count]) => {
            if (!categoryOrder.includes(cat)) {
              sortedCats.push([cat, count]);
            }
          });
          
          // é»˜è®¤é€‰ä¸­"è¶…ä¼˜è´¨"
          let activeTag = sortedCats.find(([cat]) => cat === "è¶…ä¼˜è´¨")?.[0] || sortedCats[0]?.[0] || "å…¨éƒ¨";
          
          const renderTags = () => {
            tagsContainer.innerHTML = sortedCats.map(([cat, count]) => {
              const isActive = cat === activeTag;
              const style = isActive 
                ? "padding: 6px 14px; background: #2563eb; border-radius: 16px; font-size: 13px; font-weight: 600; color: #fff; cursor: pointer; border: none;"
                : "padding: 6px 14px; background: transparent; border: 1px solid #475569; border-radius: 16px; font-size: 13px; color: #94a3b8; cursor: pointer;";
              return `<span data-cat="${cat}" style="${style}">${cat}<span style="margin-left: 4px; opacity: 0.7; font-size: 11px;">${count}</span></span>`;
            }).join("");
          };
          
          const renderVideos = () => {
            const limit = parseInt(document.getElementById("limit-input")?.value || "1", 10);
            const filtered = records.filter(r => (r.category || "å…¶ä»–") === activeTag);
            const authorCounts = new Map();
            const videos = [];
            
            filtered.forEach(r => {
              if (!r.author || !r.title) return;
              const used = authorCounts.get(r.author) || 0;
              if (used >= limit) return;
              authorCounts.set(r.author, used + 1);
              videos.push(r);
            });
            
            videos.sort((a, b) => (b._timestamp || 0) - (a._timestamp || 0));
            
            if (!videos.length) {
              videoList.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">æš‚æ— è§†é¢‘</div>';
              return;
            }
            
            videoList.innerHTML = videos.slice(0, 20).map((v, idx) => {
              const bg = idx % 2 === 0 ? "rgba(59, 130, 246, 0.08)" : "rgba(59, 130, 246, 0.03)";
              return `<a href="${v.url || "#"}" target="_blank" rel="noopener" style="display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: ${bg}; border-radius: 6px; text-decoration: none; transition: background 0.2s;">
                <div style="flex: 1; min-width: 0;">
                  <div style="font-size: 13px; color: #f8fafc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${v.title}</div>
                  <div style="font-size: 11px; color: #64748b; margin-top: 2px;">${v.author} Â· ${v.publish_date || ""}</div>
                </div>
              </a>`;
            }).join("");
          };
          
          renderTags();
          renderVideos();
          
          // ç‚¹å‡»åˆ‡æ¢æ ‡ç­¾
          tagsContainer.addEventListener("click", (e) => {
            const tag = e.target.closest("[data-cat]");
            if (!tag) return;
            activeTag = tag.dataset.cat;
            renderTags();
            renderVideos();
          });
          
          // ç›‘å¬ç­›é€‰å˜åŒ–
          const limitInput = document.getElementById("limit-input");
          if (limitInput) {
            limitInput.addEventListener("change", renderVideos);
          }
        };
        
        // åˆå§‹åŒ–
        loadExerciseCalendar();
        setTimeout(renderEntertainmentTagCloud, 800);
        
      })();
    </script>
  </body>
</html>
